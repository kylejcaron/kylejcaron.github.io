<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.41">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-07-09">

<title>Introduction to Surrogate Indexes – Kyle Caron</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7631f81a166a2979f555f02f21929a0e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-960e14589782da96e8191e666003f35f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-N3D0DYZCY4"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-N3D0DYZCY4', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../theme.scss">
<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Kyle Caron</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kylejcaron"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Introduction to Surrogate Indexes</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">experimentation</div>
                <div class="quarto-category">Causal Inference</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 9, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a></li>
  <li><a href="#the-surrogate-index-approach" id="toc-the-surrogate-index-approach" class="nav-link" data-scroll-target="#the-surrogate-index-approach">The Surrogate Index Approach</a></li>
  <li><a href="#showing-that-surrogate-index-works-with-simulated-data" id="toc-showing-that-surrogate-index-works-with-simulated-data" class="nav-link" data-scroll-target="#showing-that-surrogate-index-works-with-simulated-data">Showing that Surrogate Index works with Simulated Data</a>
  <ul class="collapse">
  <li><a href="#step-1-simulating-the-data" id="toc-step-1-simulating-the-data" class="nav-link" data-scroll-target="#step-1-simulating-the-data">Step 1: Simulating the data</a></li>
  <li><a href="#step-2-fitting-a-surrogate-model" id="toc-step-2-fitting-a-surrogate-model" class="nav-link" data-scroll-target="#step-2-fitting-a-surrogate-model">Step 2: Fitting a surrogate model</a></li>
  <li><a href="#step-3-estimate-long-term-treatment-effect" id="toc-step-3-estimate-long-term-treatment-effect" class="nav-link" data-scroll-target="#step-3-estimate-long-term-treatment-effect">Step 3: Estimate Long Term Treatment Effect</a></li>
  </ul></li>
  <li><a href="#whats-next" id="toc-whats-next" class="nav-link" data-scroll-target="#whats-next">What’s next?</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>How should you design your experiments if the metric you want to change might take months to observe?</p>
<p>Inspired by <a href="https://www.nber.org/system/files/working_papers/w26463/w26463.pdf">Susan Athey’s paper on Surrogate indexes</a> and another working paper, <a href="https://ide.mit.edu/wp-content/uploads/2020/12/Targeting-for-long-term-outcomes.pdf?x73880">Target for Long Term Outcomes</a>, I’ve wanted to share my learnings about surrogate indexes for a long time.</p>
<p>I’m hoping to cover the following in a series of blog posts:</p>
<ol type="1">
<li><p>The surrogate index estimator</p></li>
<li><p>Surrogate Index in practice</p>
<ul>
<li>Fitting a surrogate index on a realistic dataset</li>
<li>Validating the surrogate index over a set of historical experiments</li>
</ul></li>
<li><p>Targeting Long Term Outcomes</p>
<ul>
<li>Optimizing a policy</li>
<li>Attempting multi-armed bandits for early optimization</li>
</ul></li>
</ol>
<p>By simulating the data generating process from scratch, I hope this can also be a helpful tool for others to build on so they can answer their own questions they may have about estimating Long Term Treatment Effects.</p>
</section>
<section id="background" class="level1">
<h1>Background</h1>
<p><strong>Surrogate indexes</strong> are an unbiased way to predict a long term treatment effect from an experiment, but of course they’re only unbiased if done correctly which is no easy feat.</p>
<p>At Policygenius, customers would take a long time to convert to a sale, and we found that optimizing for middle of the funnel was too easy to game - often we’d have hugely successful experiments that improved the whole top half of the funnel but we wouldn’t see any improvement in our true-north metric 6 months later, conversion to sale. Surrogate indexes were a natural way to try and solve that problem. <a href="https://arxiv.org/pdf/2106.01421.pdf">LinkedIn also has a case study</a> on their need to optimize long term outcomes and how they’re using surrogate indexes which is worth a read.</p>
</section>
<section id="the-surrogate-index-approach" class="level1">
<h1>The Surrogate Index Approach</h1>
<p>Surrogate indexes are a way to use short term proxies to estimate long-term treatment effects. For instance, lets say you’re a subscription company and you want to see how some intervention improves retention. But churn takes a long time to observe, so your experiment could go on for months. <strong>TLDR;</strong> is that with this approach, instead of measuring churn as your <strong>overall evaluation criteria (OEC</strong>), you measure <code>predicted churn</code> (with some caveats) as the OEC.</p>
<p>A common response might be “thats complicated, can we try something more simple for now?” Of course you can. You can always try to choose some single short term proxy as your OEC for an experiment. But be careful because you could end up over-optimizing that proxy and not seeing the improvement in your long term outcome that you want. Surrogate indexes instead have many short term proxies, and they are validated over a set of historical data to ensure they’re an unbiased estimator of long term treatment effects.</p>
<p>How do they work? Let’s start with a DAG</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 134.00 188.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-184 130,-184 130,4 -4,4"></polygon>
<!-- X -->
<g id="node1" class="node">
<title>X</title>
<ellipse fill="none" stroke="black" cx="27" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-157.8" font-family="Times,serif" font-size="14.00">X</text>
</g>
<!-- S -->
<g id="node2" class="node">
<title>S</title>
<ellipse fill="none" stroke="black" cx="63" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="63" y="-85.8" font-family="Times,serif" font-size="14.00">S</text>
</g>
<!-- X&#45;&gt;S -->
<g id="edge1" class="edge">
<title>X-&gt;S</title>
<path fill="none" stroke="black" d="M35.35,-144.76C39.71,-136.28 45.15,-125.71 50.04,-116.2"></path>
<polygon fill="black" stroke="black" points="53.23,-117.64 54.7,-107.15 47.01,-114.44 53.23,-117.64"></polygon>
</g>
<!-- Y -->
<g id="node4" class="node">
<title>Y</title>
<ellipse fill="none" stroke="black" cx="63" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="63" y="-13.8" font-family="Times,serif" font-size="14.00">Y</text>
</g>
<!-- S&#45;&gt;Y -->
<g id="edge3" class="edge">
<title>S-&gt;Y</title>
<path fill="none" stroke="black" d="M63,-71.7C63,-63.98 63,-54.71 63,-46.11"></path>
<polygon fill="black" stroke="black" points="66.5,-46.1 63,-36.1 59.5,-46.1 66.5,-46.1"></polygon>
</g>
<!-- Tx -->
<g id="node3" class="node">
<title>Tx</title>
<ellipse fill="none" stroke="black" cx="99" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-157.8" font-family="Times,serif" font-size="14.00">Tx</text>
</g>
<!-- Tx&#45;&gt;S -->
<g id="edge2" class="edge">
<title>Tx-&gt;S</title>
<path fill="none" stroke="black" d="M90.65,-144.76C86.29,-136.28 80.85,-125.71 75.96,-116.2"></path>
<polygon fill="black" stroke="black" points="78.99,-114.44 71.3,-107.15 72.77,-117.64 78.99,-114.44"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>DAGs are diagrams, where the arrows represent causal effects. In this case, there’s some set of customer features <span class="math inline">\(X\)</span>, that influence some set of short term outcomes, <span class="math inline">\(S\)</span> (a surrogate index).</p>
<p>There’s also a treatment, <span class="math inline">\(\text{Tx}\)</span>, that influences <span class="math inline">\(S\)</span>. It may influence different short term outcomes in S in different ways.</p>
<p>Lastly there’s <span class="math inline">\(Y\)</span>, our long-term outcome of interest. Notice that all of the effect of the treatment on <span class="math inline">\(Y\)</span> flows through <span class="math inline">\(S\)</span>. This is saying that the entire causal effect of the treatment on <span class="math inline">\(Y\)</span> is explained by the effect of the treatment on <span class="math inline">\(S\)</span>. Keep note of that, because its a key assumption for Surrogate Indexes to work.</p>
<p>A more detailed way to show this is through the use of <a href="https://academic.oup.com/ije/article/50/2/613/5998421">IDAGs</a>, a newer way to represent DAGs with interactions</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 220.79 188.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<polygon fill="white" stroke="transparent" points="-4,4 -4,-184 216.79,-184 216.79,4 -4,4"></polygon>
<!-- x -->
<g id="node1" class="node">
<title>x</title>
<ellipse fill="none" stroke="black" cx="27" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-157.8" font-family="Times,serif" font-size="14.00">X</text>
</g>
<!-- s -->
<g id="node2" class="node">
<title>s</title>
<ellipse fill="none" stroke="black" cx="61" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="61" y="-85.8" font-family="Times,serif" font-size="14.00">S</text>
</g>
<!-- x&#45;&gt;s -->
<g id="edge1" class="edge">
<title>x-&gt;s</title>
<path fill="none" stroke="black" d="M34.89,-144.76C38.9,-136.49 43.89,-126.23 48.42,-116.9"></path>
<polygon fill="black" stroke="black" points="51.7,-118.16 52.92,-107.63 45.4,-115.1 51.7,-118.16"></polygon>
</g>
<!-- y -->
<g id="node3" class="node">
<title>y</title>
<ellipse fill="none" stroke="black" cx="61" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="61" y="-13.8" font-family="Times,serif" font-size="14.00">Y</text>
</g>
<!-- s&#45;&gt;y -->
<g id="edge3" class="edge">
<title>s-&gt;y</title>
<path fill="none" stroke="black" d="M61,-71.7C61,-63.98 61,-54.71 61,-46.11"></path>
<polygon fill="black" stroke="black" points="64.5,-46.1 61,-36.1 57.5,-46.1 64.5,-46.1"></polygon>
</g>
<!-- t -->
<g id="node4" class="node">
<title>t</title>
<ellipse fill="none" stroke="black" cx="99" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-157.8" font-family="Times,serif" font-size="14.00">Tx</text>
</g>
<!-- t&#45;&gt;s -->
<g id="edge2" class="edge">
<title>t-&gt;s</title>
<path fill="none" stroke="black" d="M90.19,-144.76C85.58,-136.28 79.84,-125.71 74.68,-116.2"></path>
<polygon fill="black" stroke="black" points="77.61,-114.27 69.77,-107.15 71.46,-117.61 77.61,-114.27"></polygon>
</g>
<!-- X -->
<g id="node5" class="node">
<title>X</title>
<ellipse fill="none" stroke="black" cx="176" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="176" y="-157.8" font-family="Times,serif" font-size="14.00">X</text>
</g>
<!-- ΔS_Tx -->
<g id="node6" class="node">
<title>ΔS_Tx</title>
<ellipse fill="none" stroke="black" cx="176" cy="-90" rx="36.58" ry="18"></ellipse>
<text text-anchor="middle" x="176" y="-85.8" font-family="Times,serif" font-size="14.00">ΔS_Tx</text>
</g>
<!-- X&#45;&gt;ΔS_Tx -->
<g id="edge4" class="edge">
<title>X-&gt;ΔS_Tx</title>
<path fill="none" stroke="black" d="M176,-143.7C176,-135.98 176,-126.71 176,-118.11"></path>
<polygon fill="black" stroke="black" points="179.5,-118.1 176,-108.1 172.5,-118.1 179.5,-118.1"></polygon>
</g>
<!-- Y -->
<g id="node7" class="node">
<title>Y</title>
<ellipse fill="none" stroke="black" cx="176" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="176" y="-13.8" font-family="Times,serif" font-size="14.00">Y</text>
</g>
<!-- ΔS_Tx&#45;&gt;Y -->
<g id="edge5" class="edge">
<title>ΔS_Tx-&gt;Y</title>
<path fill="none" stroke="black" d="M176,-71.7C176,-63.98 176,-54.71 176,-46.11"></path>
<polygon fill="black" stroke="black" points="179.5,-46.1 176,-36.1 172.5,-46.1 179.5,-46.1"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>The IDAG is shown on the right. The main difference is the new term, <span class="math inline">\(\Delta S_{\text{Tx}}\)</span> It implies that <span class="math inline">\(X\)</span> impacts the effect of the treatment on <span class="math inline">\(S\)</span>. More simply, the treatment will have different effects on <span class="math inline">\(S\)</span> for different people based on their background, <span class="math inline">\(X\)</span>, also known as <strong>heterogeneous treatment effects (HTEs)</strong>.</p>
<blockquote class="blockquote">
<p>Typically we average over HTEs to just get a single average treatment effect (ATE) for experiments, and that’s what we’ll be doing here. But there are ways to estimate HTEs as well, and we’ll get to that in part 3 of this series.</p>
</blockquote>
<p>This DAG can be used to build a surrogate index. If you can identify a set, <span class="math inline">\(S\)</span>, of shorter term proxies for <span class="math inline">\(Y\)</span>, and the effect of the treatment on <span class="math inline">\(Y\)</span> is entirely explained by <span class="math inline">\(S\)</span>, than you can use <span class="math inline">\(\hat{Y} = f(S, X, T) + \epsilon\)</span> as an unbiased estimator for <span class="math inline">\(Y\)</span> before <span class="math inline">\(Y\)</span> is actually observed. This also means that you can estimate the long term treatment effect by observing <span class="math inline">\(S\)</span> for each variant of an experiment and using it to predict <span class="math inline">\(\hat{Y}\)</span> for each group, then taking the difference: <span class="math display">\[
E[\delta_{\text{LTO}}] = E[\hat{Y} | T=1] - E[\hat{Y} | T=0]
\]</span></p>
<p>where <span class="math inline">\(\delta_{\text{LTO}}\)</span> is the treatment effect on the long term outcome.</p>
<p>Lets start simulating to see that for ourselves</p>
</section>
<section id="showing-that-surrogate-index-works-with-simulated-data" class="level1">
<h1>Showing that Surrogate Index works with Simulated Data</h1>
<section id="step-1-simulating-the-data" class="level2">
<h2 class="anchored" data-anchor-id="step-1-simulating-the-data">Step 1: Simulating the data</h2>
<p>We’ll start by simulating two datasets: A historical dataset and an experiment dataset. The advantage to simulating data is that we know the exact effects, so when we try and estimate them we can confirm our methods are recovering the true effect.</p>
<div id="5dfbb100" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> simple_simulation <span class="im">import</span> set_true_parameters, transmitter</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>SEED <span class="op">=</span> <span class="dv">99</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># step 1: simulate data</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(seed<span class="op">=</span>SEED)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>logit_link<span class="op">=</span><span class="va">True</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># True parameters</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>Zdims <span class="op">=</span> <span class="dv">20</span> <span class="co"># customer latent dims</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>Xdims <span class="op">=</span> <span class="dv">5</span> <span class="co"># pre treatment covariates</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>Sdims <span class="op">=</span> <span class="dv">8</span> <span class="co"># intermediate outcomes (the surrogates)</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>n_users <span class="op">=</span> <span class="dv">50000</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>GROUND_TRUTH <span class="op">=</span> set_true_parameters(Zdims, Xdims, Sdims, logit_link<span class="op">=</span><span class="va">True</span>, rng<span class="op">=</span>rng)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate data </span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>historical_data <span class="op">=</span> transmitter(GROUND_TRUTH, add_treatment<span class="op">=</span><span class="va">False</span>, n_users<span class="op">=</span>n_users,logit_link<span class="op">=</span>logit_link, rng<span class="op">=</span>rng) </span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>experiment_data <span class="op">=</span> transmitter(GROUND_TRUTH, add_treatment<span class="op">=</span><span class="va">True</span>, n_users<span class="op">=</span>n_users, logit_link<span class="op">=</span>logit_link, rng<span class="op">=</span>rng)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Censor the experiment dataset so that we dont know the long term outcome yet</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>Y_TRUE <span class="op">=</span> experiment_data.Y.values</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>experiment_data <span class="op">=</span> experiment_data.assign(Y<span class="op">=</span>np.NaN)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the historical dataset </span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>display(historical_data.head(<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>WARNING (pytensor.tensor.blas): Using NumPy C-API based implementation for BLAS functions.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">X0</th>
<th data-quarto-table-cell-role="th">X1</th>
<th data-quarto-table-cell-role="th">X2</th>
<th data-quarto-table-cell-role="th">X3</th>
<th data-quarto-table-cell-role="th">X4</th>
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">S0</th>
<th data-quarto-table-cell-role="th">S1</th>
<th data-quarto-table-cell-role="th">S2</th>
<th data-quarto-table-cell-role="th">S3</th>
<th data-quarto-table-cell-role="th">S4</th>
<th data-quarto-table-cell-role="th">S5</th>
<th data-quarto-table-cell-role="th">S6</th>
<th data-quarto-table-cell-role="th">S7</th>
<th data-quarto-table-cell-role="th">Y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>-0.096380</td>
<td>0.840839</td>
<td>-1.053685</td>
<td>-0.161607</td>
<td>-1.464074</td>
<td>0.0</td>
<td>1.140716</td>
<td>0.460239</td>
<td>-0.243707</td>
<td>0.478655</td>
<td>0.722508</td>
<td>0.119872</td>
<td>-0.491021</td>
<td>0.657103</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.750790</td>
<td>-0.723678</td>
<td>1.339998</td>
<td>-0.109216</td>
<td>-0.886968</td>
<td>0.0</td>
<td>0.173273</td>
<td>-0.100168</td>
<td>0.150519</td>
<td>-0.828812</td>
<td>0.288891</td>
<td>-0.454165</td>
<td>0.356069</td>
<td>-1.335292</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1.135441</td>
<td>-1.586930</td>
<td>1.226992</td>
<td>1.028425</td>
<td>-0.628964</td>
<td>0.0</td>
<td>-0.136527</td>
<td>-0.151602</td>
<td>0.555157</td>
<td>-1.382398</td>
<td>-0.071426</td>
<td>-0.453651</td>
<td>0.506445</td>
<td>-1.059432</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.470862</td>
<td>-0.472840</td>
<td>0.295874</td>
<td>1.280656</td>
<td>-0.370790</td>
<td>0.0</td>
<td>0.172303</td>
<td>0.171164</td>
<td>0.069458</td>
<td>-0.738659</td>
<td>0.113751</td>
<td>-0.089416</td>
<td>0.115741</td>
<td>0.073674</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.299083</td>
<td>-0.566013</td>
<td>0.851715</td>
<td>0.816545</td>
<td>-0.128058</td>
<td>0.0</td>
<td>-0.072062</td>
<td>0.078149</td>
<td>0.067890</td>
<td>-0.761437</td>
<td>0.052046</td>
<td>-0.173179</td>
<td>0.309554</td>
<td>-0.506578</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The underlying simulation code is below if you’re interested</p>
<div id="681933e5" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transmitter(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    params: Dict,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    add_treatment: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    n_users: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    logit_link: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> <span class="va">None</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Simulates outcomes based on some ground truth parameters. </span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">        params: The ground truth parameters (effects and biases) to simulate based off of</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">        add_treatment: adds a randomly allocated treatment when true, with effect `bTS`</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">        n_users: The number of users to simulate</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co">        logit_link: whether the data generating process is a bernoulli outcome or not</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co">        rng: A numpy random generator </span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">        A pandas dataframe with simulated data, including pre-treatment covariates,</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co">         surrogate outcomes, a treatment indicator, and a long term outcome, Y</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rng <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> np.random.choice(<span class="bu">range</span>(<span class="dv">1000</span>))</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        rng <span class="op">=</span> np.random.default_rng(seed<span class="op">=</span>seed)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># unpack params</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    Zdims, Xdims, Sdims <span class="op">=</span>  params[<span class="st">'bZX'</span>].shape[<span class="dv">1</span>],  params[<span class="st">'bZX'</span>].shape[<span class="dv">0</span>],  params[<span class="st">'bXS'</span>].shape[<span class="dv">0</span>]</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    alphaX,alphaS,alphaY  <span class="op">=</span> params[<span class="st">'alphaX'</span>], params[<span class="st">'alphaS'</span>], params[<span class="st">'alphaY'</span>] <span class="co"># bias terms</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    bZX,bXS,bSY <span class="op">=</span> params[<span class="st">'bZX'</span>], params[<span class="st">'bXS'</span>],params[<span class="st">'bSY'</span>] <span class="co"># causal relationships</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    bTS,bXTS <span class="op">=</span> params[<span class="st">'bTS'</span>], params[<span class="st">'bXTS'</span>] <span class="co"># tx effects</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># unobserved variable Z representing latent customer traits</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    Z <span class="op">=</span> rng.normal(<span class="dv">0</span>,<span class="dv">1</span>, size<span class="op">=</span>(Zdims, n_users))</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Some observed pre-TX measures</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> alphaX[:,<span class="va">None</span>] <span class="op">+</span> (bZX <span class="op">@</span> Z)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Intermediate outcomes</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> alphaS[:,<span class="va">None</span>] <span class="op">+</span> (bXS <span class="op">@</span> X) </span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add in treatment effect if applicable</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> rng.binomial(<span class="dv">1</span>,<span class="fl">0.5</span>,size<span class="op">=</span>n_users) <span class="cf">if</span> add_treatment <span class="cf">else</span> np.zeros(n_users)        </span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    avg_tx_term <span class="op">=</span> (bTS <span class="op">*</span> T[:,<span class="va">None</span>])        </span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    hetergeneous_tx_term <span class="op">=</span> (bXTS <span class="op">@</span> (X<span class="op">*</span>T))</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    S <span class="op">+=</span> avg_tx_term.T <span class="op">+</span> hetergeneous_tx_term</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># expectation of long term outcome</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    eta <span class="op">=</span> <span class="dv">0</span> <span class="op">+</span> (bSY <span class="op">@</span> S)</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Long term outcome</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> logit_link:</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>        Y <span class="op">=</span> rng.binomial(<span class="dv">1</span>, sp.expit(eta) )</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        Y <span class="op">=</span> rng.normal(eta, <span class="fl">0.025</span>)</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Output as dataframe</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    Xdf <span class="op">=</span> pd.DataFrame(X.T, columns<span class="op">=</span>[<span class="ss">f'X</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(Xdims)]).assign(T<span class="op">=</span>T)</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    Sdf <span class="op">=</span> pd.DataFrame(S.T, columns<span class="op">=</span>[<span class="ss">f'S</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(Sdims)])</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    Ydf <span class="op">=</span> pd.DataFrame(Y.ravel(), columns<span class="op">=</span>[<span class="st">'Y'</span>])</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.concat((Xdf, Sdf, Ydf),axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-2-fitting-a-surrogate-model" class="level2">
<h2 class="anchored" data-anchor-id="step-2-fitting-a-surrogate-model">Step 2: Fitting a surrogate model</h2>
<p>We’ll use the historical dataset to fit the surrogate index model, mapping <span class="math inline">\(S \rightarrow Y\)</span></p>
<div id="06992c1f" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>S_vars <span class="op">=</span> <span class="st">" + "</span>.join( historical_data.<span class="bu">filter</span>(like<span class="op">=</span><span class="st">"S"</span>).columns )</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>X_vars <span class="op">=</span> <span class="st">" + "</span>.join( historical_data.<span class="bu">filter</span>(like<span class="op">=</span><span class="st">"X"</span>).columns )</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: fit a surrogate index model on complete historical data</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>surrogate_model <span class="op">=</span> sm.OLS.from_formula(<span class="ss">f"Y ~ </span><span class="sc">{</span>S_vars<span class="sc">}</span><span class="ss">"</span>, data<span class="op">=</span>historical_data).fit()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate the variance in the estimator, \hat{sigma^2}. This is used for bias corrections later</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>predicted_sigma2 <span class="op">=</span> np.var( surrogate_model.fittedvalues <span class="op">-</span> historical_data.Y,  ddof<span class="op">=</span><span class="dv">1</span> )</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the model summary</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>surrogate_model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<table class="simpletable caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>OLS Regression Results</caption>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Dep. Variable:</td>
<td>Y</td>
<td data-quarto-table-cell-role="th">R-squared:</td>
<td>0.112</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Model:</td>
<td>OLS</td>
<td data-quarto-table-cell-role="th">Adj. R-squared:</td>
<td>0.112</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Method:</td>
<td>Least Squares</td>
<td data-quarto-table-cell-role="th">F-statistic:</td>
<td>1261.</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Date:</td>
<td>Tue, 25 Feb 2025</td>
<td data-quarto-table-cell-role="th">Prob (F-statistic):</td>
<td>0.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Time:</td>
<td>14:20:43</td>
<td data-quarto-table-cell-role="th">Log-Likelihood:</td>
<td>-33320.</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">No. Observations:</td>
<td>50000</td>
<td data-quarto-table-cell-role="th">AIC:</td>
<td>6.665e+04</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Df Residuals:</td>
<td>49994</td>
<td data-quarto-table-cell-role="th">BIC:</td>
<td>6.670e+04</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Df Model:</td>
<td>5</td>
<td data-quarto-table-cell-role="th"></td>
<td></td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Covariance Type:</td>
<td>nonrobust</td>
<td data-quarto-table-cell-role="th"></td>
<td></td>
</tr>
</tbody>
</table>


<table class="simpletable caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td></td>
<td data-quarto-table-cell-role="th">coef</td>
<td data-quarto-table-cell-role="th">std err</td>
<td data-quarto-table-cell-role="th">t</td>
<td data-quarto-table-cell-role="th">P&gt;|t|</td>
<td data-quarto-table-cell-role="th">[0.025</td>
<td data-quarto-table-cell-role="th">0.975]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Intercept</td>
<td>0.4994</td>
<td>0.002</td>
<td>236.981</td>
<td>0.000</td>
<td>0.495</td>
<td>0.504</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">S0</td>
<td>0.0382</td>
<td>0.004</td>
<td>10.857</td>
<td>0.000</td>
<td>0.031</td>
<td>0.045</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">S1</td>
<td>0.1023</td>
<td>0.005</td>
<td>21.446</td>
<td>0.000</td>
<td>0.093</td>
<td>0.112</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">S2</td>
<td>-0.0420</td>
<td>0.005</td>
<td>-8.853</td>
<td>0.000</td>
<td>-0.051</td>
<td>-0.033</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">S3</td>
<td>0.1861</td>
<td>0.004</td>
<td>50.774</td>
<td>0.000</td>
<td>0.179</td>
<td>0.193</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">S4</td>
<td>0.0501</td>
<td>0.002</td>
<td>30.302</td>
<td>0.000</td>
<td>0.047</td>
<td>0.053</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">S5</td>
<td>0.0666</td>
<td>0.002</td>
<td>28.930</td>
<td>0.000</td>
<td>0.062</td>
<td>0.071</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">S6</td>
<td>-0.0072</td>
<td>0.002</td>
<td>-2.978</td>
<td>0.003</td>
<td>-0.012</td>
<td>-0.002</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">S7</td>
<td>0.0037</td>
<td>0.003</td>
<td>1.348</td>
<td>0.178</td>
<td>-0.002</td>
<td>0.009</td>
</tr>
</tbody>
</table>


<table class="simpletable caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Omnibus:</td>
<td>255849.096</td>
<td data-quarto-table-cell-role="th">Durbin-Watson:</td>
<td>1.998</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Prob(Omnibus):</td>
<td>0.000</td>
<td data-quarto-table-cell-role="th">Jarque-Bera (JB):</td>
<td>5169.412</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Skew:</td>
<td>-0.002</td>
<td data-quarto-table-cell-role="th">Prob(JB):</td>
<td>0.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Kurtosis:</td>
<td>1.425</td>
<td data-quarto-table-cell-role="th">Cond. No.</td>
<td>3.91e+15</td>
</tr>
</tbody>
</table>
<br><br>Notes:<br>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.<br>[2] The smallest eigenvalue is 6.03e-27. This might indicate that there are<br>strong multicollinearity problems or that the design matrix is singular.
</div>
</div>
<p>There are 3 important things to note here:</p>
<ol type="1">
<li>Note that we’re purposely not including the pre-treatment covariates, <span class="math inline">\(X\)</span> in this model. Remember the DAG - all of the effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> is entirely mediated by <span class="math inline">\(S\)</span>, so adding <span class="math inline">\(X\)</span> into the model adds no additional information.</li>
<li>We’re using Ordinary Least Squares for bernoulli outcome data. Thats not a mistake. OLS has great properties to be effective on bernoulli outcome data, and it makes this approach very simple. Other models can also be swapped in, like Random Forest or XGBoost.</li>
<li>I’m not doing alot of model validation, just because this is simulated data. In practice, don’t just throw things into a model. Part 2 in this series will discuss how to validate surrogate indexes.</li>
</ol>
</section>
<section id="step-3-estimate-long-term-treatment-effect" class="level2">
<h2 class="anchored" data-anchor-id="step-3-estimate-long-term-treatment-effect">Step 3: Estimate Long Term Treatment Effect</h2>
<p>We’ll now use the surrogate index to estimate a long term treatment effect</p>
<p>Let’s take our experiment dataset and estimate <span class="math inline">\(E[\delta_{\text{LTO}}]\)</span>, the average treatment effect on the long term outcome. Notice, the long term outcome, <span class="math inline">\(Y\)</span>, hasn’t been observed yet.</p>
<div id="992aa0d5" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>display(experiment_data.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">X0</th>
<th data-quarto-table-cell-role="th">X1</th>
<th data-quarto-table-cell-role="th">X2</th>
<th data-quarto-table-cell-role="th">X3</th>
<th data-quarto-table-cell-role="th">X4</th>
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">S0</th>
<th data-quarto-table-cell-role="th">S1</th>
<th data-quarto-table-cell-role="th">S2</th>
<th data-quarto-table-cell-role="th">S3</th>
<th data-quarto-table-cell-role="th">S4</th>
<th data-quarto-table-cell-role="th">S5</th>
<th data-quarto-table-cell-role="th">S6</th>
<th data-quarto-table-cell-role="th">S7</th>
<th data-quarto-table-cell-role="th">Y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.849129</td>
<td>0.941827</td>
<td>0.683911</td>
<td>1.435666</td>
<td>1.001435</td>
<td>1</td>
<td>-0.559842</td>
<td>-0.575105</td>
<td>-0.884129</td>
<td>-0.543576</td>
<td>-0.289843</td>
<td>0.816105</td>
<td>-0.516732</td>
<td>0.887577</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>-0.053981</td>
<td>0.716863</td>
<td>0.718290</td>
<td>1.600732</td>
<td>0.390534</td>
<td>1</td>
<td>-0.271181</td>
<td>0.001847</td>
<td>-0.690713</td>
<td>-0.609596</td>
<td>0.001895</td>
<td>0.902771</td>
<td>-0.263201</td>
<td>0.456430</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.852506</td>
<td>1.276305</td>
<td>-1.803119</td>
<td>-0.418187</td>
<td>-0.009625</td>
<td>1</td>
<td>0.021439</td>
<td>-0.752464</td>
<td>-0.340972</td>
<td>0.909959</td>
<td>-0.323996</td>
<td>1.041753</td>
<td>-1.256339</td>
<td>1.851033</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>-0.650541</td>
<td>0.908525</td>
<td>1.985210</td>
<td>1.231077</td>
<td>0.265338</td>
<td>1</td>
<td>-0.226897</td>
<td>0.259183</td>
<td>-0.987532</td>
<td>-0.835104</td>
<td>0.359953</td>
<td>0.767602</td>
<td>0.108398</td>
<td>-0.659191</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>-0.473196</td>
<td>-0.007258</td>
<td>0.054155</td>
<td>-0.368575</td>
<td>0.331867</td>
<td>0</td>
<td>-0.229447</td>
<td>0.020273</td>
<td>0.058779</td>
<td>0.200721</td>
<td>-0.121112</td>
<td>0.062693</td>
<td>0.113565</td>
<td>-0.206135</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>First, we’ll do some visulation of the experiment data.</p>
<div id="f71dd4ce" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>,<span class="bu">int</span>(Xdims<span class="op">/</span><span class="dv">2</span>),figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">5</span>),sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ax <span class="kw">in</span> <span class="bu">zip</span>(<span class="bu">range</span>(Xdims), axes.ravel()):</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    sns.histplot( experiment_data.loc[<span class="kw">lambda</span> d: d[<span class="st">'T'</span>]<span class="op">==</span><span class="dv">0</span>][<span class="ss">f"X</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>],ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">'Control'</span> )</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    sns.histplot( experiment_data.loc[<span class="kw">lambda</span> d: d[<span class="st">'T'</span>]<span class="op">==</span><span class="dv">1</span>][<span class="ss">f"X</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>],ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">'Treatment'</span> )</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Histogram of Pre-Treatment Covariates</span><span class="ch">\n</span><span class="st">for the Treatment and Control groups"</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2023-07-09-surrogate_index_intro_files/figure-html/cell-6-output-1.png" width="662" height="475" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As we can see above, the pre-treatment variables are the exact same between the experiment groups. Thats because users are randomly allocated into treatment and control groups, and their pre-treatment varibles by definition are things not imapcted by the experiment.</p>
<p>Conversely, if we look at the surrogate outcomes below, we’ll see some differences in surrogate outcomes between the treatment and control groups.</p>
<div id="ed991dc2" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>,<span class="bu">int</span>(Sdims<span class="op">/</span><span class="dv">2</span>),figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">5</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ax <span class="kw">in</span> <span class="bu">zip</span>(<span class="bu">range</span>(Sdims), axes.ravel()):</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    sns.histplot( experiment_data.loc[<span class="kw">lambda</span> d: d[<span class="st">'T'</span>]<span class="op">==</span><span class="dv">0</span>][<span class="ss">f"S</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>],ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">'Control'</span> )</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    sns.histplot( experiment_data.loc[<span class="kw">lambda</span> d: d[<span class="st">'T'</span>]<span class="op">==</span><span class="dv">1</span>][<span class="ss">f"S</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>],ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">'Treatment'</span> )</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Histogram of Surrogate Outcomes</span><span class="ch">\n</span><span class="st">for the Treatment and Control groups"</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2023-07-09-surrogate_index_intro_files/figure-html/cell-7-output-1.png" width="658" height="475" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>If our surrogate index estimator is correct, these observed surrogate outcomes should directly map to the Long Term Outcome deterministically, via <span class="math inline">\(\hat{Y} = f(S)\)</span>, where <span class="math inline">\(f()\)</span> is the surrogate index model.</p>
<p>We can show that the surrogate index estimator recovers the true average treatment effect on the long term outcome</p>
<div id="4851e74f" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_delta_LTO(experiment_data, surrogate_model, predicted_sigma2):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Accepts experiment data with a binary treatment, a surrogate model, and the predicted sigma^2 of the surrogate model.</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns the ATE estimate and its uncertainty</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    Y_T1 <span class="op">=</span> surrogate_model.predict(experiment_data.loc[<span class="kw">lambda</span> d: d[<span class="st">'T'</span>]<span class="op">==</span><span class="dv">1</span>])</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    Y_T0 <span class="op">=</span> surrogate_model.predict(experiment_data.loc[<span class="kw">lambda</span> d: d[<span class="st">'T'</span>]<span class="op">==</span><span class="dv">0</span>])</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the ATE</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    ATE <span class="op">=</span>  Y_T1.mean() <span class="op">-</span> Y_T0.mean()</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate the variance </span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    var_surrogate <span class="op">=</span> np.var(Y_T1,ddof<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span> <span class="bu">len</span>(Y_T1) <span class="op">+</span> np.var(Y_T0,ddof<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span> <span class="bu">len</span>(Y_T0)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust the variance by the surrogate model error</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    var_surrogate_adj <span class="op">=</span> var_surrogate <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>predicted_sigma2<span class="op">/</span><span class="bu">len</span>(Y_T1)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    ATE_sd <span class="op">=</span> np.sqrt(var_surrogate_adj)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ATE, ATE_sd</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>ATE, ATE_sd <span class="op">=</span> estimate_delta_LTO(experiment_data, surrogate_model, predicted_sigma2)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>sns.histplot(np.random.normal(ATE, ATE_sd, size<span class="op">=</span><span class="dv">10000</span>), stat<span class="op">=</span><span class="st">'probability'</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>plt.axvline( GROUND_TRUTH[<span class="st">'ATE'</span>], color<span class="op">=</span><span class="st">'r'</span>, ls<span class="op">=</span><span class="st">'--'</span>, label<span class="op">=</span><span class="st">'True ATE'</span>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"ATE"</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Estimated Treatment Effect vs. True Treatment Effect"</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2023-07-09-surrogate_index_intro_files/figure-html/cell-8-output-1.png" width="620" height="449" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>There we are. The surrogate estimator recovers the true average treatment effect! We didn’t even have to wait and observe the true long term outcome.</p>
<p>If you’re interested, try simulating this repeatedly to confirm it regularly recovers the true ATE with different random seeds. Even better, try setting the treatment effect to zero and see how often there are false positives.</p>
</section>
</section>
<section id="whats-next" class="level1">
<h1>What’s next?</h1>
<p>Hopefully this post convinced you that the surrogate index approach can help assess long term outcomes in experiments faster.</p>
<p>While its easier to show this approach works, it’s harder to pull it off in practice. The next post will focus on how to validate a surrogate index estimator on more realistic data that you might see in industry.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/kylejcaron\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>