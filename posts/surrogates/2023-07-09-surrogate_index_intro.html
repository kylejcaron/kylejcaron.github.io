<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.163">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-07-09">

<title>Kyle Caron - Introduction to Surrogate Indexes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../theme.scss">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Kyle Caron</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html">Blog</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kylejcaron"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Introduction to Surrogate Indexes</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">experimentation</div>
                <div class="quarto-category">Causal Inference</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 9, 2023</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a></li>
  <li><a href="#the-surrogate-index-approach" id="toc-the-surrogate-index-approach" class="nav-link" data-scroll-target="#the-surrogate-index-approach">The Surrogate Index Approach</a></li>
  <li><a href="#showing-that-surrogate-index-works-with-simulated-data" id="toc-showing-that-surrogate-index-works-with-simulated-data" class="nav-link" data-scroll-target="#showing-that-surrogate-index-works-with-simulated-data">Showing that Surrogate Index works with Simulated Data</a>
  <ul class="collapse">
  <li><a href="#step-1-simulating-the-data" id="toc-step-1-simulating-the-data" class="nav-link" data-scroll-target="#step-1-simulating-the-data">Step 1: Simulating the data</a></li>
  <li><a href="#step-2-fitting-a-surrogate-model" id="toc-step-2-fitting-a-surrogate-model" class="nav-link" data-scroll-target="#step-2-fitting-a-surrogate-model">Step 2: Fitting a surrogate model</a></li>
  <li><a href="#step-3-estimate-long-term-treatment-effect" id="toc-step-3-estimate-long-term-treatment-effect" class="nav-link" data-scroll-target="#step-3-estimate-long-term-treatment-effect">Step 3: Estimate Long Term Treatment Effect</a></li>
  </ul></li>
  <li><a href="#whats-next" id="toc-whats-next" class="nav-link" data-scroll-target="#whats-next">What’s next?</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>How should you design your experiments if the metric you want to change might take months to observe?</p>
<p>Inspired by <a href="https://www.nber.org/system/files/working_papers/w26463/w26463.pdf">Susan Athey’s paper on Surrogate indexes</a> and another working paper, <a href="https://ide.mit.edu/wp-content/uploads/2020/12/Targeting-for-long-term-outcomes.pdf?x73880">Target for Long Term Outcomes</a>, I’ve wanted to share my learnings about surrogate indexes for a long time.</p>
<p>I’m hoping to cover the following in a series of blog posts:</p>
<ol type="1">
<li><p>The surrogate index estimator</p></li>
<li><p>Surrogate Index in practice</p>
<ul>
<li>Fitting a surrogate index on a realistic dataset</li>
<li>Validating the surrogate index over a set of historical experiments</li>
</ul></li>
<li><p>Targeting Long Term Outcomes</p>
<ul>
<li>Optimizing a policy</li>
<li>Attempting multi-armed bandits for early optimization</li>
</ul></li>
</ol>
<p>By simulating the data generating process from scratch, I hope this can also be a helpful tool for others to build on so they can answer their own questions they may have about estimating Long Term Treatment Effects.</p>
</section>
<section id="background" class="level1">
<h1>Background</h1>
<p><strong>Surrogate indexes</strong> are an unbiased way to predict a long term treatment effect from an experiment, but of course they’re only unbiased if done correctly which is no easy feat.</p>
<p>At Policygenius, customers would take a long time to convert to a sale, and we found that optimizing for middle of the funnel was too easy to game - often we’d have hugely successful experiments that improved the whole top half of the funnel but we wouldn’t see any improvement in our true-north metric 6 months later, conversion to sale. Surrogate indexes were a natural way to try and solve that problem. <a href="https://arxiv.org/pdf/2106.01421.pdf">LinkedIn also has a case study</a> on their need to optimize long term outcomes and how they’re using surrogate indexes which is worth a read.</p>
</section>
<section id="the-surrogate-index-approach" class="level1">
<h1>The Surrogate Index Approach</h1>
<p>Surrogate indexes are a way to use short term proxies to estimate long-term treatment effects. For instance, lets say you’re a subscription company and you want to see how some intervention improves retention. But churn takes a long time to observe, so your experiment could go on for months. <strong>TLDR;</strong> is that with this approach, instead of measuring churn as your <strong>overall evaluation criteria (OEC</strong>), you measure <code>predicted churn</code> (with some caveats) as the OEC.</p>
<p>A common response might be “thats complicated, can we try something more simple for now?” Of course you can. You can always try to choose some single short term proxy as your OEC for an experiment. But be careful because you could end up over-optimizing that proxy and not seeing the improvement in your long term outcome that you want. Surrogate indexes instead have many short term proxies, and they are validated over a set of historical data to ensure they’re an unbiased estimator of long term treatment effects.</p>
<p>How do they work? Let’s start with a DAG</p>
<div class="cell">
<div class="cell-output-display">
<div>
<p>
<svg width="672" height="480" viewbox="0.00 0.00 134.00 188.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<title>
G
</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-184 130,-184 130,4 -4,4"></polygon> <!-- X --> <g id="node1" class="node">
<title>
X
</title>
<ellipse fill="none" stroke="black" cx="27" cy="-162" rx="27" ry="18"></ellipse> <text text-anchor="middle" x="27" y="-157.8" font-family="Times,serif" font-size="14.00">X</text> </g> <!-- S --> <g id="node2" class="node">
<title>
S
</title>
<ellipse fill="none" stroke="black" cx="63" cy="-90" rx="27" ry="18"></ellipse> <text text-anchor="middle" x="63" y="-85.8" font-family="Times,serif" font-size="14.00">S</text> </g> <!-- X&#45;&gt;S --> <g id="edge1" class="edge">
<title>
X-&gt;S
</title>
<path fill="none" stroke="black" d="M35.35,-144.76C39.71,-136.28 45.15,-125.71 50.04,-116.2"></path> <polygon fill="black" stroke="black" points="53.23,-117.64 54.7,-107.15 47.01,-114.44 53.23,-117.64"></polygon> </g> <!-- Y --> <g id="node4" class="node">
<title>
Y
</title>
<ellipse fill="none" stroke="black" cx="63" cy="-18" rx="27" ry="18"></ellipse> <text text-anchor="middle" x="63" y="-13.8" font-family="Times,serif" font-size="14.00">Y</text> </g> <!-- S&#45;&gt;Y --> <g id="edge3" class="edge">
<title>
S-&gt;Y
</title>
<path fill="none" stroke="black" d="M63,-71.7C63,-63.98 63,-54.71 63,-46.11"></path> <polygon fill="black" stroke="black" points="66.5,-46.1 63,-36.1 59.5,-46.1 66.5,-46.1"></polygon> </g> <!-- Tx --> <g id="node3" class="node">
<title>
Tx
</title>
<ellipse fill="none" stroke="black" cx="99" cy="-162" rx="27" ry="18"></ellipse> <text text-anchor="middle" x="99" y="-157.8" font-family="Times,serif" font-size="14.00">Tx</text> </g> <!-- Tx&#45;&gt;S --> <g id="edge2" class="edge">
<title>
Tx-&gt;S
</title>
<path fill="none" stroke="black" d="M90.65,-144.76C86.29,-136.28 80.85,-125.71 75.96,-116.2"></path> <polygon fill="black" stroke="black" points="78.99,-114.44 71.3,-107.15 72.77,-117.64 78.99,-114.44"></polygon> </g> </g>
</svg>
</p>
</div>
</div>
</div>
<p>DAGs are diagrams, where the arrows represent causal effects. In this case, there’s some set of customer features <span class="math inline">\(X\)</span>, that influence some set of short term outcomes, <span class="math inline">\(S\)</span> (a surrogate index).</p>
<p>There’s also a treatment, <span class="math inline">\(\text{Tx}\)</span>, that influences <span class="math inline">\(S\)</span>. It may influence different short term outcomes in S in different ways.</p>
<p>Lastly there’s <span class="math inline">\(Y\)</span>, our long-term outcome of interest. Notice that all of the effect of the treatment on <span class="math inline">\(Y\)</span> flows through <span class="math inline">\(S\)</span>. This is saying that the entire causal effect of the treatment on <span class="math inline">\(Y\)</span> is explained by the effect of the treatment on <span class="math inline">\(S\)</span>. Keep note of that, because its a key assumption for Surrogate Indexes to work.</p>
<p>A more detailed way to show this is through the use of <a href="https://academic.oup.com/ije/article/50/2/613/5998421">IDAGs</a>, a newer way to represent DAGs with interactions</p>
<div class="cell">
<div class="cell-output-display">
<div>
<p>
<svg width="672" height="480" viewbox="0.00 0.00 220.79 188.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)"> <polygon fill="white" stroke="transparent" points="-4,4 -4,-184 216.79,-184 216.79,4 -4,4"></polygon> <!-- x --> <g id="node1" class="node">
<title>
x
</title>
<ellipse fill="none" stroke="black" cx="27" cy="-162" rx="27" ry="18"></ellipse> <text text-anchor="middle" x="27" y="-157.8" font-family="Times,serif" font-size="14.00">X</text> </g> <!-- s --> <g id="node2" class="node">
<title>
s
</title>
<ellipse fill="none" stroke="black" cx="61" cy="-90" rx="27" ry="18"></ellipse> <text text-anchor="middle" x="61" y="-85.8" font-family="Times,serif" font-size="14.00">S</text> </g> <!-- x&#45;&gt;s --> <g id="edge1" class="edge">
<title>
x-&gt;s
</title>
<path fill="none" stroke="black" d="M34.89,-144.76C38.9,-136.49 43.89,-126.23 48.42,-116.9"></path> <polygon fill="black" stroke="black" points="51.7,-118.16 52.92,-107.63 45.4,-115.1 51.7,-118.16"></polygon> </g> <!-- y --> <g id="node3" class="node">
<title>
y
</title>
<ellipse fill="none" stroke="black" cx="61" cy="-18" rx="27" ry="18"></ellipse> <text text-anchor="middle" x="61" y="-13.8" font-family="Times,serif" font-size="14.00">Y</text> </g> <!-- s&#45;&gt;y --> <g id="edge3" class="edge">
<title>
s-&gt;y
</title>
<path fill="none" stroke="black" d="M61,-71.7C61,-63.98 61,-54.71 61,-46.11"></path> <polygon fill="black" stroke="black" points="64.5,-46.1 61,-36.1 57.5,-46.1 64.5,-46.1"></polygon> </g> <!-- t --> <g id="node4" class="node">
<title>
t
</title>
<ellipse fill="none" stroke="black" cx="99" cy="-162" rx="27" ry="18"></ellipse> <text text-anchor="middle" x="99" y="-157.8" font-family="Times,serif" font-size="14.00">Tx</text> </g> <!-- t&#45;&gt;s --> <g id="edge2" class="edge">
<title>
t-&gt;s
</title>
<path fill="none" stroke="black" d="M90.19,-144.76C85.58,-136.28 79.84,-125.71 74.68,-116.2"></path> <polygon fill="black" stroke="black" points="77.61,-114.27 69.77,-107.15 71.46,-117.61 77.61,-114.27"></polygon> </g> <!-- X --> <g id="node5" class="node">
<title>
X
</title>
<ellipse fill="none" stroke="black" cx="176" cy="-162" rx="27" ry="18"></ellipse> <text text-anchor="middle" x="176" y="-157.8" font-family="Times,serif" font-size="14.00">X</text> </g> <!-- ΔS_Tx --> <g id="node6" class="node">
<title>
ΔS_Tx
</title>
<ellipse fill="none" stroke="black" cx="176" cy="-90" rx="36.58" ry="18"></ellipse> <text text-anchor="middle" x="176" y="-85.8" font-family="Times,serif" font-size="14.00">ΔS_Tx</text> </g> <!-- X&#45;&gt;ΔS_Tx --> <g id="edge4" class="edge">
<title>
X-&gt;ΔS_Tx
</title>
<path fill="none" stroke="black" d="M176,-143.7C176,-135.98 176,-126.71 176,-118.11"></path> <polygon fill="black" stroke="black" points="179.5,-118.1 176,-108.1 172.5,-118.1 179.5,-118.1"></polygon> </g> <!-- Y --> <g id="node7" class="node">
<title>
Y
</title>
<ellipse fill="none" stroke="black" cx="176" cy="-18" rx="27" ry="18"></ellipse> <text text-anchor="middle" x="176" y="-13.8" font-family="Times,serif" font-size="14.00">Y</text> </g> <!-- ΔS_Tx&#45;&gt;Y --> <g id="edge5" class="edge">
<title>
ΔS_Tx-&gt;Y
</title>
<path fill="none" stroke="black" d="M176,-71.7C176,-63.98 176,-54.71 176,-46.11"></path> <polygon fill="black" stroke="black" points="179.5,-46.1 176,-36.1 172.5,-46.1 179.5,-46.1"></polygon> </g> </g>
</svg>
</p>
</div>
</div>
</div>
<p>The IDAG is shown on the right. The main difference is the new term, <span class="math inline">\(\Delta S_{\text{Tx}}\)</span> It implies that <span class="math inline">\(X\)</span> impacts the effect of the treatment on <span class="math inline">\(S\)</span>. More simply, the treatment will have different effects on <span class="math inline">\(S\)</span> for different people based on their background, <span class="math inline">\(X\)</span>, also known as <strong>heterogeneous treatment effects (HTEs)</strong>.</p>
<blockquote class="blockquote">
<p>Typically we average over HTEs to just get a single average treatment effect (ATE) for experiments, and that’s what we’ll be doing here. But there are ways to estimate HTEs as well, and we’ll get to that in part 3 of this series.</p>
</blockquote>
<p>This DAG can be used to build a surrogate index. If you can identify a set, <span class="math inline">\(S\)</span>, of shorter term proxies for <span class="math inline">\(Y\)</span>, and the effect of the treatment on <span class="math inline">\(Y\)</span> is entirely explained by <span class="math inline">\(S\)</span>, than you can use <span class="math inline">\(\hat{Y} = f(S, X, T) + \epsilon\)</span> as an unbiased estimator for <span class="math inline">\(Y\)</span> before <span class="math inline">\(Y\)</span> is actually observed. This also means that you can estimate the long term treatment effect by observing <span class="math inline">\(S\)</span> for each variant of an experiment and using it to predict <span class="math inline">\(\hat{Y}\)</span> for each group, then taking the difference: <span class="math display">\[
E[\delta_{\text{LTO}}] = E[\hat{Y} | T=1] - E[\hat{Y} | T=0]
\]</span></p>
<p>where <span class="math inline">\(\delta_{\text{LTO}}\)</span> is the treatment effect on the long term outcome.</p>
<p>Lets start simulating to see that for ourselves</p>
</section>
<section id="showing-that-surrogate-index-works-with-simulated-data" class="level1">
<h1>Showing that Surrogate Index works with Simulated Data</h1>
<section id="step-1-simulating-the-data" class="level2">
<h2 class="anchored" data-anchor-id="step-1-simulating-the-data">Step 1: Simulating the data</h2>
<p>We’ll start by simulating two datasets: A historical dataset and an experiment dataset. The advantage to simulating data is that we know the exact effects, so when we try and estimate them we can confirm our methods are recovering the true effect.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> simple_simulation <span class="im">import</span> set_true_parameters, transmitter</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>SEED <span class="op">=</span> <span class="dv">99</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># step 1: simulate data</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(seed<span class="op">=</span>SEED)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>logit_link<span class="op">=</span><span class="va">True</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># True parameters</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>Zdims <span class="op">=</span> <span class="dv">20</span> <span class="co"># customer latent dims</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>Xdims <span class="op">=</span> <span class="dv">5</span> <span class="co"># pre treatment covariates</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>Sdims <span class="op">=</span> <span class="dv">8</span> <span class="co"># intermediate outcomes (the surrogates)</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>n_users <span class="op">=</span> <span class="dv">50000</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>GROUND_TRUTH <span class="op">=</span> set_true_parameters(Zdims, Xdims, Sdims, logit_link<span class="op">=</span><span class="va">True</span>, rng<span class="op">=</span>rng)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate data </span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>historical_data <span class="op">=</span> transmitter(GROUND_TRUTH, add_treatment<span class="op">=</span><span class="va">False</span>, n_users<span class="op">=</span>n_users,logit_link<span class="op">=</span>logit_link, rng<span class="op">=</span>rng) </span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>experiment_data <span class="op">=</span> transmitter(GROUND_TRUTH, add_treatment<span class="op">=</span><span class="va">True</span>, n_users<span class="op">=</span>n_users, logit_link<span class="op">=</span>logit_link, rng<span class="op">=</span>rng)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Censor the experiment dataset so that we dont know the long term outcome yet</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>Y_TRUE <span class="op">=</span> experiment_data.Y.values</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>experiment_data <span class="op">=</span> experiment_data.assign(Y<span class="op">=</span>np.NaN)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the historical dataset </span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>display(historical_data.head(<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>X0</th>
      <th>X1</th>
      <th>X2</th>
      <th>X3</th>
      <th>X4</th>
      <th>T</th>
      <th>S0</th>
      <th>S1</th>
      <th>S2</th>
      <th>S3</th>
      <th>S4</th>
      <th>S5</th>
      <th>S6</th>
      <th>S7</th>
      <th>Y</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.122906</td>
      <td>0.870259</td>
      <td>-1.054623</td>
      <td>-0.139527</td>
      <td>-1.433731</td>
      <td>0.0</td>
      <td>1.136292</td>
      <td>0.470017</td>
      <td>-0.263080</td>
      <td>0.486101</td>
      <td>0.723525</td>
      <td>0.129917</td>
      <td>-0.493243</td>
      <td>0.679735</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.736599</td>
      <td>-0.706638</td>
      <td>1.337368</td>
      <td>-0.111941</td>
      <td>-0.838790</td>
      <td>0.0</td>
      <td>0.151892</td>
      <td>-0.107404</td>
      <td>0.140590</td>
      <td>-0.815408</td>
      <td>0.274605</td>
      <td>-0.446996</td>
      <td>0.354266</td>
      <td>-1.318440</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.110126</td>
      <td>-1.617668</td>
      <td>1.262500</td>
      <td>1.049915</td>
      <td>-0.592917</td>
      <td>0.0</td>
      <td>-0.166384</td>
      <td>-0.147854</td>
      <td>0.565484</td>
      <td>-1.401817</td>
      <td>-0.086840</td>
      <td>-0.453305</td>
      <td>0.529608</td>
      <td>-1.086965</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.475479</td>
      <td>-0.507716</td>
      <td>0.324226</td>
      <td>1.259292</td>
      <td>-0.366888</td>
      <td>0.0</td>
      <td>0.154545</td>
      <td>0.161311</td>
      <td>0.087151</td>
      <td>-0.750579</td>
      <td>0.103096</td>
      <td>-0.098244</td>
      <td>0.131146</td>
      <td>0.032963</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.290787</td>
      <td>-0.575874</td>
      <td>0.867617</td>
      <td>0.844031</td>
      <td>-0.098109</td>
      <td>0.0</td>
      <td>-0.089913</td>
      <td>0.078953</td>
      <td>0.067596</td>
      <td>-0.773764</td>
      <td>0.041729</td>
      <td>-0.170939</td>
      <td>0.318613</td>
      <td>-0.506544</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>The underlying simulation code is below if you’re interested</p>
<div class="cell" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transmitter(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    params: Dict,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    add_treatment: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    n_users: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    logit_link: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> <span class="va">None</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Simulates outcomes based on some ground truth parameters. </span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">        params: The ground truth parameters (effects and biases) to simulate based off of</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">        add_treatment: adds a randomly allocated treatment when true, with effect `bTS`</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">        n_users: The number of users to simulate</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">        logit_link: whether the data generating process is a bernoulli outcome or not</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co">        rng: A numpy random generator </span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co">        A pandas dataframe with simulated data, including pre-treatment covariates,</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co">         surrogate outcomes, a treatment indicator, and a long term outcome, Y</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rng <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> np.random.choice(<span class="bu">range</span>(<span class="dv">1000</span>))</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        rng <span class="op">=</span> np.random.default_rng(seed<span class="op">=</span>seed)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># unpack params</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    Zdims, Xdims, Sdims <span class="op">=</span>  params[<span class="st">'bZX'</span>].shape[<span class="dv">1</span>],  params[<span class="st">'bZX'</span>].shape[<span class="dv">0</span>],  params[<span class="st">'bXS'</span>].shape[<span class="dv">0</span>]</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    alphaX,alphaS,alphaY  <span class="op">=</span> params[<span class="st">'alphaX'</span>], params[<span class="st">'alphaS'</span>], params[<span class="st">'alphaY'</span>] <span class="co"># bias terms</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    bZX,bXS,bSY <span class="op">=</span> params[<span class="st">'bZX'</span>], params[<span class="st">'bXS'</span>],params[<span class="st">'bSY'</span>] <span class="co"># causal relationships</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    bTS,bXTS <span class="op">=</span> params[<span class="st">'bTS'</span>], params[<span class="st">'bXTS'</span>] <span class="co"># tx effects</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># unobserved variable Z representing latent customer traits</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    Z <span class="op">=</span> rng.normal(<span class="dv">0</span>,<span class="dv">1</span>, size<span class="op">=</span>(Zdims, n_users))</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Some observed pre-TX measures</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> alphaX[:,<span class="va">None</span>] <span class="op">+</span> (bZX <span class="op">@</span> Z)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Intermediate outcomes</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> alphaS[:,<span class="va">None</span>] <span class="op">+</span> (bXS <span class="op">@</span> X) </span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add in treatment effect if applicable</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> rng.binomial(<span class="dv">1</span>,<span class="fl">0.5</span>,size<span class="op">=</span>n_users) <span class="cf">if</span> add_treatment <span class="cf">else</span> np.zeros(n_users)        </span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    avg_tx_term <span class="op">=</span> (bTS <span class="op">*</span> T[:,<span class="va">None</span>])        </span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    hetergeneous_tx_term <span class="op">=</span> (bXTS <span class="op">@</span> (X<span class="op">*</span>T))</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    S <span class="op">+=</span> avg_tx_term.T <span class="op">+</span> hetergeneous_tx_term</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># expectation of long term outcome</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    eta <span class="op">=</span> <span class="dv">0</span> <span class="op">+</span> (bSY <span class="op">@</span> S)</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Long term outcome</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> logit_link:</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>        Y <span class="op">=</span> rng.binomial(<span class="dv">1</span>, sp.expit(eta) )</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>        Y <span class="op">=</span> rng.normal(eta, <span class="fl">0.025</span>)</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Output as dataframe</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    Xdf <span class="op">=</span> pd.DataFrame(X.T, columns<span class="op">=</span>[<span class="ss">f'X</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(Xdims)]).assign(T<span class="op">=</span>T)</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    Sdf <span class="op">=</span> pd.DataFrame(S.T, columns<span class="op">=</span>[<span class="ss">f'S</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(Sdims)])</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    Ydf <span class="op">=</span> pd.DataFrame(Y.ravel(), columns<span class="op">=</span>[<span class="st">'Y'</span>])</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.concat((Xdf, Sdf, Ydf),axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-2-fitting-a-surrogate-model" class="level2">
<h2 class="anchored" data-anchor-id="step-2-fitting-a-surrogate-model">Step 2: Fitting a surrogate model</h2>
<p>We’ll use the historical dataset to fit the surrogate index model, mapping <span class="math inline">\(S \rightarrow Y\)</span></p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>S_vars <span class="op">=</span> <span class="st">" + "</span>.join( historical_data.<span class="bu">filter</span>(like<span class="op">=</span><span class="st">"S"</span>).columns )</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>X_vars <span class="op">=</span> <span class="st">" + "</span>.join( historical_data.<span class="bu">filter</span>(like<span class="op">=</span><span class="st">"X"</span>).columns )</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: fit a surrogate index model on complete historical data</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>surrogate_model <span class="op">=</span> sm.OLS.from_formula(<span class="ss">f"Y ~ </span><span class="sc">{</span>S_vars<span class="sc">}</span><span class="ss">"</span>, data<span class="op">=</span>historical_data).fit()</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate the variance in the estimator, \hat{sigma^2}. This is used for bias corrections later</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>predicted_sigma2 <span class="op">=</span> np.var( surrogate_model.fittedvalues <span class="op">-</span> historical_data.Y,  ddof<span class="op">=</span><span class="dv">1</span> )</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the model summary</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>surrogate_model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">

<table class="simpletable">
<caption>OLS Regression Results</caption>
<tbody><tr>
  <th>Dep. Variable:</th>            <td>Y</td>        <th>  R-squared:         </th> <td>   0.109</td> 
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th> <td>   0.109</td> 
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th> <td>   1227.</td> 
</tr>
<tr>
  <th>Date:</th>             <td>Tue, 26 Sep 2023</td> <th>  Prob (F-statistic):</th>  <td>  0.00</td>  
</tr>
<tr>
  <th>Time:</th>                 <td>20:23:12</td>     <th>  Log-Likelihood:    </th> <td> -33395.</td> 
</tr>
<tr>
  <th>No. Observations:</th>      <td> 50000</td>      <th>  AIC:               </th> <td>6.680e+04</td>
</tr>
<tr>
  <th>Df Residuals:</th>          <td> 49994</td>      <th>  BIC:               </th> <td>6.686e+04</td>
</tr>
<tr>
  <th>Df Model:</th>              <td>     5</td>      <th>                     </th>     <td> </td>    
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>     <td> </td>    
</tr>
</tbody></table>
<table class="simpletable">
<tbody><tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P&gt;|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>    0.4987</td> <td>    0.002</td> <td>  236.271</td> <td> 0.000</td> <td>    0.495</td> <td>    0.503</td>
</tr>
<tr>
  <th>S0</th>        <td>    0.0361</td> <td>    0.004</td> <td>   10.244</td> <td> 0.000</td> <td>    0.029</td> <td>    0.043</td>
</tr>
<tr>
  <th>S1</th>        <td>    0.1035</td> <td>    0.005</td> <td>   21.661</td> <td> 0.000</td> <td>    0.094</td> <td>    0.113</td>
</tr>
<tr>
  <th>S2</th>        <td>   -0.0399</td> <td>    0.005</td> <td>   -8.396</td> <td> 0.000</td> <td>   -0.049</td> <td>   -0.031</td>
</tr>
<tr>
  <th>S3</th>        <td>    0.1833</td> <td>    0.004</td> <td>   49.916</td> <td> 0.000</td> <td>    0.176</td> <td>    0.190</td>
</tr>
<tr>
  <th>S4</th>        <td>    0.0482</td> <td>    0.002</td> <td>   29.074</td> <td> 0.000</td> <td>    0.045</td> <td>    0.051</td>
</tr>
<tr>
  <th>S5</th>        <td>    0.0674</td> <td>    0.002</td> <td>   29.208</td> <td> 0.000</td> <td>    0.063</td> <td>    0.072</td>
</tr>
<tr>
  <th>S6</th>        <td>   -0.0057</td> <td>    0.002</td> <td>   -2.350</td> <td> 0.019</td> <td>   -0.010</td> <td>   -0.001</td>
</tr>
<tr>
  <th>S7</th>        <td>    0.0054</td> <td>    0.003</td> <td>    1.970</td> <td> 0.049</td> <td> 2.64e-05</td> <td>    0.011</td>
</tr>
</tbody></table>
<table class="simpletable">
<tbody><tr>
  <th>Omnibus:</th>       <td>250873.640</td> <th>  Durbin-Watson:     </th> <td>   1.993</td>
</tr>
<tr>
  <th>Prob(Omnibus):</th>   <td> 0.000</td>   <th>  Jarque-Bera (JB):  </th> <td>5244.738</td>
</tr>
<tr>
  <th>Skew:</th>            <td> 0.004</td>   <th>  Prob(JB):          </th> <td>    0.00</td>
</tr>
<tr>
  <th>Kurtosis:</th>        <td> 1.413</td>   <th>  Cond. No.          </th> <td>1.96e+16</td>
</tr>
</tbody></table><br><br>Notes:<br>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.<br>[2] The smallest eigenvalue is 2.41e-28. This might indicate that there are<br>strong multicollinearity problems or that the design matrix is singular.
</div>
</div>
<p>There are 3 important things to note here:</p>
<ol type="1">
<li>Note that we’re purposely not including the pre-treatment covariates, <span class="math inline">\(X\)</span> in this model. Remember the DAG - all of the effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> is entirely mediated by <span class="math inline">\(S\)</span>, so adding <span class="math inline">\(X\)</span> into the model adds no additional information.</li>
<li>We’re using Ordinary Least Squares for bernoulli outcome data. Thats not a mistake. OLS has great properties to be effective on bernoulli outcome data, and it makes this approach very simple. Other models can also be swapped in, like Random Forest or XGBoost.</li>
<li>I’m not doing alot of model validation, just because this is simulated data. In practice, don’t just throw things into a model. Part 2 in this series will discuss how to validate surrogate indexes.</li>
</ol>
</section>
<section id="step-3-estimate-long-term-treatment-effect" class="level2">
<h2 class="anchored" data-anchor-id="step-3-estimate-long-term-treatment-effect">Step 3: Estimate Long Term Treatment Effect</h2>
<p>We’ll now use the surrogate index to estimate a long term treatment effect</p>
<p>Let’s take our experiment dataset and estimate <span class="math inline">\(E[\delta_{\text{LTO}}]\)</span>, the average treatment effect on the long term outcome. Notice, the long term outcome, <span class="math inline">\(Y\)</span>, hasn’t been observed yet.</p>
<div class="cell" data-execution_count="4">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>display(experiment_data.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>X0</th>
      <th>X1</th>
      <th>X2</th>
      <th>X3</th>
      <th>X4</th>
      <th>T</th>
      <th>S0</th>
      <th>S1</th>
      <th>S2</th>
      <th>S3</th>
      <th>S4</th>
      <th>S5</th>
      <th>S6</th>
      <th>S7</th>
      <th>Y</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.524763</td>
      <td>2.462224</td>
      <td>-0.550430</td>
      <td>0.771123</td>
      <td>0.435625</td>
      <td>0</td>
      <td>0.699780</td>
      <td>0.013300</td>
      <td>-1.550533</td>
      <td>0.516532</td>
      <td>0.555615</td>
      <td>0.259520</td>
      <td>-0.912439</td>
      <td>1.968729</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.852718</td>
      <td>2.363775</td>
      <td>-1.233271</td>
      <td>-0.064883</td>
      <td>0.007073</td>
      <td>1</td>
      <td>0.401477</td>
      <td>0.150007</td>
      <td>-1.056908</td>
      <td>1.090094</td>
      <td>0.319569</td>
      <td>1.315168</td>
      <td>-1.060364</td>
      <td>1.639560</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-1.845904</td>
      <td>-0.143859</td>
      <td>1.205996</td>
      <td>-2.574407</td>
      <td>-0.338278</td>
      <td>1</td>
      <td>-0.617663</td>
      <td>-0.031722</td>
      <td>0.353283</td>
      <td>0.503690</td>
      <td>-0.077284</td>
      <td>0.706088</td>
      <td>0.401262</td>
      <td>-2.388860</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.860914</td>
      <td>-1.382552</td>
      <td>0.295809</td>
      <td>-2.023966</td>
      <td>-0.018137</td>
      <td>0</td>
      <td>-0.691752</td>
      <td>-0.197120</td>
      <td>1.080598</td>
      <td>0.329710</td>
      <td>-0.489959</td>
      <td>-0.151432</td>
      <td>0.610699</td>
      <td>-1.754289</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.257026</td>
      <td>0.005047</td>
      <td>-0.333462</td>
      <td>-0.386979</td>
      <td>-0.126490</td>
      <td>1</td>
      <td>-0.391908</td>
      <td>-0.302902</td>
      <td>0.220642</td>
      <td>0.201999</td>
      <td>-0.343136</td>
      <td>0.883784</td>
      <td>-0.312573</td>
      <td>-0.012875</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>First, we’ll do some visulation of the experiment data.</p>
<div class="cell" data-execution_count="5">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>,<span class="bu">int</span>(Xdims<span class="op">/</span><span class="dv">2</span>),figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">5</span>),sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ax <span class="kw">in</span> <span class="bu">zip</span>(<span class="bu">range</span>(Xdims), axes.ravel()):</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    sns.histplot( experiment_data.loc[<span class="kw">lambda</span> d: d[<span class="st">'T'</span>]<span class="op">==</span><span class="dv">0</span>][<span class="ss">f"X</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>],ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">'Control'</span> )</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    sns.histplot( experiment_data.loc[<span class="kw">lambda</span> d: d[<span class="st">'T'</span>]<span class="op">==</span><span class="dv">1</span>][<span class="ss">f"X</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>],ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">'Treatment'</span> )</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Histogram of Pre-Treatment Covariates</span><span class="ch">\n</span><span class="st">for the Treatment and Control groups"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="2023-07-09-surrogate_index_intro_files/figure-html/cell-6-output-1.png" width="758" height="475"></p>
</div>
</div>
<p>As we can see above, the pre-treatment variables are the exact same between the experiment groups. Thats because users are randomly allocated into treatment and control groups, and their pre-treatment varibles by definition are things not imapcted by the experiment.</p>
<p>Conversely, if we look at the surrogate outcomes below, we’ll see some differences in surrogate outcomes between the treatment and control groups.</p>
<div class="cell" data-execution_count="6">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>,<span class="bu">int</span>(Sdims<span class="op">/</span><span class="dv">2</span>),figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">5</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ax <span class="kw">in</span> <span class="bu">zip</span>(<span class="bu">range</span>(Sdims), axes.ravel()):</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    sns.histplot( experiment_data.loc[<span class="kw">lambda</span> d: d[<span class="st">'T'</span>]<span class="op">==</span><span class="dv">0</span>][<span class="ss">f"S</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>],ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">'Control'</span> )</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    sns.histplot( experiment_data.loc[<span class="kw">lambda</span> d: d[<span class="st">'T'</span>]<span class="op">==</span><span class="dv">1</span>][<span class="ss">f"S</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>],ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">'Treatment'</span> )</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Histogram of Surrogate Outcomes</span><span class="ch">\n</span><span class="st">for the Treatment and Control groups"</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="2023-07-09-surrogate_index_intro_files/figure-html/cell-7-output-1.png" width="758" height="475"></p>
</div>
</div>
<p>If our surrogate index estimator is correct, these observed surrogate outcomes should directly map to the Long Term Outcome deterministically, via <span class="math inline">\(\hat{Y} = f(S)\)</span>, where <span class="math inline">\(f()\)</span> is the surrogate index model.</p>
<p>We can show that the surrogate index estimator recovers the true average treatment effect on the long term outcome</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_delta_LTO(experiment_data, surrogate_model, predicted_sigma2):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Accepts experiment data with a binary treatment, a surrogate model, and the predicted sigma^2 of the surrogate model.</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns the ATE estimate and its uncertainty</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    Y_T1 <span class="op">=</span> surrogate_model.predict(experiment_data.loc[<span class="kw">lambda</span> d: d[<span class="st">'T'</span>]<span class="op">==</span><span class="dv">1</span>])</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    Y_T0 <span class="op">=</span> surrogate_model.predict(experiment_data.loc[<span class="kw">lambda</span> d: d[<span class="st">'T'</span>]<span class="op">==</span><span class="dv">0</span>])</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the ATE</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    ATE <span class="op">=</span>  Y_T1.mean() <span class="op">-</span> Y_T0.mean()</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate the variance </span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    var_surrogate <span class="op">=</span> np.var(Y_T1,ddof<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span> <span class="bu">len</span>(Y_T1) <span class="op">+</span> np.var(Y_T0,ddof<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span> <span class="bu">len</span>(Y_T0)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust the variance by the surrogate model error</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    var_surrogate_adj <span class="op">=</span> var_surrogate <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>predicted_sigma2<span class="op">/</span><span class="bu">len</span>(Y_T1)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    ATE_sd <span class="op">=</span> np.sqrt(var_surrogate_adj)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ATE, ATE_sd</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>ATE, ATE_sd <span class="op">=</span> estimate_delta_LTO(experiment_data, surrogate_model, predicted_sigma2)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>sns.histplot(np.random.normal(ATE, ATE_sd,size<span class="op">=</span><span class="dv">10000</span>), stat<span class="op">=</span><span class="st">'probability'</span>)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>plt.axvline( GROUND_TRUTH[<span class="st">'ATE'</span>], color<span class="op">=</span><span class="st">'r'</span>, ls<span class="op">=</span><span class="st">'--'</span>, label<span class="op">=</span><span class="st">'True ATE'</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"ATE"</span>)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Estimated Treatment Effect vs. True Treatment Effect"</span>)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-09-surrogate_index_intro_files/figure-html/cell-8-output-1.png" width="618" height="442"></p>
</div>
</div>
<p>There we are. The surrogate estimator recovers the true average treatment effect! We didn’t even have to wait and observe the true long term outcome.</p>
<p>If you’re interested, try simulating this repeatedly to confirm it regularly recovers the true ATE with different random seeds. Even better, try setting the treatment effect to zero and see how often there are false positives.</p>
</section>
</section>
<section id="whats-next" class="level1">
<h1>What’s next?</h1>
<p>Hopefully this post convinced you that the surrogate index approach can help assess long term outcomes in experiments faster.</p>
<p>While its easier to show this approach works, it’s harder to pull it off in practice. The next post will focus on how to validate a surrogate index estimator on more realistic data that you might see in industry.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>