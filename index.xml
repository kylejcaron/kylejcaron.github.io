<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Kyle Caron</title>
<link>https://kylejcaron.github.io/</link>
<atom:link href="https://kylejcaron.github.io/index.xml" rel="self" type="application/rss+xml"/>
<description>Welcome to my blog! I&#39;m a self-taught data scientist interested in causal inference and bayesian methods. I mainly use this blog to formalize what I learn, but hopefully others find it helpful as well.</description>
<generator>quarto-1.6.41</generator>
<lastBuildDate>Thu, 06 Mar 2025 05:00:00 GMT</lastBuildDate>
<item>
  <title>An easy way to choose evaluation metrics</title>
  <link>https://kylejcaron.github.io/posts/2025-03-06-metric-choice.html</link>
  <description><![CDATA[ 





<div class="callout callout-style-default callout-warning callout-titled" title="Disclaimer">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Disclaimer
</div>
</div>
<div class="callout-body-container callout-body">
<p>I’m not going to dive into forecasting evaluation here. I’m going to highlight a simple technique to consider when you’re struggling with metric choice.</p>
</div>
</div>
<section id="the-problem" class="level1">
<h1>The Problem</h1>
<p>You work at a company that wants to forecast demand with historical sales data. Your team is going back and forth on what the perfect evaluation metric is. The goal is to use the evaluation metric to decide which forecast to use.</p>
<p>The team’s a bit hung up, some feel strongly RMSE is the right choice, while others want to use MAPE. It turns out there can often be easy ways to choose a metric with simulation.</p>
<p>We’ll focus on the question, <strong>“if we have a perfect forecast, what would our error metrics look like?”</strong> and we’ll use it to inform metric choice.</p>
</section>
<section id="simulating-a-fake-sales-time-series" class="level1">
<h1>Simulating a fake sales time series</h1>
<p>We’re going to simulate data where we know the real demand, and we add realistic amount of noise to it that resembles our actual dataset. In our case we assume the real dataset is poisson distributed, so we make our simulation have the same level of noise</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7Bsales%7D%20%5Csim%20%5Ctext%7BPoisson%7D(%5Clambda%20=%20%5Ctext%7Bdemand%7D)%0A"></p>
<p>The plot below shows the true underlying demand overlayed with daily sales</p>
<div id="31650c2a" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-4">pd.options.display.float_format <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{:.2f}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span></span>
<span id="cb1-5">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters</span></span>
<span id="cb1-8">years <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb1-9">period <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">365</span> </span>
<span id="cb1-10">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, years <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> period)  </span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We add a phase shift to make sure the first peak happens at day 182</span></span>
<span id="cb1-13">seasonality <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.cos(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.pi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">182</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> period) </span>
<span id="cb1-14">mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> np.exp( <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>seasonality )</span>
<span id="cb1-15">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.poisson(mu)</span>
<span id="cb1-16"></span>
<span id="cb1-17">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"demand"</span>:mu, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sales"</span>:y}, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>pd.date_range(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2014-01-01"</span>, periods<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(t)))</span>
<span id="cb1-18"></span>
<span id="cb1-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># resample to weekly level</span></span>
<span id="cb1-20">dfW <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.resample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"W"</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb1-21"></span>
<span id="cb1-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plotting</span></span>
<span id="cb1-23">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb1-24">dfW[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'demand'</span>]].plot(ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'True Demand'</span>)</span>
<span id="cb1-25">dfW[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sales'</span>]].plot(color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Sales'</span>)</span>
<span id="cb1-26">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'True Demand and Simulated Weekly Sales'</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Sales'</span>)</span>
<span id="cb1-27">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/2025-03-06-metric-choice_files/figure-html/cell-2-output-1.png" width="957" height="431" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>What we’re doing is really simple - we know we have a perfect forecast (its the true underlying demand), so ideally a good choice of metric should look reasonable here.</p>
</section>
<section id="in-sample-forecast-evaluation" class="level1">
<h1>In-sample forecast evaluation</h1>
<p>In-sample forecast evaluation will be used for simplicity since its a simulation anyways, but with real data its important to use n-step-ahead evaluation or time series cross validation.</p>
<div id="f9acb27d" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.metrics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> (</span>
<span id="cb2-2">    mean_absolute_percentage_error <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> mape, </span>
<span id="cb2-3">    mean_absolute_error <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> mae, </span>
<span id="cb2-4">    root_mean_squared_error <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> rmse</span>
<span id="cb2-5">)</span>
<span id="cb2-6">args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (dfW.sales.values, dfW.demand.values,)</span>
<span id="cb2-7">pd.DataFrame(</span>
<span id="cb2-8">    [mape(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args), mae(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args), rmse(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args) ], </span>
<span id="cb2-9">    columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'metric'</span>],</span>
<span id="cb2-10">    index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MAPE'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MAE'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'RMSE'</span>]</span>
<span id="cb2-11">).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">metric</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">MAPE</td>
<td>0.25</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">MAE</td>
<td>3.62</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">RMSE</td>
<td>5.04</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>MAE and RMSE error look fine here, but MAPE looks terrible - <strong>a <em>perfect</em> forecast here is off by 25% on average</strong> (weekly). Imagine telling a stakeholder that your great forecast is off by 25% on average.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>In general, MAPE is pretty well known to be a <a href="https://openforecast.org/2024/04/17/avoid-using-mape/">meh choice of metric</a>, but its especially apparent with low count data like this example.</p>
</div>
</div>
<p>We also established a <strong>definition of what a good forecast is</strong> - we know a perfect forecast on data of this magnitude and noise tends to have an MAE of 3.62 sales / week. If we’re anywhere near that we know we’re doing a good job.</p>
<p>This process has made it clear that MAE or RMSE error are suitable choices to consider while MAPE isn’t. Theory can drive the next step: MAE minimizes the median and is very interpretable while RMSE minimizes the mean but you lose a bit of interpretability.</p>
<p>There are also plenty of other metrics and evaluation techniques to consider, I just chose 3 of the most simple metrics for this example.</p>
</section>
<section id="concluding-thoughts" class="level1">
<h1>Concluding Thoughts</h1>
<p>This exercise was really simple: “if we had a perfect forecast, what would our error metrics look like?”</p>
<p>Using simulation to answer this question not only informs metric choice, but it also helps to establish a defintion of what a good forecast is.</p>
<p>I acknowledge there’s alot more that goes on in forecasting and decision making than just this. But in reality, alot of stakeholders (and even data team members) can get hung up on questions like this.</p>
<p>I had to use this exact process once to make sure my team didn’t use MAPE as an evaluation metric - telling someone that the best you can do with MAPE is a 25% error is a pretty convincing argument not to use it.</p>


</section>

 ]]></description>
  <category>metrics</category>
  <category>model evaluation</category>
  <category>time series</category>
  <guid>https://kylejcaron.github.io/posts/2025-03-06-metric-choice.html</guid>
  <pubDate>Thu, 06 Mar 2025 05:00:00 GMT</pubDate>
  <media:content url="https://kylejcaron.github.io/assets/img/placeholder.png" medium="image" type="image/png" height="95" width="144"/>
</item>
<item>
  <title>Common Misconceptions with Multicollinearity</title>
  <link>https://kylejcaron.github.io/posts/2025-03-06-multicollinearity-misconceptions.html</link>
  <description><![CDATA[ 





<p>I recently saw a viral linkedin post discussing how multicollinearity will ruin your regression estimates. The solution? Simply throw out variables with high Variance Inflation Factors and re-run your regression.</p>
<p>Let me tell you, <strong>don’t do this</strong>. A fear of multicollinearity is this misconception in data science that is far too prevalent.</p>
<p>I’ve seen the same assumptions with correlation - if two variables are very highly correlated people assume they shouldn’t be in the same model. I’m going to show you why 1) these approaches are a mistake and 2) you can’t escape domain knowledge when informing your regression.</p>
<section id="a-simulation" class="level1">
<h1>A simulation</h1>
<p>We’re going to simulate a fake scenario. You want to know the effect of some variable <img src="https://latex.codecogs.com/png.latex?X_3"> on <img src="https://latex.codecogs.com/png.latex?y"> with your regression. The data generating process is below</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 172.00 188.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-184 168,-184 168,4 -4,4"></polygon>
<!-- X1 -->
<g id="node1" class="node">
<title>X1</title>
<ellipse fill="none" stroke="black" cx="54" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="54" y="-157.8" font-family="Times,serif" font-size="14.00">X1</text>
</g>
<!-- X3 -->
<g id="node2" class="node">
<title>X3</title>
<ellipse fill="none" stroke="black" cx="27" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-85.8" font-family="Times,serif" font-size="14.00">X3</text>
</g>
<!-- X1&#45;&gt;X3 -->
<g id="edge1" class="edge">
<title>X1-&gt;X3</title>
<path fill="none" stroke="black" d="M47.6,-144.41C44.49,-136.34 40.67,-126.43 37.17,-117.35"></path>
<polygon fill="black" stroke="black" points="40.4,-116.03 33.54,-107.96 33.87,-118.55 40.4,-116.03"></polygon>
</g>
<!-- Y -->
<g id="node3" class="node">
<title>Y</title>
<ellipse fill="none" stroke="black" cx="82" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="82" y="-13.8" font-family="Times,serif" font-size="14.00">Y</text>
</g>
<!-- X1&#45;&gt;Y -->
<g id="edge3" class="edge">
<title>X1-&gt;Y</title>
<path fill="none" stroke="black" d="M57.38,-143.87C62.17,-119.56 70.99,-74.82 76.67,-46.01"></path>
<polygon fill="black" stroke="black" points="80.11,-46.68 78.61,-36.19 73.24,-45.32 80.11,-46.68"></polygon>
</g>
<!-- X3&#45;&gt;Y -->
<g id="edge2" class="edge">
<title>X3-&gt;Y</title>
<path fill="none" stroke="black" d="M38.93,-73.81C46.21,-64.55 55.66,-52.52 63.85,-42.09"></path>
<polygon fill="black" stroke="black" points="66.66,-44.18 70.09,-34.16 61.16,-39.86 66.66,-44.18"></polygon>
</g>
<!-- X2 -->
<g id="node4" class="node">
<title>X2</title>
<ellipse fill="none" stroke="black" cx="137" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="137" y="-85.8" font-family="Times,serif" font-size="14.00">X2</text>
</g>
<!-- X2&#45;&gt;Y -->
<g id="edge4" class="edge">
<title>X2-&gt;Y</title>
<path fill="none" stroke="black" d="M125.07,-73.81C117.79,-64.55 108.34,-52.52 100.15,-42.09"></path>
<polygon fill="black" stroke="black" points="102.84,-39.86 93.91,-34.16 97.34,-44.18 102.84,-39.86"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>The simulation below makes it clear the true effect of <img src="https://latex.codecogs.com/png.latex?X_3"> on <img src="https://latex.codecogs.com/png.latex?y"> is 0.7, so we know our regression <em>should hopefully</em> return it as an estimate</p>
<div id="7fb30bb4" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> statsmodels.api <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sm</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> statsmodels.stats.outliers_influence <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> variance_inflation_factor <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> vif</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-6"></span>
<span id="cb1-7">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span></span>
<span id="cb1-8">SIG <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb1-9">TRUE_EFFECT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span></span>
<span id="cb1-10"></span>
<span id="cb1-11">rng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.default_rng(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span>)</span>
<span id="cb1-12">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb1-13">    pd.DataFrame({</span>
<span id="cb1-14">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x1"</span>:rng.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>N), </span>
<span id="cb1-15">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x2"</span>:rng.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>N)}</span>
<span id="cb1-16">    )</span>
<span id="cb1-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># simulate x3 as a function of x1</span></span>
<span id="cb1-18">    .assign(x3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: rng.normal(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> d.x1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.8</span>, SIG))</span>
<span id="cb1-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># simulate y as a function of x1,x2,x3</span></span>
<span id="cb1-20">    .assign(y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: rng.normal(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> d.x1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> d.x2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> d.x3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>TRUE_EFFECT, SIG))</span>
<span id="cb1-21">)</span>
<span id="cb1-22">df.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">x1</th>
<th data-quarto-table-cell-role="th">x2</th>
<th data-quarto-table-cell-role="th">x3</th>
<th data-quarto-table-cell-role="th">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.082494</td>
<td>0.542553</td>
<td>1.964734</td>
<td>1.937899</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>-0.464418</td>
<td>1.592826</td>
<td>0.081777</td>
<td>1.331370</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.050515</td>
<td>-0.693920</td>
<td>0.814082</td>
<td>1.011092</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.686231</td>
<td>0.465077</td>
<td>3.438021</td>
<td>0.531865</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>-1.756791</td>
<td>-0.771811</td>
<td>-5.977299</td>
<td>3.363037</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Lets take a look at the variance inflation factors below</p>
<div id="429e7f93" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(like<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>)</span>
<span id="cb2-2">pd.DataFrame(</span>
<span id="cb2-3">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"VIF"</span>: [vif(X.values, i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(X.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])]}, </span>
<span id="cb2-4">    index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>X.columns</span>
<span id="cb2-5">).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">VIF</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">x1</td>
<td>10.35</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">x2</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">x3</td>
<td>10.35</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Based on this, we supposedly should remove <img src="https://latex.codecogs.com/png.latex?X_1"> from our regression (VIFs of 5-10 are considered high).</p>
<p>If we look at the correlation, we reach the same conclusions - <img src="https://latex.codecogs.com/png.latex?X_1"> has high correlation with <img src="https://latex.codecogs.com/png.latex?X_3"> so supposedly <em>“they provide the same information and only 1 is useful”</em></p>
<div id="33bb5486" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">X.corr().loc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x3'</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>x1    0.990898
x2   -0.020267
x3    1.000000
Name: x3, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="does-it-work" class="level1">
<h1>Does it work?</h1>
<p>We’re going to fit two regressions - one that follows the advice of throwing out variables with high VIFs or correlation - and another that is informed by domain knowledge.</p>
<div id="cc6ec277" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># vif/correlation informed variable selection</span></span>
<span id="cb5-2">m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sm.OLS.from_formula(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y ~ x2 + x3"</span>, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df).fit()</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># domain knowledge informed variable selection</span></span>
<span id="cb5-5">m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sm.OLS.from_formula(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y ~ x1 + x2 + x3"</span>, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df).fit()</span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> plot_ci(model, ax, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C0'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb5-8">    lb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (model.params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> model.bse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb5-9">    ub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> model.bse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb5-10">    ax.hlines(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, lb.loc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x3'</span>], ub.loc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x3'</span>], lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>label, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>color)</span>
<span id="cb5-11">    ax.scatter(model.params.loc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x3'</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, facecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>, edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>color, zorder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb5-12"></span>
<span id="cb5-13"></span>
<span id="cb5-14">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb5-15">plot_ci(m1, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C1'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'VIF informed model'</span>)</span>
<span id="cb5-16">plot_ci(m2, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C0'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Causally informed model'</span>)</span>
<span id="cb5-17"></span>
<span id="cb5-18">ax.axvline(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>)</span>
<span id="cb5-19">ax.axvline(TRUE_EFFECT, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'True Effect'</span>)</span>
<span id="cb5-20">ax.set_xlim(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-21">ax.set_ylim(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-22">ax.set_yticks([])</span>
<span id="cb5-23">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Estimated effect of X3 -&gt; y"</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Beta Coefficient"</span>)</span>
<span id="cb5-24">ax.legend()</span>
<span id="cb5-25">plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/2025-03-06-multicollinearity-misconceptions_files/figure-html/cell-5-output-1.png" width="575" height="449" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Not only is the VIF informed model wrong, but more importantly it actually thinks x3 has a negative effect instead of a positive effect!</p>
</section>
<section id="why-did-this-happen" class="level1">
<h1>Why did this happen?</h1>
<p>Lets go back to our data generating process</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 172.00 188.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-184 168,-184 168,4 -4,4"></polygon>
<!-- X1 -->
<g id="node1" class="node">
<title>X1</title>
<ellipse fill="none" stroke="black" cx="54" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="54" y="-157.8" font-family="Times,serif" font-size="14.00">X1</text>
</g>
<!-- X3 -->
<g id="node2" class="node">
<title>X3</title>
<ellipse fill="none" stroke="black" cx="27" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-85.8" font-family="Times,serif" font-size="14.00">X3</text>
</g>
<!-- X1&#45;&gt;X3 -->
<g id="edge1" class="edge">
<title>X1-&gt;X3</title>
<path fill="none" stroke="black" d="M47.6,-144.41C44.49,-136.34 40.67,-126.43 37.17,-117.35"></path>
<polygon fill="black" stroke="black" points="40.4,-116.03 33.54,-107.96 33.87,-118.55 40.4,-116.03"></polygon>
</g>
<!-- Y -->
<g id="node3" class="node">
<title>Y</title>
<ellipse fill="none" stroke="black" cx="82" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="82" y="-13.8" font-family="Times,serif" font-size="14.00">Y</text>
</g>
<!-- X1&#45;&gt;Y -->
<g id="edge3" class="edge">
<title>X1-&gt;Y</title>
<path fill="none" stroke="black" d="M57.38,-143.87C62.17,-119.56 70.99,-74.82 76.67,-46.01"></path>
<polygon fill="black" stroke="black" points="80.11,-46.68 78.61,-36.19 73.24,-45.32 80.11,-46.68"></polygon>
</g>
<!-- X3&#45;&gt;Y -->
<g id="edge2" class="edge">
<title>X3-&gt;Y</title>
<path fill="none" stroke="black" d="M38.93,-73.81C46.21,-64.55 55.66,-52.52 63.85,-42.09"></path>
<polygon fill="black" stroke="black" points="66.66,-44.18 70.09,-34.16 61.16,-39.86 66.66,-44.18"></polygon>
</g>
<!-- X2 -->
<g id="node4" class="node">
<title>X2</title>
<ellipse fill="none" stroke="black" cx="137" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="137" y="-85.8" font-family="Times,serif" font-size="14.00">X2</text>
</g>
<!-- X2&#45;&gt;Y -->
<g id="edge4" class="edge">
<title>X2-&gt;Y</title>
<path fill="none" stroke="black" d="M125.07,-73.81C117.79,-64.55 108.34,-52.52 100.15,-42.09"></path>
<polygon fill="black" stroke="black" points="102.84,-39.86 93.91,-34.16 97.34,-44.18 102.84,-39.86"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>It’s clear that <img src="https://latex.codecogs.com/png.latex?X_1"> causally effects both <img src="https://latex.codecogs.com/png.latex?X_3"> and <img src="https://latex.codecogs.com/png.latex?y"> - this makes it a confounding variable, or a “backdoor” for <img src="https://latex.codecogs.com/png.latex?X_3">. If we want our regression to have proper estimates of <img src="https://latex.codecogs.com/png.latex?X_3">, we therefore need to make sure our regression model accounts for <img src="https://latex.codecogs.com/png.latex?X_1"> to de-bias <img src="https://latex.codecogs.com/png.latex?X_3">.</p>
<p>This is why its so important to incorporate domain knowledge in your modeling. Mapping out the data generating process and using it to inform your model is always the right choice. For more on this check out <a href="https://ftp.cs.ucla.edu/pub/stat_ser/r493.pdf">A Crash Course on Good and Bad Controls</a>. I also really like Richard McElreath’s discussion on this in his 2nd edition of Statistical Rethinking.</p>


</section>

 ]]></description>
  <category>multicollinearity</category>
  <category>causal inference</category>
  <category>regression</category>
  <guid>https://kylejcaron.github.io/posts/2025-03-06-multicollinearity-misconceptions.html</guid>
  <pubDate>Thu, 06 Mar 2025 05:00:00 GMT</pubDate>
  <media:content url="https://kylejcaron.github.io/assets/img/placeholder.png" medium="image" type="image/png" height="95" width="144"/>
</item>
<item>
  <title>Automatic Dim Labelling with Numpyro?</title>
  <link>https://kylejcaron.github.io/posts/numpyro_dim_labelling/2025-02-23-numpyro-dim_labels.html</link>
  <description><![CDATA[ 





<div id="0309be02" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Optional, Callable, List, Dict</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpyro</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpyro.distributions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> dist</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpyro.infer <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> inspect, Predictive, MCMC, NUTS</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jaxlib</span>
<span id="cb1-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jax</span>
<span id="cb1-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jax.numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> jnp</span>
<span id="cb1-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> jax <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> jaxtyping <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Float, Array, Int</span>
<span id="cb1-12"></span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> arviz <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> az</span>
<span id="cb1-15">numpyro.set_host_device_count(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-16">SEED: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span></span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb1-19">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"numpyro version:"</span>, numpyro.__version__,</span>
<span id="cb1-20">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">jax version:"</span>, jax.__version__,</span>
<span id="cb1-21">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">jaxlib version"</span>, jaxlib.__version__,</span>
<span id="cb1-22">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">ArviZ version: "</span>, az.__version__</span>
<span id="cb1-23">)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>numpyro version: 0.17.0 
jax version: 0.5.0 
jaxlib version 0.5.0 
ArviZ version:  0.20.0</code></pre>
</div>
</div>
<p>The goal of this post is to figure out how to use numpyro internals to auto-label variable dimensions for ArviZ. PyMC is heavily integrated with ArviZ and their dimension labelling is fantastic - I want it to be just as easy with numpyro.</p>
<p>This isn’t going to be a very fun blog post, it’s meant to follow my thought process as I work through this problem. Maybe that’s helpful for some people? But mostly it will be a good reference for myself in the future.</p>
<section id="part-1-setting-a-baseline" class="level1">
<h1>Part 1: Setting a baseline</h1>
<section id="what-are-coords-and-dims" class="level2">
<h2 class="anchored" data-anchor-id="what-are-coords-and-dims">What are coords and dims?</h2>
<p>I’m assuming readers are familiar with this, but here is a quick refresher. ArviZ takes in a bayesian posterior and organizes it as an xarray dataset - picture pandas but for tensors. ArviZ expects <code>coords</code> and <code>dims</code> to map parameter dimensions to names and categories as show below</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb3-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E'</span>],</span>
<span id="cb3-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'features'</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X3'</span>]</span>
<span id="cb3-4">}</span>
<span id="cb3-5"></span>
<span id="cb3-6">dims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb3-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'beta'</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'category'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'features'</span>],</span>
<span id="cb3-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'category'</span>]</span>
<span id="cb3-9">}</span>
<span id="cb3-10">idata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> az.from_numpyro(mcmc_object, coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>coords, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dims)</span></code></pre></div>
<p>The <code>coords</code> map the category names to a positional index, where A corresponds to index 0, B corresponds to index 1, and so on.</p>
<p>Our <code>dims</code> tell us that our <code>gamma</code> parameter is indexed by <code>category</code>. This would estimate a gamma parameter for each category, i.e.&nbsp;<code>gamma[0]</code> is the gamma estimate for category A. <code>beta</code> in this case has a separate estimate for each category {A, B, C, D, E} and for each feature {X1, X2, X3}.</p>
<p>This is helpful for so many reasons - plots are easier to read with the category names displayed for each parameter, and you can do operations using the dimension names</p>
<p>The code snippet below returns the average estimate for beta when the category=A, which is extremely easy to read</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> idata.posterior[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'beta'</span>]</span>
<span id="cb4-2">avg_beta_groupA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> beta.sel(category<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>).mean((<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chain"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"draw"</span>))</span></code></pre></div>
<p>A properly labelled InferenceData object from ArviZ is a massive quality of life improvement.</p>
</section>
<section id="numpyros-default-behavior" class="level2">
<h2 class="anchored" data-anchor-id="numpyros-default-behavior">Numpyro’s default behavior</h2>
<p>Let’s explore numpyro’s default behavior and see where it falls short. We’ll start with simulating some regression data</p>
<div id="bc590f85" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">rng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.default_rng(SEED)</span>
<span id="cb5-2">N, n_feats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb5-3">z_cardinality <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb5-4"></span>
<span id="cb5-5">alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.3</span></span>
<span id="cb5-6">beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.normal(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_feats)</span>
<span id="cb5-7">gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.normal(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>z_cardinality)</span>
<span id="cb5-8">sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb5-9"></span>
<span id="cb5-10">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.normal(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(N, n_feats))</span>
<span id="cb5-11">z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.choice(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(z_cardinality), size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>N)</span>
<span id="cb5-12"></span>
<span id="cb5-13">mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> np.dot(X, beta) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> gamma[z]</span>
<span id="cb5-14">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.normal(mu, sigma)</span>
<span id="cb5-15"></span>
<span id="cb5-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># we'll make a coords dictionary for later</span></span>
<span id="cb5-17">coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb5-18">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Z"</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'F'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'G'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'H'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'I'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'J'</span>],</span>
<span id="cb5-19">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs_id"</span>: np.arange(N),</span>
<span id="cb5-20">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features"</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X2'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X3'</span>],</span>
<span id="cb5-21">}</span></code></pre></div>
</div>
<p>Next, lets fit a linear regression model and try and pass it into ArviZ to see what the dims for our parameters look like</p>
<div id="6049740c" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_inference(</span>
<span id="cb6-2">    model: Callable,</span>
<span id="cb6-3">    key: random.PRNGKey,</span>
<span id="cb6-4">    num_warmup: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, </span>
<span id="cb6-5">    num_chains: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, </span>
<span id="cb6-6">    num_samples: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb6-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs</span>
<span id="cb6-8">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> MCMC:</span>
<span id="cb6-9">    kernel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> NUTS(model)</span>
<span id="cb6-10">    mcmc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MCMC(kernel, num_warmup<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_warmup, num_chains<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_chains, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_samples, progress_bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb6-11">    mcmc.run(key, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb6-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> mcmc</span>
<span id="cb6-13"></span>
<span id="cb6-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> print_site_dims(idata, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">vars</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alpha'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'beta'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mu'</span>]):</span>
<span id="cb6-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> var <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">vars</span>:</span>
<span id="cb6-16">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>var<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:"</span>, idata.posterior[var].dims )</span></code></pre></div>
</details>
</div>
<div id="f63aec74" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> model(</span>
<span id="cb7-2">    X: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs features"</span>], </span>
<span id="cb7-3">    Z: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" obs"</span>], </span>
<span id="cb7-4">    y: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" obs"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb7-5">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" obs"</span>]:</span>
<span id="cb7-6"></span>
<span id="cb7-7">    n_features <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb7-8">    n_groups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(np.unique(Z))</span>
<span id="cb7-9">    </span>
<span id="cb7-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Z"</span>, n_groups):</span>
<span id="cb7-11">        alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alpha"</span>, dist.Normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb7-12"></span>
<span id="cb7-13">    sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma"</span>, dist.HalfNormal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb7-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features"</span>, n_features):</span>
<span id="cb7-15">        beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>, dist.Normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb7-16"></span>
<span id="cb7-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs_id"</span>, X.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]):</span>
<span id="cb7-18">        mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu"</span>, alpha[z] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> jnp.dot(X, beta))</span>
<span id="cb7-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>, dist.Normal(mu, sigma))</span>
<span id="cb7-20"></span>
<span id="cb7-21">mcmc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_inference(model, random.PRNGKey(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>X, Z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>z, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y)</span>
<span id="cb7-22">idata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> az.from_numpyro(mcmc)</span>
<span id="cb7-23">print_site_dims(idata)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>alpha: ('chain', 'draw', 'alpha_dim_0')
beta: ('chain', 'draw', 'beta_dim_0')
mu: ('chain', 'draw', 'mu_dim_0')</code></pre>
</div>
</div>
<p>What we really want is for those dimensions labeled “{site}_dim_0” to be labelled by their plate names, so we need to see if there’s a way to automatically grab the plate metadata. Luckily there’s an <code>inspect</code> module in numpyro that seems like it might cover some of this.</p>
</section>
<section id="pulling-plate-metadata" class="level2">
<h2 class="anchored" data-anchor-id="pulling-plate-metadata">Pulling plate metadata</h2>
<div id="890f1af1" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">model_relations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> inspect.get_model_relations(model, model_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>X, Z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>z, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y))</span>
<span id="cb9-2">model_relations</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>{'sample_sample': {'alpha': [],
  'sigma': [],
  'beta': [],
  'mu': ['alpha', 'beta'],
  'y': ['sigma', 'mu']},
 'sample_param': {'alpha': [], 'sigma': [], 'beta': [], 'mu': [], 'y': []},
 'sample_dist': {'alpha': 'Normal',
  'sigma': 'HalfNormal',
  'beta': 'Normal',
  'mu': 'Deterministic',
  'y': 'Normal'},
 'param_constraint': {},
 'plate_sample': {'Z': ['alpha'], 'features': ['beta'], 'obs_id': ['mu', 'y']},
 'observed': []}</code></pre>
</div>
</div>
<p>It looks like <code>plate_sample</code> has exactly what we need, its just in the wrong order. It should really be formatted as</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">{</span>
<span id="cb11-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alpha"</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Z"</span>]</span>
<span id="cb11-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features"</span>],</span>
<span id="cb11-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu"</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs_id"</span>],</span>
<span id="cb11-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs_id"</span>]</span>
<span id="cb11-6">}</span></code></pre></div>
<p>All we need to do is make a quick dictionary reversing function</p>
<div id="e54531c2" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> defaultdict</span>
<span id="cb12-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> reverse_plate_mapping(plate_mapping: Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]]:</span>
<span id="cb12-3">    reversed_map <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> defaultdict(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>)</span>
<span id="cb12-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> key, values <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> plate_mapping.items():</span>
<span id="cb12-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> value <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> values:</span>
<span id="cb12-6">            reversed_map[value].append(key)</span>
<span id="cb12-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> reversed_map</span>
<span id="cb12-8"></span>
<span id="cb12-9">dims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reverse_plate_mapping(model_relations[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plate_sample'</span>])</span>
<span id="cb12-10"></span>
<span id="cb12-11">idata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> az.from_numpyro(mcmc, coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>coords, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dims)</span>
<span id="cb12-12">print_site_dims(idata)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>alpha: ('chain', 'draw', 'Z')
beta: ('chain', 'draw', 'features')
mu: ('chain', 'draw', 'obs_id')</code></pre>
</div>
</div>
<p>Perfect! Next lets make sure this works when a site is within multiple plates - I’m concerned that my approach for reversing the plate mapping wont get the order right when a site is within multiple plates</p>
</section>
</section>
<section id="part-2-adding-an-edge-case-with-multiple-plates-per-site" class="level1">
<h1>Part 2: Adding an edge case with multiple plates per site</h1>
<section id="does-our-approach-preserve-the-dimension-order" class="level2">
<h2 class="anchored" data-anchor-id="does-our-approach-preserve-the-dimension-order">Does our approach preserve the dimension order?</h2>
<p>We’ll have to simulate some new data where <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> has group-specific effects. I’m going to make each feature have a group specific effect so that I can test if my solutions will work with nested plates.</p>
<div id="a223bb62" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulate new data</span></span>
<span id="cb14-2">beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.normal(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(z_cardinality, n_feats))</span>
<span id="cb14-3">mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> beta[z]).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> gamma[z]</span>
<span id="cb14-4">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.normal(mu, sigma)</span>
<span id="cb14-5"></span>
<span id="cb14-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> model2(</span>
<span id="cb14-7">    X: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs features"</span>], </span>
<span id="cb14-8">    Z: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" obs"</span>], </span>
<span id="cb14-9">    y: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" obs"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb14-10">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" obs"</span>]:</span>
<span id="cb14-11"></span>
<span id="cb14-12">    feature_plate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features"</span>, X.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb14-13">    group_plate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Z"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(np.unique(Z)), dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb14-14">    </span>
<span id="cb14-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> group_plate:</span>
<span id="cb14-16">        alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alpha"</span>, dist.Normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb14-17"></span>
<span id="cb14-18">    sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma"</span>, dist.HalfNormal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb14-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> group_plate, feature_plate:</span>
<span id="cb14-20">        beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>, dist.Normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb14-21"></span>
<span id="cb14-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs_id"</span>, X.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]):</span>
<span id="cb14-23">        mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu"</span>, alpha[z] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>beta[:,z].T).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb14-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>, dist.Normal(mu, sigma))</span>
<span id="cb14-25"></span>
<span id="cb14-26">mcmc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_inference(model2, random.PRNGKey(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>X, Z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>z, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y)</span>
<span id="cb14-27">idata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> az.from_numpyro(mcmc)</span>
<span id="cb14-28">print_site_dims(idata)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>alpha: ('chain', 'draw', 'alpha_dim_0')
beta: ('chain', 'draw', 'beta_dim_0', 'beta_dim_1')
mu: ('chain', 'draw', 'mu_dim_0')</code></pre>
</div>
</div>
<div id="36613fa9" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">model2_relations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> inspect.get_model_relations(model2, model_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>X, Z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>z, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y))</span>
<span id="cb16-2">model2_relations</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>{'sample_sample': {'alpha': [],
  'sigma': [],
  'beta': [],
  'mu': ['alpha', 'beta'],
  'y': ['sigma', 'mu']},
 'sample_param': {'alpha': [], 'sigma': [], 'beta': [], 'mu': [], 'y': []},
 'sample_dist': {'alpha': 'Normal',
  'sigma': 'HalfNormal',
  'beta': 'Normal',
  'mu': 'Deterministic',
  'y': 'Normal'},
 'param_constraint': {},
 'plate_sample': {'features': ['beta'],
  'Z': ['alpha', 'beta'],
  'obs_id': ['mu', 'y']},
 'observed': []}</code></pre>
</div>
</div>
<p>This is tricky. Beta should have dims (chain, draw, features, Z), but how do we know the plate_sample dictionary will return the correct order? What happens if we reverse the plate order?</p>
<div id="b18c9531" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> model2_reversed(</span>
<span id="cb18-2">    X: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs features"</span>], </span>
<span id="cb18-3">    Z: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" obs"</span>], </span>
<span id="cb18-4">    y: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" obs"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb18-5">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" obs"</span>]:</span>
<span id="cb18-6"></span>
<span id="cb18-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># reversed the plates</span></span>
<span id="cb18-8">    feature_plate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features"</span>, X.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb18-9">    group_plate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Z"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(np.unique(Z)), dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb18-10">    </span>
<span id="cb18-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> group_plate:</span>
<span id="cb18-12">        alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alpha"</span>, dist.Normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb18-13"></span>
<span id="cb18-14">    sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma"</span>, dist.HalfNormal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb18-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> feature_plate, group_plate:</span>
<span id="cb18-16">        beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>, dist.Normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb18-17"></span>
<span id="cb18-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs_id"</span>, X.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]):</span>
<span id="cb18-19">        mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu"</span>, alpha[z].squeeze(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>beta[z]).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb18-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>, dist.Normal(mu, sigma))</span>
<span id="cb18-21"></span>
<span id="cb18-22">mcmc_reversed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_inference(model2_reversed, random.PRNGKey(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>X, Z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>z, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y)</span></code></pre></div>
</details>
</div>
<div id="fe5525c9" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">model2_reversed_relations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> inspect.get_model_relations(model2_reversed, model_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>X, Z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>z, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y))</span>
<span id="cb19-2"></span>
<span id="cb19-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(model2_relations[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plate_sample'</span>])</span>
<span id="cb19-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(model2_reversed_relations[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plate_sample'</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'features': ['beta'], 'Z': ['alpha', 'beta'], 'obs_id': ['mu', 'y']}
{'features': ['beta'], 'Z': ['alpha', 'beta'], 'obs_id': ['mu', 'y']}</code></pre>
</div>
</div>
<p>This is bad news - looking at the plate_samples’s above, we see the same result despite the plates having different dims. This approach isn’t going to maintain the plate order, so we’ll end up mislabelling dims in our previous approach.</p>
</section>
<section id="finding-better-plate-metadata" class="level2">
<h2 class="anchored" data-anchor-id="finding-better-plate-metadata">Finding better plate metadata</h2>
<p>I took a closer look at the <a href="https://github.com/pyro-ppl/numpyro/blob/aa829fb85c79bc0dee1c897ec82469aa20b555bb/numpyro/infer/inspect.py#L337"><code>get_model_relations</code></a> function and it looks like this is where they’re pulling plate information</p>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_model_relations(model, model_args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, model_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb21-2">    ...</span>
<span id="cb21-3"></span>
<span id="cb21-4">    sample_plates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb21-5">        name: [frame.name <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> frame <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cond_indep_stack"</span>]]</span>
<span id="cb21-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> name, site <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> trace.items()</span>
<span id="cb21-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deterministic"</span>]</span>
<span id="cb21-8">    }</span>
<span id="cb21-9"></span>
<span id="cb21-10">    ...</span></code></pre></div>
<p>I’m going to try and see what other information is in there by copying their approach of pulling a model trace. Some helper functions are hidden in the code-fold below</p>
<div id="4447506c" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> functools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> partial</span>
<span id="cb22-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpyro <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> handlers</span>
<span id="cb22-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpyro.infer.initialization <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> init_to_sample</span>
<span id="cb22-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpyro.ops.pytree <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PytreeTrace</span>
<span id="cb22-5"></span>
<span id="cb22-6">model_kwargs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>X, Z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>z, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y)</span>
<span id="cb22-7"></span>
<span id="cb22-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _get_dist_name(fn):</span>
<span id="cb22-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(</span>
<span id="cb22-10">        fn, (dist.Independent, dist.ExpandedDistribution, dist.MaskedDistribution)</span>
<span id="cb22-11">    ):</span>
<span id="cb22-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _get_dist_name(fn.base_dist)</span>
<span id="cb22-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(fn).<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span></span>
<span id="cb22-14"></span>
<span id="cb22-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_trace(model, model_kwargs):</span>
<span id="cb22-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We use `init_to_sample` to get around ImproperUniform distribution,</span></span>
<span id="cb22-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># which does not have `sample` method.</span></span>
<span id="cb22-18">    subs_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> handlers.substitute(</span>
<span id="cb22-19">        handlers.seed(model, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb22-20">        substitute_fn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>init_to_sample,</span>
<span id="cb22-21">    )</span>
<span id="cb22-22">    trace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> handlers.trace(subs_model).get_trace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>model_kwargs)</span>
<span id="cb22-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Work around an issue where jax.eval_shape does not work</span></span>
<span id="cb22-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for distribution output (e.g. the function `lambda: dist.Normal(0, 1)`)</span></span>
<span id="cb22-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Here we will remove `fn` and store its name in the trace.</span></span>
<span id="cb22-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> name, site <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> trace.items():</span>
<span id="cb22-27">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample"</span>:</span>
<span id="cb22-28">            site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fn_name"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _get_dist_name(site.pop(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fn"</span>))</span>
<span id="cb22-29">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deterministic"</span>:</span>
<span id="cb22-30">            site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fn_name"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Deterministic"</span></span>
<span id="cb22-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> PytreeTrace(trace)</span></code></pre></div>
</details>
</div>
<div id="3ad9e3ac" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">trace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jax.eval_shape(partial(get_trace, model2, model_kwargs)).trace</span>
<span id="cb23-2">trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'beta'</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>{'args': (),
 'intermediates': [],
 'value': ShapeDtypeStruct(shape=(3, 10), dtype=float32),
 '_control_flow_done': True,
 'type': 'sample',
 'name': 'beta',
 'kwargs': {'rng_key': None, 'sample_shape': ()},
 'scale': None,
 'is_observed': False,
 'cond_indep_stack': [CondIndepStackFrame(name='features', dim=-2, size=3),
  CondIndepStackFrame(name='Z', dim=-1, size=10)],
 'infer': {},
 'fn_name': 'Normal'}</code></pre>
</div>
</div>
<p>This is perfect! For each site, we can see the plates they are nested within and the dimensions of those plates.</p>
<p>We also see for the reversed model, the order of the plates and the dim values follow a consistent pattern.</p>
<div id="1cea2dc4" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">trace_reversed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jax.eval_shape(partial(get_trace, model2_reversed, model_kwargs)).trace</span>
<span id="cb25-2">trace_reversed[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'beta'</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>{'args': (),
 'intermediates': [],
 'value': ShapeDtypeStruct(shape=(10, 3), dtype=float32),
 '_control_flow_done': True,
 'type': 'sample',
 'name': 'beta',
 'kwargs': {'rng_key': None, 'sample_shape': ()},
 'scale': None,
 'is_observed': False,
 'cond_indep_stack': [CondIndepStackFrame(name='Z', dim=-2, size=10),
  CondIndepStackFrame(name='features', dim=-1, size=3)],
 'infer': {},
 'fn_name': 'Normal'}</code></pre>
</div>
</div>
<p>We should be able to make a working dims mapping from this for each site in our model.</p>
<p>It turns out that they already do this for us on <a href="https://github.com/pyro-ppl/numpyro/blob/aa829fb85c79bc0dee1c897ec82469aa20b555bb/numpyro/infer/inspect.py#L337">L337</a></p>
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">sample_plates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb27-2">    name: [frame.name <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> frame <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cond_indep_stack"</span>]]</span>
<span id="cb27-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> name, site <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> trace.items()</span>
<span id="cb27-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deterministic"</span>]</span>
<span id="cb27-5">}</span></code></pre></div>
<p>The working implementation is below (but could probably be cleaned up)</p>
<div id="639d10a8" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_site_dims(model: Callable, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb28-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _get_dist_name(fn):</span>
<span id="cb28-3">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(</span>
<span id="cb28-4">            fn, (dist.Independent, dist.ExpandedDistribution, dist.MaskedDistribution)</span>
<span id="cb28-5">        ):</span>
<span id="cb28-6">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _get_dist_name(fn.base_dist)</span>
<span id="cb28-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(fn).<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span></span>
<span id="cb28-8"></span>
<span id="cb28-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_trace():</span>
<span id="cb28-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We use `init_to_sample` to get around ImproperUniform distribution,</span></span>
<span id="cb28-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># which does not have `sample` method.</span></span>
<span id="cb28-12">        subs_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> handlers.substitute(</span>
<span id="cb28-13">            handlers.seed(model, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb28-14">            substitute_fn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>init_to_sample,</span>
<span id="cb28-15">        )</span>
<span id="cb28-16">        trace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> handlers.trace(subs_model).get_trace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb28-17">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Work around an issue where jax.eval_shape does not work</span></span>
<span id="cb28-18">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for distribution output (e.g. the function `lambda: dist.Normal(0, 1)`)</span></span>
<span id="cb28-19">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Here we will remove `fn` and store its name in the trace.</span></span>
<span id="cb28-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> name, site <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> trace.items():</span>
<span id="cb28-21">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample"</span>:</span>
<span id="cb28-22">                site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fn_name"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _get_dist_name(site.pop(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fn"</span>))</span>
<span id="cb28-23">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deterministic"</span>:</span>
<span id="cb28-24">                site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fn_name"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Deterministic"</span></span>
<span id="cb28-25">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> PytreeTrace(trace)</span>
<span id="cb28-26"></span>
<span id="cb28-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We use eval_shape to avoid any array computation.</span></span>
<span id="cb28-28">    trace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jax.eval_shape(get_trace).trace</span>
<span id="cb28-29">    sample_plates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb28-30">        name: [frame.name <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> frame <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cond_indep_stack"</span>]]</span>
<span id="cb28-31">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> name, site <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> trace.items()</span>
<span id="cb28-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deterministic"</span>]</span>
<span id="cb28-33">    }</span>
<span id="cb28-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {k:v <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k,v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_plates.items() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(v) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}</span>
<span id="cb28-35"></span>
<span id="cb28-36"></span>
<span id="cb28-37">idata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> az.from_numpyro(</span>
<span id="cb28-38">    mcmc,</span>
<span id="cb28-39">    dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>get_site_dims(model2, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>model_kwargs),</span>
<span id="cb28-40">    coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>coords</span>
<span id="cb28-41">)</span>
<span id="cb28-42"></span>
<span id="cb28-43">print_site_dims(idata)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>alpha: ('chain', 'draw', 'Z')
beta: ('chain', 'draw', 'features', 'Z')
mu: ('chain', 'draw', 'obs_id')</code></pre>
</div>
</div>
</section>
</section>
<section id="part-3-what-happens-with-the-zerosumnormal-distribution" class="level1">
<h1>Part 3: What happens with the ZeroSumNormal distribution</h1>
<section id="a-quick-tangent-on-tensor-shapes-and-why-the-zerosumnormal-is-different" class="level2">
<h2 class="anchored" data-anchor-id="a-quick-tangent-on-tensor-shapes-and-why-the-zerosumnormal-is-different">A quick tangent on tensor shapes and why the ZeroSumNormal is different</h2>
<p>I recently ported the ZeroSumNormal distribution from <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.ZeroSumNormal.html">PyMC</a> to numpyro and it follows some different conventions than the typical distribution.</p>
<p>To understand it, you probably need to have some background on tensor shapes - theres a great blog from <a href="https://ericmjl.github.io/blog/2019/5/29/reasoning-about-shapes-and-probability-distributions/">Eric Ma here</a>.</p>
<p>Typically in numpyro, when we put a sample site within a plate, the <strong>batch shape</strong> is determined by the plates. The batch shape is independent, but not identically distributed across dimensions. For instance in our previous alpha parameter we had 10 groups we stratified it by - we’re getting independent draws for alpha for each group.</p>
<p>The ZeroSumNormal instead works by using an event shape instead of a batch shape. Event shapes often have some dependency across dimensions, and in this case the zero sum constraint creates some dependency across the dimensions.</p>
<p>While we typically might define a categorical parameter like this in numpyro:</p>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>, n_groups):</span>
<span id="cb30-2">    gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>, dist.Normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
<p>with the ZeroSumNormal we define categorical parameters like this:</p>
<div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>, dist.ZeroSumNormal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, event_shape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(n_groups,)))</span></code></pre></div>
<p>We need to figure out how to have dims mapped for the ZeroSumNormal despite it not using a plate. The first test will be seeing what happens when we do nest it under a plate</p>
<div id="54951699" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> test_model():</span>
<span id="cb32-2">    n_groups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb32-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>, n_groups):</span>
<span id="cb32-4">        gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>, dist.ZeroSumNormal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, event_shape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(n_groups,)))</span>
<span id="cb32-5"></span>
<span id="cb32-6">mcmc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_inference(test_model, random.PRNGKey(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), num_chains<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb32-7">mcmc.get_samples()[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gamma'</span>].shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>(50, 10, 10)</code></pre>
</div>
</div>
<p>It looks like this unfortunately doesnt work, it creates a batch_shape=10, event_shape=10 when we only want the event_shape in this case.</p>
</section>
<section id="a-custom-primitive-for-labelling-event-dims" class="level2">
<h2 class="anchored" data-anchor-id="a-custom-primitive-for-labelling-event-dims">A custom primitive for labelling event dims</h2>
<p>This is going to be a problem that I’m not sure is solve-able with the current tools. But what if we could create a primitive that could save dim names for us in the trace without actually doing anything? ie</p>
<div class="sourceCode" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># option 1</span></span>
<span id="cb34-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> pseudo_plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>, n_groups):</span>
<span id="cb34-3">    gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>, dist.ZeroSumNormal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, event_shape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(n_groups,)))</span>
<span id="cb34-4"></span>
<span id="cb34-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># option 2</span></span>
<span id="cb34-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> site_labeller(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>):</span>
<span id="cb34-7">    gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>, dist.ZeroSumNormal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, event_shape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(n_groups,)))</span></code></pre></div>
<p>The main idea is that we could store information thats retrieavable in the trace, mimicking plates but without actually expanding the parameter shape like a plate would</p>
<p>Below is an implementation and a quick test model to make sure it has the correct shape saved</p>
<div id="19872d17" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpyro.primitives <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Messenger, Message, CondIndepStackFrame</span>
<span id="cb35-2"></span>
<span id="cb35-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> pseudo_plate(numpyro.plate):</span>
<span id="cb35-4">    </span>
<span id="cb35-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(</span>
<span id="cb35-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,</span>
<span id="cb35-7">        name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>,</span>
<span id="cb35-8">        size: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>,</span>
<span id="cb35-9">        subsample_size: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb35-10">        dim: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb35-11">    ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb35-12">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> name</span>
<span id="cb35-13">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size</span>
<span id="cb35-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> dim <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb35-15">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dim arg must be negative."</span>)</span>
<span id="cb35-16">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dim, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._subsample(</span>
<span id="cb35-17">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.size, subsample_size, dim</span>
<span id="cb35-18">        )</span>
<span id="cb35-19">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.subsample_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._indices.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb35-20"></span>
<span id="cb35-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We'll try only adding our pseudoplate to the CondIndepStack without doing anything else</span></span>
<span id="cb35-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> process_message(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, msg: Message) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb35-23">        cond_indep_stack: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[CondIndepStackFrame] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cond_indep_stack"</span>]</span>
<span id="cb35-24">        frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CondIndepStackFrame(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dim, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.subsample_size)</span>
<span id="cb35-25">        cond_indep_stack.append(frame)</span>
<span id="cb35-26"></span>
<span id="cb35-27"></span>
<span id="cb35-28"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> test_model():</span>
<span id="cb35-29">    n_groups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb35-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> pseudo_plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>):</span>
<span id="cb35-31">        gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>, dist.ZeroSumNormal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, event_shape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(n_groups,)))</span>
<span id="cb35-32"></span>
<span id="cb35-33">mcmc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_inference(test_model, random.PRNGKey(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), num_chains<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb35-34">mcmc.get_samples()[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gamma'</span>].shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>(50, 10)</code></pre>
</div>
</div>
<p>As we can see above, we got the correct shape for gamma. Lets see if this works in a model</p>
<div id="dac2476d" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> model3(</span>
<span id="cb37-2">    X: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs features"</span>], </span>
<span id="cb37-3">    Z: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" obs"</span>], </span>
<span id="cb37-4">    y: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" obs"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb37-5">    try_pseudo_plate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb37-6">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" obs"</span>]:</span>
<span id="cb37-7"></span>
<span id="cb37-8">    feature_plate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features"</span>, X.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb37-9">    group_plate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Z"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(np.unique(Z)), dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb37-10">    </span>
<span id="cb37-11">    alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alpha"</span>, dist.Normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb37-12">    sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma"</span>, dist.HalfNormal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb37-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> group_plate, feature_plate:</span>
<span id="cb37-14">        beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>, dist.Normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb37-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> try_pseudo_plate:</span>
<span id="cb37-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> pseudo_plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>):</span>
<span id="cb37-17">            gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>, dist.ZeroSumNormal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, event_shape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(group_plate.size,)))</span>
<span id="cb37-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb37-19">        gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>, dist.ZeroSumNormal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, event_shape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(group_plate.size,)))</span>
<span id="cb37-20"></span>
<span id="cb37-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs_id"</span>, X.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]):</span>
<span id="cb37-22">        mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu"</span>, alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> gamma[z] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>beta[:,z].T).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb37-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>, dist.Normal(mu, sigma), obs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y)</span>
<span id="cb37-24"></span>
<span id="cb37-25">mcmc_zsn_pseudoplate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_inference(model3, random.PRNGKey(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), num_chains<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, num_warmup<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>model_kwargs)</span>
<span id="cb37-26">idata_zsn_pseudoplate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> az.from_numpyro(</span>
<span id="cb37-27">    mcmc_zsn_pseudoplate,</span>
<span id="cb37-28">    dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>get_site_dims(model3, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>model_kwargs),</span>
<span id="cb37-29">    coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>coords</span>
<span id="cb37-30">)</span>
<span id="cb37-31"></span>
<span id="cb37-32">print_site_dims(idata_zsn_pseudoplate, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">vars</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alpha'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'beta'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gamma'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mu'</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>alpha: ('chain', 'draw')
beta: ('chain', 'draw', 'features', 'Z')
gamma: ('chain', 'draw', 'groups')
mu: ('chain', 'draw', 'obs_id')</code></pre>
</div>
</div>
<p>This seemed to work! But are there any unintended consequences of having another “plate” in the <code>CondIndepStack</code>? Lets fit a second version of the model without the pseudo_plate and see if they return similar results</p>
<div id="beaa8c2b" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">mcmc_zsn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_inference(model3, random.PRNGKey(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), num_chains<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, num_warmup<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>model_kwargs, try_pseudo_plate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
</div>
<p>We’ll check that parameter estimation for the site is the same</p>
<div id="e08aaadd" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb40-2">az.plot_forest(</span>
<span id="cb40-3">    [mcmc_zsn_pseudoplate, mcmc_zsn],</span>
<span id="cb40-4">    model_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'With Pseudo Plate'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Without Pseudo Plate'</span>],</span>
<span id="cb40-5">     var_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gamma'</span>]</span>
<span id="cb40-6">)</span>
<span id="cb40-7">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma Estimates Across both Models"</span>)</span>
<span id="cb40-8">plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/numpyro_dim_labelling/2025-02-23-numpyro-dim_labels_files/figure-html/cell-20-output-1.png" width="572" height="732" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>And more importantly, we’ll make sure this doesnt impact the final likelihood estimate</p>
<div id="68b8377f" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1">idata_zsn_pseudoplate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> az.from_numpyro(mcmc_zsn_pseudoplate)</span>
<span id="cb41-2">idata_zsn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> az.from_numpyro(mcmc_zsn)</span>
<span id="cb41-3"></span>
<span id="cb41-4">delta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> idata_zsn.log_likelihood[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> idata_zsn_pseudoplate.log_likelihood[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>]</span>
<span id="cb41-5"></span>
<span id="cb41-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Difference in Log Likelihood with and without the pseudoplate:"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(delta.mean()))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Difference in Log Likelihood with and without the pseudoplate: 0.0</code></pre>
</div>
</div>
<p>I’m a bit shocked to say that this works so far.</p>
</section>
<section id="another-edge-case-both-batch-and-event-dims" class="level2">
<h2 class="anchored" data-anchor-id="another-edge-case-both-batch-and-event-dims">Another edge case: both batch and event dims</h2>
<p>Next we need to make sure it works if we also have a batch dimension</p>
<div id="d7317474" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> test_model_batches():</span>
<span id="cb43-2">    n_groups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb43-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> pseudo_plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>, n_groups), numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"batches"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>):</span>
<span id="cb43-4">        gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>, dist.ZeroSumNormal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, event_shape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(n_groups,)))</span>
<span id="cb43-5"></span>
<span id="cb43-6">trace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jax.eval_shape(partial(get_trace, test_model_batches, model_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{})).trace</span>
<span id="cb43-7">trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gamma'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>ShapeDtypeStruct(shape=(3, 1, 10), dtype=float32)</code></pre>
</div>
</div>
<p>Sadly this didnt quite work - it seems like the dim-handling isn’t working as we want it to because the batch shape is (3,1) instead of just (3,) - this is because of the way we aranged the plates, we put the batches in the position of dim=-2. Lets look at the trace</p>
<div id="26fb0641" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1">trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gamma'</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>{'args': (),
 'intermediates': [],
 'value': ShapeDtypeStruct(shape=(3, 1, 10), dtype=float32),
 '_control_flow_done': True,
 'type': 'sample',
 'name': 'gamma',
 'kwargs': {'rng_key': None, 'sample_shape': ()},
 'scale': None,
 'is_observed': False,
 'cond_indep_stack': [CondIndepStackFrame(name='batches', dim=-2, size=3),
  CondIndepStackFrame(name='groups', dim=-1, size=10)],
 'infer': {},
 'fn_name': 'ZeroSumNormal'}</code></pre>
</div>
</div>
</section>
<section id="improving-the-primitive-to-store-new-metadata" class="level2">
<h2 class="anchored" data-anchor-id="improving-the-primitive-to-store-new-metadata">Improving the primitive to store new metadata</h2>
<p>Taking a step back, it’s clear I thought about this wrong - the Conditional Indepdence Stack is for batch dimensions that are conditionally independent, and by putting our pseudoplate in there, we’re messing with how the batch dimensions are arranged.</p>
<p>It’s also hard to follow exactly how the conditional indepence stack is used throughout the code, and if that will have any unexpected consequences.</p>
<p>I’m going to try something new - lets make a new primitive that creates a <code>dep_stack</code> and we’ll put the pseudo plates in there and see if it fixes things. This is going to get even more ugly so I’m hiding the implementation below in a code fold</p>
<div id="4b1072e7" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Tuple</span>
<span id="cb47-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> namedtuple</span>
<span id="cb47-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpyro</span>
<span id="cb47-4"></span>
<span id="cb47-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpyro.primitives <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Messenger, Message, apply_stack, _subsample_fn</span>
<span id="cb47-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpyro.util <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> find_stack_level</span>
<span id="cb47-7"></span>
<span id="cb47-8">DepStackFrame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> namedtuple(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DepStackFrame"</span>, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dim"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"size"</span>])</span>
<span id="cb47-9"></span>
<span id="cb47-10"></span>
<span id="cb47-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> pseudo_plate(numpyro.plate):</span>
<span id="cb47-12">    </span>
<span id="cb47-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(</span>
<span id="cb47-14">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,</span>
<span id="cb47-15">        name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>,</span>
<span id="cb47-16">        size: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>,</span>
<span id="cb47-17">        subsample_size: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb47-18">        dim: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb47-19">    ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb47-20">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> name</span>
<span id="cb47-21">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size</span>
<span id="cb47-22">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> dim <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb47-23">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dim arg must be negative."</span>)</span>
<span id="cb47-24">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dim, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._subsample(</span>
<span id="cb47-25">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.size, subsample_size, dim</span>
<span id="cb47-26">        )</span>
<span id="cb47-27">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.subsample_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._indices.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb47-28"></span>
<span id="cb47-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We'll try only adding our pseudoplate to the CondIndepStack without doing anything else</span></span>
<span id="cb47-30">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> process_message(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, msg: Message) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb47-31">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"param"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plate"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deterministic"</span>):</span>
<span id="cb47-32">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control_flow"</span>:</span>
<span id="cb47-33">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">NotImplementedError</span>(</span>
<span id="cb47-34">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cannot use control flow primitive under a `plate` primitive."</span></span>
<span id="cb47-35">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" Please move those `plate` statements into the control flow"</span></span>
<span id="cb47-36">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" body function. See `scan` documentation for more information."</span></span>
<span id="cb47-37">                )</span>
<span id="cb47-38">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span></span>
<span id="cb47-39"></span>
<span id="cb47-40">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (</span>
<span id="cb47-41">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"block_plates"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> msg.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"infer"</span>, {})</span>
<span id="cb47-42">            <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"infer"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"block_plates"</span>]</span>
<span id="cb47-43">        ):</span>
<span id="cb47-44">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span></span>
<span id="cb47-45">            </span>
<span id="cb47-46">        frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DepStackFrame(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dim, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.subsample_size)</span>
<span id="cb47-47">        msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_stack'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> msg.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_stack'</span>, []) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [frame]</span>
<span id="cb47-48"></span>
<span id="cb47-49">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _get_event_shape(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, dep_stack: List[DepStackFrame]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Tuple[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>]:</span>
<span id="cb47-50">        n_dims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>f.dim <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> f <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dep_stack)</span>
<span id="cb47-51">        event_shape <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n_dims</span>
<span id="cb47-52">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> f <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dep_stack:</span>
<span id="cb47-53">            event_shape[f.dim] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f.size</span>
<span id="cb47-54">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(event_shape)</span>
<span id="cb47-55"></span>
<span id="cb47-56">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We need to make sure dims get aranged properly when there are multiple plates</span></span>
<span id="cb47-57">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@staticmethod</span></span>
<span id="cb47-58">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _subsample(name, size, subsample_size, dim):</span>
<span id="cb47-59">        msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb47-60">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plate"</span>,</span>
<span id="cb47-61">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fn"</span>: _subsample_fn,</span>
<span id="cb47-62">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: name,</span>
<span id="cb47-63">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"args"</span>: (size, subsample_size),</span>
<span id="cb47-64">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kwargs"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rng_key"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>},</span>
<span id="cb47-65">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>: (</span>
<span id="cb47-66">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb47-67">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (subsample_size <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> subsample_size)</span>
<span id="cb47-68">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> jnp.arange(size)</span>
<span id="cb47-69">            ),</span>
<span id="cb47-70">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,</span>
<span id="cb47-71">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cond_indep_stack"</span>: [],</span>
<span id="cb47-72">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dep_stack"</span>: [],</span>
<span id="cb47-73">        }</span>
<span id="cb47-74">        apply_stack(msg)</span>
<span id="cb47-75">        subsample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>]</span>
<span id="cb47-76">        subsample_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"args"</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb47-77">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> subsample_size <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> subsample_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> subsample.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]:</span>
<span id="cb47-78">            warnings.warn(</span>
<span id="cb47-79">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"subsample_size does not match len(subsample), </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> vs </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(</span>
<span id="cb47-80">                    subsample_size, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(subsample)</span>
<span id="cb47-81">                )</span>
<span id="cb47-82">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" Did you accidentally use different subsample_size in the model and guide?"</span>,</span>
<span id="cb47-83">                stacklevel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>find_stack_level(),</span>
<span id="cb47-84">            )</span>
<span id="cb47-85">        dep_stack <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dep_stack"</span>]</span>
<span id="cb47-86">        occupied_dims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {f.dim <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> f <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dep_stack}</span>
<span id="cb47-87">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> dim <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb47-88">            new_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb47-89">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> new_dim <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> occupied_dims:</span>
<span id="cb47-90">                new_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb47-91">            dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_dim</span>
<span id="cb47-92">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb47-93">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> dim <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> occupied_dims</span>
<span id="cb47-94">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> dim, subsample</span></code></pre></div>
</details>
</div>
<p>Note that I’m copying alot of the code above directly from the <code>plate</code> <a href="https://github.com/pyro-ppl/numpyro/blob/627d19a8e01e3d1b6c7a594ef7f49face4921f92/numpyro/primitives.py#L467">primitive</a>.</p>
<div id="36e2fbe1" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> test_model_batches():</span>
<span id="cb48-2">    n_groups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb48-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> pseudo_plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"groups"</span>, n_groups), numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"batches"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>):</span>
<span id="cb48-4">        gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>, dist.ZeroSumNormal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, event_shape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(n_groups,)))</span>
<span id="cb48-5"></span>
<span id="cb48-6"></span>
<span id="cb48-7">trace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jax.eval_shape(partial(get_trace, test_model_batches, model_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{})).trace</span>
<span id="cb48-8">trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gamma'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>ShapeDtypeStruct(shape=(3, 10), dtype=float32)</code></pre>
</div>
</div>
<p>Perfect this now works, we just need to combine our two plate stacks!</p>
<div id="52c1b302" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1">trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gamma'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cond_indep_stack'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gamma'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_stack'</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>[CondIndepStackFrame(name='batches', dim=-1, size=3),
 DepStackFrame(name='groups', dim=-1, size=10)]</code></pre>
</div>
</div>
</section>
</section>
<section id="part-4-the-resulting-implementation" class="level1">
<h1>Part 4: The resulting implementation</h1>
<p>Finally, lets bring this altogether. In the code-fold below is all of the needed functions in one place, but they really need to be cleaned up.</p>
<div id="f157ec8c" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Tuple, Any, Optional, List, Dict, Callable</span>
<span id="cb52-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> namedtuple</span>
<span id="cb52-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpy.typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ArrayLike</span>
<span id="cb52-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> functools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> partial</span>
<span id="cb52-5"></span>
<span id="cb52-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb52-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpyro</span>
<span id="cb52-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpyro <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> distributions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> dist</span>
<span id="cb52-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpyro <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> handlers</span>
<span id="cb52-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpyro.primitives <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Messenger, apply_stack, _subsample_fn</span>
<span id="cb52-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpyro.util <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> find_stack_level</span>
<span id="cb52-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpyro.infer <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> NUTS, MCMC</span>
<span id="cb52-13"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpyro.infer.initialization <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> init_to_sample</span>
<span id="cb52-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpyro.ops.pytree <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PytreeTrace</span>
<span id="cb52-15"></span>
<span id="cb52-16"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jax</span>
<span id="cb52-17"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> jax <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb52-18"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jax.numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> jnp</span>
<span id="cb52-19"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> jaxtyping <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Float, Array, Int</span>
<span id="cb52-20"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> arviz <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> az</span>
<span id="cb52-21"></span>
<span id="cb52-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># #######################</span></span>
<span id="cb52-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Code for pseudo_plate</span></span>
<span id="cb52-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># #######################</span></span>
<span id="cb52-25">Message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, Any]</span>
<span id="cb52-26"></span>
<span id="cb52-27">DepStackFrame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> namedtuple(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DepStackFrame"</span>, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dim"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"size"</span>])</span>
<span id="cb52-28"></span>
<span id="cb52-29"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> pseudo_plate(numpyro.plate):</span>
<span id="cb52-30">    </span>
<span id="cb52-31">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(</span>
<span id="cb52-32">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,</span>
<span id="cb52-33">        name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>,</span>
<span id="cb52-34">        size: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>,</span>
<span id="cb52-35">        subsample_size: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb52-36">        dim: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb52-37">    ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb52-38">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> name</span>
<span id="cb52-39">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size</span>
<span id="cb52-40">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> dim <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb52-41">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dim arg must be negative."</span>)</span>
<span id="cb52-42">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dim, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._subsample(</span>
<span id="cb52-43">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.size, subsample_size, dim</span>
<span id="cb52-44">        )</span>
<span id="cb52-45">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.subsample_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._indices.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb52-46"></span>
<span id="cb52-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We'll try only adding our pseudoplate to the CondIndepStack without doing anything else</span></span>
<span id="cb52-48">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> process_message(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, msg: Message) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb52-49">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"param"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plate"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deterministic"</span>):</span>
<span id="cb52-50">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control_flow"</span>:</span>
<span id="cb52-51">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">NotImplementedError</span>(</span>
<span id="cb52-52">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cannot use control flow primitive under a `plate` primitive."</span></span>
<span id="cb52-53">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" Please move those `plate` statements into the control flow"</span></span>
<span id="cb52-54">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" body function. See `scan` documentation for more information."</span></span>
<span id="cb52-55">                )</span>
<span id="cb52-56">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span></span>
<span id="cb52-57"></span>
<span id="cb52-58">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (</span>
<span id="cb52-59">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"block_plates"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> msg.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"infer"</span>, {})</span>
<span id="cb52-60">            <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"infer"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"block_plates"</span>]</span>
<span id="cb52-61">        ):</span>
<span id="cb52-62">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span></span>
<span id="cb52-63">            </span>
<span id="cb52-64">        frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DepStackFrame(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dim, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.subsample_size)</span>
<span id="cb52-65">        msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_stack'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> msg.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_stack'</span>, []) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [frame]</span>
<span id="cb52-66"></span>
<span id="cb52-67">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deterministic"</span>:</span>
<span id="cb52-68">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span></span>
<span id="cb52-69"></span>
<span id="cb52-70">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _get_event_shape(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, dep_stack: List[DepStackFrame]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Tuple[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>]:</span>
<span id="cb52-71">        n_dims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>f.dim <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> f <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dep_stack)</span>
<span id="cb52-72">        event_shape <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n_dims</span>
<span id="cb52-73">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> f <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dep_stack:</span>
<span id="cb52-74">            event_shape[f.dim] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f.size</span>
<span id="cb52-75">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(event_shape)</span>
<span id="cb52-76"></span>
<span id="cb52-77">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We need to make sure dims get aranged properly when there are multiple plates</span></span>
<span id="cb52-78">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@staticmethod</span></span>
<span id="cb52-79">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _subsample(name, size, subsample_size, dim):</span>
<span id="cb52-80">        msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb52-81">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plate"</span>,</span>
<span id="cb52-82">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fn"</span>: _subsample_fn,</span>
<span id="cb52-83">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: name,</span>
<span id="cb52-84">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"args"</span>: (size, subsample_size),</span>
<span id="cb52-85">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kwargs"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rng_key"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>},</span>
<span id="cb52-86">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>: (</span>
<span id="cb52-87">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb52-88">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (subsample_size <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> subsample_size)</span>
<span id="cb52-89">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> jnp.arange(size)</span>
<span id="cb52-90">            ),</span>
<span id="cb52-91">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,</span>
<span id="cb52-92">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cond_indep_stack"</span>: [],</span>
<span id="cb52-93">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dep_stack"</span>: [],</span>
<span id="cb52-94">        }</span>
<span id="cb52-95">        apply_stack(msg)</span>
<span id="cb52-96">        subsample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>]</span>
<span id="cb52-97">        subsample_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"args"</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb52-98">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> subsample_size <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> subsample_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> subsample.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]:</span>
<span id="cb52-99">            warnings.warn(</span>
<span id="cb52-100">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"subsample_size does not match len(subsample), </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> vs </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(</span>
<span id="cb52-101">                    subsample_size, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(subsample)</span>
<span id="cb52-102">                )</span>
<span id="cb52-103">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" Did you accidentally use different subsample_size in the model and guide?"</span>,</span>
<span id="cb52-104">                stacklevel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>find_stack_level(),</span>
<span id="cb52-105">            )</span>
<span id="cb52-106">        dep_stack <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> msg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dep_stack"</span>]</span>
<span id="cb52-107">        occupied_dims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {f.dim <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> f <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dep_stack}</span>
<span id="cb52-108">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> dim <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb52-109">            new_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb52-110">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> new_dim <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> occupied_dims:</span>
<span id="cb52-111">                new_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb52-112">            dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_dim</span>
<span id="cb52-113">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb52-114">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> dim <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> occupied_dims</span>
<span id="cb52-115">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> dim, subsample</span>
<span id="cb52-116"></span>
<span id="cb52-117"></span>
<span id="cb52-118"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># #######################</span></span>
<span id="cb52-119"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Code for pulling dims</span></span>
<span id="cb52-120"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># #######################</span></span>
<span id="cb52-121"></span>
<span id="cb52-122"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_site_dims(model: Callable, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb52-123">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _get_dist_name(fn):</span>
<span id="cb52-124">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(</span>
<span id="cb52-125">            fn, (dist.Independent, dist.ExpandedDistribution, dist.MaskedDistribution)</span>
<span id="cb52-126">        ):</span>
<span id="cb52-127">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _get_dist_name(fn.base_dist)</span>
<span id="cb52-128">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(fn).<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span></span>
<span id="cb52-129"></span>
<span id="cb52-130">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_trace():</span>
<span id="cb52-131">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We use `init_to_sample` to get around ImproperUniform distribution,</span></span>
<span id="cb52-132">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># which does not have `sample` method.</span></span>
<span id="cb52-133">        subs_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> handlers.substitute(</span>
<span id="cb52-134">            handlers.seed(model, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb52-135">            substitute_fn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>init_to_sample,</span>
<span id="cb52-136">        )</span>
<span id="cb52-137">        trace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> handlers.trace(subs_model).get_trace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb52-138">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Work around an issue where jax.eval_shape does not work</span></span>
<span id="cb52-139">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for distribution output (e.g. the function `lambda: dist.Normal(0, 1)`)</span></span>
<span id="cb52-140">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Here we will remove `fn` and store its name in the trace.</span></span>
<span id="cb52-141">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> name, site <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> trace.items():</span>
<span id="cb52-142">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample"</span>:</span>
<span id="cb52-143">                site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fn_name"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _get_dist_name(site.pop(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fn"</span>))</span>
<span id="cb52-144">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deterministic"</span>:</span>
<span id="cb52-145">                site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fn_name"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Deterministic"</span></span>
<span id="cb52-146">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> PytreeTrace(trace)</span>
<span id="cb52-147"></span>
<span id="cb52-148">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We use eval_shape to avoid any array computation.</span></span>
<span id="cb52-149">    trace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jax.eval_shape(get_trace).trace</span>
<span id="cb52-150"></span>
<span id="cb52-151">    sample_plates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb52-152">        name: [frame.name <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> frame <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cond_indep_stack"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> site.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dep_stack"</span>, [])]</span>
<span id="cb52-153">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> name, site <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> trace.items()</span>
<span id="cb52-154">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> site[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deterministic"</span>]</span>
<span id="cb52-155">    }</span>
<span id="cb52-156">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {k:v <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k,v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_plates.items() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(v) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}</span>
<span id="cb52-157"></span>
<span id="cb52-158"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># helper function</span></span>
<span id="cb52-159"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> print_site_dims(idata, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">vars</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alpha'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'beta'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mu'</span>]):</span>
<span id="cb52-160">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> var <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">vars</span>:</span>
<span id="cb52-161">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>var<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:"</span>, idata.posterior[var].dims )</span></code></pre></div>
</details>
</div>
<p>And the simulation code is underneath the following code-fold</p>
<div id="11da1e2e" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># #################</span></span>
<span id="cb53-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulation Code </span></span>
<span id="cb53-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># #################</span></span>
<span id="cb53-4"></span>
<span id="cb53-5">SEED: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span></span>
<span id="cb53-6">rng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.default_rng(SEED)</span>
<span id="cb53-7">N, n_feats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb53-8">z_cardinality <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb53-9"></span>
<span id="cb53-10">alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.3</span></span>
<span id="cb53-11">beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.normal(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_feats)</span>
<span id="cb53-12">gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.normal(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>z_cardinality)</span>
<span id="cb53-13">sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb53-14"></span>
<span id="cb53-15">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.normal(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(N, n_feats))</span>
<span id="cb53-16">z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.choice(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(z_cardinality), size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>N)</span>
<span id="cb53-17"></span>
<span id="cb53-18">mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> np.dot(X, beta) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> gamma[z]</span>
<span id="cb53-19">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.normal(mu, sigma)</span>
<span id="cb53-20"></span>
<span id="cb53-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># beta = rng.normal(size=(z_cardinality, n_feats))</span></span>
<span id="cb53-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># mu = alpha + (X * beta[z]).sum(-1) + gamma[z]</span></span>
<span id="cb53-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># y = rng.normal(mu, sigma)</span></span></code></pre></div>
</details>
</div>
<p>And finally here’s how we’d actually use all of these tools</p>
<div id="40624d88" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_inference(</span>
<span id="cb54-2">    model: Callable,</span>
<span id="cb54-3">    key: random.PRNGKey,</span>
<span id="cb54-4">    num_warmup: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, </span>
<span id="cb54-5">    num_chains: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, </span>
<span id="cb54-6">    num_samples: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="cb54-7">    coords: Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, ArrayLike] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb54-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs</span>
<span id="cb54-9">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Tuple[MCMC, az.InferenceData]:</span>
<span id="cb54-10"></span>
<span id="cb54-11">    kernel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> NUTS(model)</span>
<span id="cb54-12">    mcmc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MCMC(kernel, num_warmup<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_warmup, num_chains<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_chains, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_samples, progress_bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb54-13">    mcmc.run(key, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb54-14"></span>
<span id="cb54-15">    dims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_site_dims(model, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb54-16">    idata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> az.from_numpyro(mcmc, coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>coords, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dims)</span>
<span id="cb54-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> mcmc, idata</span>
<span id="cb54-18"></span>
<span id="cb54-19"></span>
<span id="cb54-20"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> model(</span>
<span id="cb54-21">    X: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs features"</span>], </span>
<span id="cb54-22">    Z: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" obs"</span>], </span>
<span id="cb54-23">    y: Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" obs"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb54-24">    try_pseudo_plate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb54-25">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Float[Array, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" obs"</span>]:</span>
<span id="cb54-26"></span>
<span id="cb54-27">    feature_plate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features"</span>, X.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb54-28">    group_plate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Z"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(np.unique(Z)), dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb54-29">    </span>
<span id="cb54-30">    alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alpha"</span>, dist.Normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb54-31">    sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma"</span>, dist.HalfNormal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb54-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> group_plate, feature_plate:</span>
<span id="cb54-33">        beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>, dist.Normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb54-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> pseudo_plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Z"</span>, group_plate.size):</span>
<span id="cb54-35">        gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>, dist.ZeroSumNormal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, event_shape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(group_plate.size,)))</span>
<span id="cb54-36"></span>
<span id="cb54-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs_id"</span>, X.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]):</span>
<span id="cb54-38">        mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu"</span>, alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> gamma[z] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>beta[:,z].T).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb54-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>, dist.Normal(mu, sigma), obs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y)</span>
<span id="cb54-40"></span>
<span id="cb54-41"></span>
<span id="cb54-42">coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb54-43">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Z"</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'F'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'G'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'H'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'I'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'J'</span>],</span>
<span id="cb54-44">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs_id"</span>: np.arange(N),</span>
<span id="cb54-45">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features"</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X2'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X3'</span>],</span>
<span id="cb54-46">}</span>
<span id="cb54-47">model_kwargs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>X, Z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>z, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y)</span>
<span id="cb54-48">mcmc, idata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_inference(model, random.PRNGKey(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>coords, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>model_kwargs)</span>
<span id="cb54-49">print_site_dims(idata, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">vars</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'beta'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gamma'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mu'</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>beta: ('chain', 'draw', 'features', 'Z')
gamma: ('chain', 'draw', 'Z')
mu: ('chain', 'draw', 'obs_id')</code></pre>
</div>
</div>
<p>We can see above that the dims are all properly labelled, and below we can see them properly mapped to the coords provided</p>
<div id="0b8df25a" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1">idata.posterior[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gamma'</span>].coords[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewbox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewbox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme="dark"],
html[data-theme="dark"],
body[data-theme="dark"],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1f1f1f;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 0 20px 0 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: inline-block;
  opacity: 0;
  height: 0;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:focus + label {
  border: 2px solid var(--xr-font-color0);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: "►";
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: "▼";
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: "(";
}

.xr-dim-list:after {
  content: ")";
}

.xr-dim-list li:not(:last-child):after {
  content: ",";
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class="xr-text-repr-fallback">&lt;xarray.DataArray 'Z' (Z: 10)&gt; Size: 40B
array(['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'], dtype='&lt;U1')
Coordinates:
  * Z        (Z) &lt;U1 40B 'A' 'B' 'C' 'D' 'E' 'F' 'G' 'H' 'I' 'J'</pre><div class="xr-wrap" style="display:none"><div class="xr-header"><div class="xr-obj-type">xarray.DataArray</div><div class="xr-array-name">'Z'</div><ul class="xr-dim-list"><li><span class="xr-has-index">Z</span>: 10</li></ul></div><ul class="xr-sections"><li class="xr-section-item"><div class="xr-array-wrap"><input id="section-4e959f6e-be89-4c61-85b6-256f3e3b28eb" class="xr-array-in" type="checkbox" checked=""><label for="section-4e959f6e-be89-4c61-85b6-256f3e3b28eb" title="Show/hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-array-preview xr-preview"><span>'A' 'B' 'C' 'D' 'E' 'F' 'G' 'H' 'I' 'J'</span></div><div class="xr-array-data"><pre>array(['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'], dtype='&lt;U1')</pre></div></div></li><li class="xr-section-item"><input id="section-cd580160-41f1-4a8e-afc6-6dc8440ac456" class="xr-section-summary-in" type="checkbox" checked=""><label for="section-cd580160-41f1-4a8e-afc6-6dc8440ac456" class="xr-section-summary">Coordinates: <span>(1)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><ul class="xr-var-list"><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">Z</span></div><div class="xr-var-dims">(Z)</div><div class="xr-var-dtype">&lt;U1</div><div class="xr-var-preview xr-preview">'A' 'B' 'C' 'D' ... 'G' 'H' 'I' 'J'</div><input id="attrs-6fc521f9-ae74-4537-bd42-6e7a6242cf4c" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-6fc521f9-ae74-4537-bd42-6e7a6242cf4c" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-6c035385-8428-4b0e-a0b4-90024e908d7e" class="xr-var-data-in" type="checkbox"><label for="data-6c035385-8428-4b0e-a0b4-90024e908d7e" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array(['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'], dtype='&lt;U1')</pre></div></li></ul></div></li><li class="xr-section-item"><input id="section-f4f0c8ca-df0f-4195-9fa7-9de3d8f7a081" class="xr-section-summary-in" type="checkbox"><label for="section-f4f0c8ca-df0f-4195-9fa7-9de3d8f7a081" class="xr-section-summary">Indexes: <span>(1)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><ul class="xr-var-list"><li class="xr-var-item"><div class="xr-index-name"><div>Z</div></div><div class="xr-index-preview">PandasIndex</div><input type="checkbox" disabled=""><label></label><input id="index-459ea2d2-694e-4f65-be95-97f790753e39" class="xr-index-data-in" type="checkbox"><label for="index-459ea2d2-694e-4f65-be95-97f790753e39" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Index(['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'], dtype='object', name='Z'))</pre></div></li></ul></div></li><li class="xr-section-item"><input id="section-2a42a744-40b0-4562-b9a9-cc64aa4f101a" class="xr-section-summary-in" type="checkbox" disabled=""><label for="section-2a42a744-40b0-4562-b9a9-cc64aa4f101a" class="xr-section-summary" title="Expand/collapse section">Attributes: <span>(0)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><dl class="xr-attrs"></dl></div></li></ul></div></div>
</div>
</div>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>This was alot more difficult than I thought, and there are no guarantees this is a stable implementation since I’m working with very low level code, but I’m hoping this is a solid implementation to get cleaner model output from numpyro models. I’d likely want to reorganize all of this code and run more tests against it when I end up using it in my future projects, and I’d be curious if the numpyro devs had any easier ideas for how to pull this off.</p>
<p>Some things that still need to be explored are:</p>
<ol type="1">
<li>Will this still work when there’s scoping with sub-models? Or integration with other libraries like flax?</li>
<li>What changes need to be made to get this approach extended to SVI?</li>
</ol>


</section>

 ]]></description>
  <category>numpyro</category>
  <category>tensors</category>
  <category>ArviZ</category>
  <guid>https://kylejcaron.github.io/posts/numpyro_dim_labelling/2025-02-23-numpyro-dim_labels.html</guid>
  <pubDate>Sun, 23 Feb 2025 05:00:00 GMT</pubDate>
  <media:content url="https://kylejcaron.github.io/assets/img/placeholder.png" medium="image" type="image/png" height="95" width="144"/>
</item>
<item>
  <title>Pandera and Object Oriented Data Validation</title>
  <link>https://kylejcaron.github.io/posts/pandera_schemas/2025-02-21-pandera-schemas.html</link>
  <description><![CDATA[ 





<div id="3e22a01f" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span></code></pre></div>
</details>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Pandera schema’s are a useful tool to make sure input data is as expected. If you’ve ever used dbt before, theyre just like schema tests or great-expectations.</p>
<p>Data validation is extremely important for just about everyone in the data science space. For instance, your model may not be expecting null values, or maybe it needs data to be iid. This is where Pandera can come in and excel, especially when you don’t have control over the input data.</p>
</section>
<section id="inheritance-for-reusing-schemas" class="level1">
<h1>Inheritance for reusing schemas</h1>
<p>I recently had a project where I wasn’t responsible for and had no control over the input data. For a particular model, many different datasets would be sent to different models for inference, and I couldn’t always rely on the data being properly structured.</p>
<p>I was also working with a range of different models including time-varying survival and time series models. I wanted to be able to reuse as much code across models, which is where Pandera comes in.</p>
<p>Lets start with looking at some panel data:</p>
<div id="a309ed5f" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">panel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame({</span>
<span id="cb2-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"entity_id"</span>:[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,],</span>
<span id="cb2-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>:[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2023-01-01'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2023-02-01'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2023-01-01'</span>],</span>
<span id="cb2-4">})</span>
<span id="cb2-5">panel.assign(metric<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">entity_id</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">metric</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>2023-01-01</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>2023-02-01</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>2023-01-01</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>It turns out Time Series data is typically going to be panel data (although not always true). Time-varying survival data is also a special case of panel data, where each entity (for instance a customer’s subscription id) starts at some point at there are consistently spaced observations.</p>
<p>Class inheritance is a perfect pattern to reflect this. We can do something like the following to reuse schema checks and save a lot of lines of code.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> PanelSchema:</span>
<span id="cb3-2">    ...</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> TimeSeriesSchema(PanelSchema):</span>
<span id="cb3-5">    ...</span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> TimevaryingSurvivalSchema(PanelSchema):</span>
<span id="cb3-8">    ...</span></code></pre></div>
<p>For example, we can make a panel schema with some obvious checks:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> BasePanelSchema(pa.DataFrameModel):</span>
<span id="cb4-2">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@classmethod</span></span>
<span id="cb4-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> infer_frequency(cls, df: pd.DataFrame) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb4-4">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Identifies the frequency of dates in the panel dataset"""</span></span>
<span id="cb4-5">        ...</span>
<span id="cb4-6"></span>
<span id="cb4-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@classmethod</span></span>
<span id="cb4-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> validate(cls, df: pd.DataFrame, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb4-9">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run and save dataset frequency before other validations</span></span>
<span id="cb4-10">        cls.Config.metadata[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"freq"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cls.infer_frequency(df)</span>
<span id="cb4-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().validate(df, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb4-12"></span>
<span id="cb4-13"></span>
<span id="cb4-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> PanelSchema(BasePanelSchema):</span>
<span id="cb4-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Panel Data schema. This assumes that Panel Data has 1 entry per entity per date, and that all</span></span>
<span id="cb4-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    dates between the min and the max date for an entity should exist as records, evenly spaced.</span></span>
<span id="cb4-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb4-18">    entity_id: Series[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pa.Field(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">coerce</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, nullable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb4-19">    date: Series[DateTime] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pa.Field(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">coerce</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, nullable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb4-20"></span>
<span id="cb4-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Config:</span>
<span id="cb4-22">        unique <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"entity_id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>]</span>
<span id="cb4-23">        strict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb4-24">        metadata: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb4-25"></span>
<span id="cb4-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@pa.dataframe_check</span></span>
<span id="cb4-27">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> validate_frequency(cls, df: pd.DataFrame) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>:</span>
<span id="cb4-28">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Ensures that every entity has the same frequency between dates of consecutive records"""</span></span>
<span id="cb4-29">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use the inferred frequency for some validation</span></span>
<span id="cb4-30">        ...</span>
<span id="cb4-31"></span>
<span id="cb4-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@pa.dataframe_check</span></span>
<span id="cb4-33">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> check_complete_date_index_per_entity(cls, df: DataFrame) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Series[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>]:</span>
<span id="cb4-34">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Ensures that all dates (at the applicable frequency) between the min and the max date for</span></span>
<span id="cb4-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        an entity should exist as records.</span></span>
<span id="cb4-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb4-37">        ...</span></code></pre></div>
<p>As a starting point, this makes it really easy to extend to time series models.</p>
<div id="ad429c15" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a fake sales dataframe</span></span>
<span id="cb5-2">pd.DataFrame({</span>
<span id="cb5-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"entity_id"</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb5-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>:pd.date_range(start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2023-01-01'</span>, freq<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MS'</span>, periods<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb5-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>:[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">105</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span>]</span>
<span id="cb5-6">})</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">entity_id</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>2023-01-01</td>
<td>100</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>2023-02-01</td>
<td>105</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1</td>
<td>2023-03-01</td>
<td>96</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1</td>
<td>2023-04-01</td>
<td>120</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>I can take my <code>PanelSchema</code> and inherit it for different data models. A simple example is lets say I need a non-null outcome:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> UnivariateTimeSeriesSchema(PanelSchema):</span>
<span id="cb6-2">    y: Series[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pa.Field(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">coerce</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, nullable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
<p>and just like that, I have all of those previous data checks extended to my time series model.</p>
<p>There are some downsides though. First, you cant parameterize field names, for instance your outcome needs to be named <code>y</code>. Second, you need to make sure you can generalize</p>
<p>For time-varying survival schema, they can be defined as</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> TimeVaryingSurvivalSchema(PanelSchema):</span>
<span id="cb7-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""A schema for Time Varying Survival Analysis, should be a unique and complete panel dataset</span></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    on the `entity_id` and `time` columns.</span></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb7-5">    tenure: Series[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pa.Field(ge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">coerce</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, nullable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb7-6">    event: Series[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pa.Field(isin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">coerce</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, nullable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb7-7">    exposure: Series[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pa.Field(le<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">coerce</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, nullable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb7-8"></span>
<span id="cb7-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@pa.dataframe_check</span></span>
<span id="cb7-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> check_tenure_is_consecutive(cls, df: DataFrame) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Series[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>]:</span>
<span id="cb7-11">        ...</span>
<span id="cb7-12"></span>
<span id="cb7-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@pa.dataframe_check</span></span>
<span id="cb7-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> check_max_one_event_per_entity(cls, df: DataFrame) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Series[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>]:</span>
<span id="cb7-15">        ...</span>
<span id="cb7-16"></span>
<span id="cb7-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@pa.dataframe_check</span></span>
<span id="cb7-18">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> check_event_is_last_obs_per_entity(cls, df: DataFrame) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Seris[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>]:</span>
<span id="cb7-19">        ...</span></code></pre></div>
<p>In this case, it inherits all of the previous schema checks from PanelSchema. We extend it further to add some survival analysis schema specific checks - for instance, for each entity_id, we expect there to be a tenure column indicating each consecutive time period. A common example for tenure is the months since a customer started a subscription.</p>
<div id="6a29a96e" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">panel.assign(</span>
<span id="cb8-2">    tenure<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], </span>
<span id="cb8-3">    exposure<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>],</span>
<span id="cb8-4">    event <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb8-5">)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">entity_id</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">tenure</th>
<th data-quarto-table-cell-role="th">exposure</th>
<th data-quarto-table-cell-role="th">event</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>2023-01-01</td>
<td>0</td>
<td>1.00</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>2023-02-01</td>
<td>1</td>
<td>0.50</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>2023-01-01</td>
<td>0</td>
<td>0.25</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Whats great about this is that its all so easy to read and mimics how we think about it conceptually. Time Series and Time-varying survival are just sub-categories of panel data. And our code mimics that perfectly.</p>
</section>
<section id="concluding-thoughts" class="level1">
<h1>Concluding Thoughts</h1>
<p>Pandera has some nice use cases, particularly when you’re not sure what data you’re going to get thrown at you. The read-ability is fantastic, and it can save a ton of code.</p>
<p>That said there were some caveats I’ve run into (some of which I mentioned above):</p>
<ol type="1">
<li>Field names can’t be parameterized. For instance, maybe for Survival analysis I want the outcome to be named <code>churn</code> instead of <code>event</code>.</li>
<li>Will this scale for massive datasets? I’m not sure if the code will be able to stay this clean at larger scales, especially for consecutive row based operations like validating frequencies. Not sure how that one will play out when the data needs to be batched.</li>
<li>Pandera isn’t the most flexible since you’re typically working with uninstantiated classes and class methods. There can be some growing pains for less experienced programmers</li>
<li>There is a really cool yaml output feature that lets you take a schema and get a yaml list of all of the checks it will run, but it doesn’t support custom checks and that basically makes it unusable.</li>
<li>I found that the project maintainers weren’t that responsive on github</li>
</ol>
<p>Overall, its definitely a useful tool to keep in your back pocket, but I have two pieces of advice:</p>
<ol type="1">
<li>If you have the luxury of predictable data inputs or you’re modeling a single dataset over time, you probably don’t need this and can stick to dbt validation or something simple.</li>
<li>If you’re working on large datasets, maybe do a POC and make sure your schema approach will work for data thats loaded in batches</li>
</ol>
<p>Note: I may update this later to have actual working code to demo, but for now it’s pseudocode.</p>


</section>

 ]]></description>
  <category>object oriented programming</category>
  <category>data processing</category>
  <guid>https://kylejcaron.github.io/posts/pandera_schemas/2025-02-21-pandera-schemas.html</guid>
  <pubDate>Fri, 21 Feb 2025 05:00:00 GMT</pubDate>
  <media:content url="https://kylejcaron.github.io/assets/img/pandera-preview.png" medium="image" type="image/png" height="82" width="144"/>
</item>
<item>
  <title>Modeling Anything With First Principles: Demand under extreme stockouts</title>
  <link>https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p><strong>The Problem:</strong> You work at a rental service that is suffering from high periods of churn. You’ve found that stockouts are one of the biggest reasons for churn - despite having plenty of products, they tend to only be available 60-80% of the time. <strong>How can we determine how much stock to reorder?</strong></p>
<p>The idea of this project is to borrow ideas from first principles modeling - think about the data generating process and model each step of it. This example borrows ideas from discrete choice literature, survival analysis, demand forecasting, and simulation.</p>
<p>Products with extreme stockouts have misleading demand estimates under classic demand models.</p>
<blockquote class="blockquote">
<p><strong>The basis of these ideas is really simple. If we only have 5 units of a product in stock, and we saw 5 sales (or rentals in this case) that day, then we know that the observed demand would’ve been atleast 5 rentals if stock levels didn’t constrain it.</strong></p>
</blockquote>
<p>Typical demand modeling might only look at the count of rentals each day, while censored demand modeling would look at both rental counts and stock levels, and incoporate both of these pieces of information.</p>
<p>The idea is to start simple(-ish) and add complexity. We’ll first model a single product and test different ordering policies, and then begin modeling multiple products.</p>
<p>The original code including the full simulation of the dataset can be found <a href="https://github.com/kylejcaron/case_studies/tree/main/censored_demand">here</a>.</p>
</section>
<section id="part-1-looking-at-the-data" class="level1">
<h1>Part 1: Looking at the data</h1>
<hr>
<div id="eaccd4ed" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> arviz <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> az</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.ticker <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> mtick</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jax</span>
<span id="cb1-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> jax <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random </span>
<span id="cb1-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jax.numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> jnp</span>
<span id="cb1-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpyro</span>
<span id="cb1-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpyro.distributions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> dist</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> plotting <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> plot_rentals</span>
<span id="cb1-15"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> warnings</span>
<span id="cb1-16">warnings.filterwarnings(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ignore"</span>)</span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot styling</span></span>
<span id="cb1-19">plt.style.use(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"arviz-darkgrid"</span>)</span>
<span id="cb1-20">plt.rcParams.update({</span>
<span id="cb1-21">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'axes.labelsize'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>,</span>
<span id="cb1-22">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'axes.titlesize'</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">22</span>, </span>
<span id="cb1-23">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'font.size'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, </span>
<span id="cb1-24">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'legend.fontsize'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, </span>
<span id="cb1-25">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xtick.labelsize'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, </span>
<span id="cb1-26">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ytick.labelsize'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span></span>
<span id="cb1-27">})</span>
<span id="cb1-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Global vars</span></span>
<span id="cb1-29">SEED <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb1-30">BASE_URL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://raw.githubusercontent.com/kylejcaron/case_studies/main/censored_demand'</span></span>
<span id="cb1-31"></span>
<span id="cb1-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load in csv data</span></span>
<span id="cb1-33">rentals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (pd.read_csv(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>BASE_URL<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/data/rentals.csv"</span>)</span>
<span id="cb1-34">           .assign(date<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: pd.to_datetime(d.date))</span>
<span id="cb1-35">          )</span>
<span id="cb1-36">stock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (pd.read_csv(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>BASE_URL<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/data/stock_levels.csv"</span>)</span>
<span id="cb1-37">         .assign(date<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: pd.to_datetime(d.date))</span>
<span id="cb1-38">        )</span>
<span id="cb1-39">purchases <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (pd.read_csv(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>BASE_URL<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/data/product_purchases.csv"</span>)</span>
<span id="cb1-40">           .assign(date<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: pd.to_datetime(d.date))</span>
<span id="cb1-41">          )</span>
<span id="cb1-42">J_PRODUCTS, MAX_PERIODS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span></span></code></pre></div>
</details>
</div>
<p>We have three datasets:</p>
<ul>
<li><code>rentals</code> showing rental events and when those rentals were returned for a single product</li>
<li><code>stock</code> showing available stock levels for that product over time</li>
<li><code>product_purchases</code> showing how much was bought for each product and when</li>
</ul>
<div id="11e91259" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">rentals.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rental_id</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">return_date</th>
<th data-quarto-table-cell-role="th">product_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>7ee46d21-bf37-45a9-a03d-3cc36e08d422</td>
<td>2022-04-01</td>
<td>2022-05-12</td>
<td>product_0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>cfefc50c-178d-4666-a97b-608d37cb771f</td>
<td>2022-04-02</td>
<td>2022-04-18</td>
<td>product_0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>53bcc895-3f56-4c2c-8046-4bbda06848e6</td>
<td>2022-04-03</td>
<td>2022-04-09</td>
<td>product_0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>e0381b64-2001-4f84-957f-3b864a7dcb99</td>
<td>2022-04-04</td>
<td>2022-06-07</td>
<td>product_0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>422f73f1-ba66-4cb2-94a3-cd314aea9fd5</td>
<td>2022-04-05</td>
<td>2022-05-05</td>
<td>product_0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="9ed06e29" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">stock.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">product_id</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">starting_units</th>
<th data-quarto-table-cell-role="th">ending_units</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>product_0</td>
<td>2022-04-01</td>
<td>110.0</td>
<td>109.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>product_0</td>
<td>2022-04-02</td>
<td>109.0</td>
<td>108.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>product_0</td>
<td>2022-04-03</td>
<td>108.0</td>
<td>107.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>product_0</td>
<td>2022-04-04</td>
<td>107.0</td>
<td>106.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>product_0</td>
<td>2022-04-05</td>
<td>106.0</td>
<td>105.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="f75fbdbb" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">purchases.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">product_id</th>
<th data-quarto-table-cell-role="th">units</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">order_type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>product_0</td>
<td>110.0</td>
<td>2022-04-01</td>
<td>new_product</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>product_1</td>
<td>60.0</td>
<td>2022-04-01</td>
<td>new_product</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>product_2</td>
<td>90.0</td>
<td>2022-04-01</td>
<td>new_product</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>product_3</td>
<td>110.0</td>
<td>2022-04-01</td>
<td>new_product</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>product_4</td>
<td>160.0</td>
<td>2022-04-01</td>
<td>new_product</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="plotting-product-rentals" class="level2">
<h2 class="anchored" data-anchor-id="plotting-product-rentals">Plotting Product Rentals</h2>
<p>Lets convert the rental data to time series data and see what it looks like</p>
<div id="ffb46b8e" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> rental_events_to_ts(rentals, freq<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>):</span>
<span id="cb5-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (rentals</span>
<span id="cb5-3">            .groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"product_id"</span>)</span>
<span id="cb5-4">            .resample(freq,on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'date'</span>)[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rental_id'</span>]].count()</span>
<span id="cb5-5">            .set_axis([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rentals'</span>],axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-6">           )</span>
<span id="cb5-7"></span>
<span id="cb5-8">daily_rentals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rentals.pipe(rental_events_to_ts, freq<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>)</span>
<span id="cb5-9"></span>
<span id="cb5-10">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>),sharex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb5-11"></span>
<span id="cb5-12">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Total Daily Rentals'</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Date'</span>, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Total Daily Rentals'</span>)</span>
<span id="cb5-13">daily_rentals.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>().rentals.plot(ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb5-14"></span>
<span id="cb5-15">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Daily Rentals'</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Date'</span>, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Daily Rentals Across Products'</span>)</span>
<span id="cb5-16">sample_idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.choice(J_PRODUCTS, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>, replace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb5-17">daily_rentals.unstack(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).iloc[:,sample_idxs].plot(ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,legend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb5-18"></span>
<span id="cb5-19">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-6-output-1.png" width="1211" height="711" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It looks like there are typically 0-15 rentals per day for a given product, and there are typically 5000 rentals total each day.</p>
<p>Looking at the distribution of total rentals across products, we see that it is mildly long-tailed.</p>
<div id="5ea2d75d" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),sharex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb6-2">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rentals"</span>,fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb6-3">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Count"</span>,fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb6-4">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Distribution of total rentals</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">per product in observation period'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb6-5">sns.histplot( daily_rentals.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"product_id"</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(),ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax )</span>
<span id="cb6-6">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-7-output-1.png" width="511" height="311" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can also see that stockouts are extremely prevalent - on a given day, up to 85% of products could be stocked out. A recent reorder in June helped a little but not enough. How can we reduce the stockout problem and reorder accordingly?</p>
<div id="7882b505" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb7-2">(stock</span>
<span id="cb7-3"> .assign(stockout_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d.ending_units<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-4"> .groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).stockout_rate.mean()</span>
<span id="cb7-5"> .plot(ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Stocked Out Products'</span>,title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Percent of products with a Stockout each day'</span>))</span>
<span id="cb7-6"></span>
<span id="cb7-7">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-8-output-1.png" width="1211" height="511" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="looking-at-a-single-product" class="level2">
<h2 class="anchored" data-anchor-id="looking-at-a-single-product">Looking at a single product</h2>
<p>We’re going to start with a single product and see if we can come up with a system that informs us how many units we should reorder.</p>
<div id="60cc5d6f" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">165</span></span>
<span id="cb8-2">reorder_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb8-3">    purchases</span>
<span id="cb8-4">    .query(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"product_id=='product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>)</span>
<span id="cb8-5">    .query(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"order_type=='reorder'"</span>)</span>
<span id="cb8-6">    .date.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>()</span>
<span id="cb8-7">)</span>
<span id="cb8-8"></span>
<span id="cb8-9">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplot_mosaic(</span>
<span id="cb8-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb8-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    AAA</span></span>
<span id="cb8-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    AAA</span></span>
<span id="cb8-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    BBB</span></span>
<span id="cb8-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    CCC</span></span>
<span id="cb8-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span>,figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>),sharex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb8-16"></span>
<span id="cb8-17">ax[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>].set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Daily Rentals for Product ID </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb8-18">daily_rentals.loc[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>].plot(ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>,ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Rentals'</span>)</span>
<span id="cb8-19">daily_rentals.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>().rentals.rename(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_rentals"</span>).plot(ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B'</span>],ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Total Rentals'</span>)</span>
<span id="cb8-20">ax[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B'</span>].set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Total Rentals"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb8-21"></span>
<span id="cb8-22">(stock</span>
<span id="cb8-23"> .assign(stockout_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d.ending_units<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb8-24"> .groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).stockout_rate.mean()</span>
<span id="cb8-25"> .plot(ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>]))</span>
<span id="cb8-26">ax[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>].set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stockout Rate"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb8-27">ax[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>].set_ylim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-28"></span>
<span id="cb8-29">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-9-output-1.png" width="1211" height="811" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As shown above, just looking at a time series of rentals each day is a bit confusing - there are seemingly random spikes in demand for just this product that dont seem to line up with spikes in total demand across products.</p>
<p>When we look at the stockout rate across all products over time, it looks like the stockout rate drops at the same time demand increases for Product ID 165.</p>
<p>Let’s join stock data to rental data and see whats happening for this product.</p>
<div id="270a46ea" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">daily_rentals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (rentals.pipe(rental_events_to_ts, freq<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>)</span>
<span id="cb9-2">                 .merge(stock, on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'product_id'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'date'</span>])</span>
<span id="cb9-3">                 .assign(stockout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(d.ending_units<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb9-4">                 .assign(total_stockout_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).stockout.transform(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean"</span>)) </span>
<span id="cb9-5">                 .assign(total_rentals<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).rentals.transform(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sum"</span>))</span>
<span id="cb9-6">                 .set_index([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'product_id'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>])</span>
<span id="cb9-7">                )</span>
<span id="cb9-8"></span>
<span id="cb9-9">daily_rentals.loc[[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>]].head()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rentals</th>
<th data-quarto-table-cell-role="th">starting_units</th>
<th data-quarto-table-cell-role="th">ending_units</th>
<th data-quarto-table-cell-role="th">stockout</th>
<th data-quarto-table-cell-role="th">total_stockout_rate</th>
<th data-quarto-table-cell-role="th">total_rentals</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">product_id</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">product_165</td>
<td data-quarto-table-cell-role="th">2022-04-01</td>
<td>3</td>
<td>80.0</td>
<td>77.0</td>
<td>0</td>
<td>0.001122</td>
<td>5014</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2022-04-02</td>
<td>2</td>
<td>77.0</td>
<td>75.0</td>
<td>0</td>
<td>0.003125</td>
<td>4887</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2022-04-03</td>
<td>5</td>
<td>75.0</td>
<td>70.0</td>
<td>0</td>
<td>0.011190</td>
<td>5058</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2022-04-04</td>
<td>6</td>
<td>70.0</td>
<td>64.0</td>
<td>0</td>
<td>0.023209</td>
<td>5040</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2022-04-05</td>
<td>4</td>
<td>64.0</td>
<td>60.0</td>
<td>0</td>
<td>0.032193</td>
<td>4890</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Now that we have this data joined, we can plot the rental data with corresponding stock data.</p>
<div id="ffd307ad" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_rentals(</span>
<span id="cb10-2">    daily_rentals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> daily_rentals.loc[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>].rentals, </span>
<span id="cb10-3">    daily_stock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> daily_rentals.loc[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>].starting_units,</span>
<span id="cb10-4">)</span>
<span id="cb10-5"></span>
<span id="cb10-6">ax.axvline(reorder_date, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Reorder: new units added to inventory'</span>)</span>
<span id="cb10-7">ax.legend()</span>
<span id="cb10-8">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-11-output-1.png" width="1211" height="511" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>For most of the days in the product’s lifetime, there are as many rentals as there are units available. This indicates we’re probably understocked - <strong>if we had more stock available, we’d likely observe more rentals.</strong></p>
<p>This is also apparent in the overstocked periods - at the start of the product’s lifetime there tends to be more rentals. There’s also a <strong>reorder</strong> that happens in June, where the business procured new units of that product to rent out to customers. We can see that there’s a jump in observed rentals</p>
<p>It’s time to introduce a key concept - the difference between rental demand and observed rentals:</p>
<ul>
<li><strong>Rental demand</strong> is the true demand to rent the product each day.</li>
<li><strong>Observed rentals</strong> are the number of rentals we actually observe in the data, after random noise is added to demand and it gets constrained by stock levels.</li>
</ul>
</section>
</section>
<section id="part-2-modeling-the-problem" class="level1">
<h1>Part 2: Modeling the problem</h1>
<hr>
<p>First, lets reiterate our goal. We want to know how many more units to purchase for this rental product so we don’t end up with any more stockouts. To do so, we need to know what stock levels will be if we have more units in stock.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Csmall%7B%0AE%5B%5Ctext%7Bstock%7D_%7Bt+%5CDelta%20t%7D%20%7C%20%5Ctext%7Bdo%7D(%5Ctext%7Bstock%7D_%7BT=t%7D=X),%20%5Ctext%7Bdemand%7D_%7Bt-1%7D,%5Ctext%7Bstock%7D_%7Bt-1%7D,%20%5Ctext%7Bactive%20rentals%7D_%7B0:t%7D%5D%0A%7D%0A"></p>
<p>When we think of the <strong>data generating process</strong> for rental demand and stock levels it is the following:</p>
<ol type="1">
<li>Customers come in and rent <img src="https://latex.codecogs.com/png.latex?y%20%5Csim%20%5Ctext%7Bmin%7D(%5Ctext%7BPoisson%7D(%5Clambda),%20%5Ctext%7Bstock%7D)"> units each day</li>
<li>Those units tend to have some learnable distribution of rental duration, <img src="https://latex.codecogs.com/png.latex?t%20%5Csim%20%5Ctext%7BLogNormal%7D(%5Ctheta,%20%5Csigma)"></li>
<li>The stock levels vary as those rentals occur and get returned from steps (1) and (2)</li>
</ol>
<p>This narrows the problem down - we need to identify unconstrained rental demand (how many rentals would we get if we had perfect stock), and rental duration. We can use models for both (1) and (2) and then simulate different potential outcomes.</p>
<p><strong>Here’s a look at the overall plan</strong></p>
<ol type="1">
<li>Fit a rental duration model</li>
<li>Fit a censored demand model</li>
<li>Combine both of those into a stock level simulation</li>
<li>Simulate out different purchase volumes that lead to a low chance of stockouts.</li>
<li>Purchase that volume of units</li>
<li>Expand the model to incorporate many products</li>
<li>Increase the complexity of the simulation and the model - i.e.&nbsp;what happens if we add seasonality to the demand? What happens if there are demand shocks?</li>
</ol>
<section id="rental-duration-model" class="level2">
<h2 class="anchored" data-anchor-id="rental-duration-model">Rental Duration Model</h2>
<hr>
<p>The plan for now is to model the unconstrained demand for this single product - whats the actual rental demand for the product? How many rentals would it get if there weren’t stockouts? Lets start off by looking at our data.</p>
<section id="preparing-the-data" class="level3">
<h3 class="anchored" data-anchor-id="preparing-the-data">Preparing the data</h3>
<p>It’s easy to see that there are plenty of rentals that are still out with customers and haven’t been returned yet. For these unreturned rentals, we can’t calculate an accurate rental duration.</p>
<div id="10a53937" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">rentals.sample(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>SEED)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rental_id</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">return_date</th>
<th data-quarto-table-cell-role="th">product_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">336567</td>
<td>9a0c22af-d234-4967-af33-904dc2063f07</td>
<td>2022-05-05</td>
<td>2022-05-30</td>
<td>product_661</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">372791</td>
<td>781e6d0a-c94c-4a34-8447-5dee6002248e</td>
<td>2022-05-28</td>
<td>NaN</td>
<td>product_739</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">316499</td>
<td>9c1cce54-62df-45e2-9a33-3cf1ee3056e7</td>
<td>2022-06-15</td>
<td>NaN</td>
<td>product_622</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">235191</td>
<td>4ce955dd-773c-443c-ae28-d4ce018686e2</td>
<td>2022-06-19</td>
<td>2022-06-29</td>
<td>product_459</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">299770</td>
<td>842f7574-3784-41f8-a627-29cf7d622b9e</td>
<td>2022-06-04</td>
<td>2022-06-23</td>
<td>product_591</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">39846</td>
<td>366afbe0-805b-46ac-a25b-018aa35367f7</td>
<td>2022-05-30</td>
<td>NaN</td>
<td>product_78</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">395599</td>
<td>dd13bd67-3d1e-464a-8cb9-c2205e050815</td>
<td>2022-04-09</td>
<td>2022-04-19</td>
<td>product_787</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">70230</td>
<td>0193f7c4-a229-41a4-8872-3277229980a9</td>
<td>2022-04-16</td>
<td>2022-05-01</td>
<td>product_139</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">449004</td>
<td>4b7c426e-ac62-4467-8b95-0397f8aff0ce</td>
<td>2022-07-06</td>
<td>NaN</td>
<td>product_895</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">90329</td>
<td>632f806f-c782-4680-8464-f3ffafe4a9f5</td>
<td>2022-05-16</td>
<td>2022-06-09</td>
<td>product_178</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>It’s important to remember that even though these items aren’t returned, some have been rented out for 30, 40, 50 days, and it is important information to know that some items have been out for at least that long. A good example is that if it is possible for some items to be rented out for 200 days, but we’ve only observed 100 days of activity, then whatever we estimate for the rental duration would be underestimated if we just used basic averaging.</p>
<p>What we can instead do is calculate the rental duration to date and then use a survival model to properly incorporate those unreturned items.</p>
<div id="3557f176" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">curr_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rentals.date.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>()</span>
<span id="cb12-2">rentals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb12-3">    rentals</span>
<span id="cb12-4">    .assign(return_date<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: pd.to_datetime(d.return_date))</span>
<span id="cb12-5">    .assign(time_since<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: (d.return_date.fillna(curr_date)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>d.date).dt.days)</span>
<span id="cb12-6">    .assign(event<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d.return_date.notnull()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb12-7">)</span>
<span id="cb12-8">rentals.sample(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rental_id</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">return_date</th>
<th data-quarto-table-cell-role="th">product_id</th>
<th data-quarto-table-cell-role="th">time_since</th>
<th data-quarto-table-cell-role="th">event</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">478766</td>
<td>c129ffd9-c584-4573-a772-ce08cfd93cfa</td>
<td>2022-07-03</td>
<td>NaT</td>
<td>product_958</td>
<td>6</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">89559</td>
<td>7377bb04-65bd-4bd3-a34a-78586cf11308</td>
<td>2022-06-01</td>
<td>2022-06-10</td>
<td>product_176</td>
<td>9</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">105813</td>
<td>958e5645-e901-404e-8d2f-cbf0d8b548b3</td>
<td>2022-04-26</td>
<td>2022-05-13</td>
<td>product_209</td>
<td>17</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">155099</td>
<td>a09aecca-4e61-429c-b7f9-681a27c2050b</td>
<td>2022-05-22</td>
<td>2022-06-22</td>
<td>product_297</td>
<td>31</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">63536</td>
<td>6f465e1d-8f9a-4513-8c65-66ed1ac7dc55</td>
<td>2022-07-09</td>
<td>NaT</td>
<td>product_125</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="defining-and-fitting-the-model" class="level3">
<h3 class="anchored" data-anchor-id="defining-and-fitting-the-model">Defining and fitting the model</h3>
<p>We can write up a survival model in numpyro. The idea of survival analysis is that:</p>
<ul>
<li><strong>if a return has already occurred</strong>, we fit the model as usual with the observed rental duration.</li>
<li><strong>If a return hasn’t occurred yet</strong>, we tell the model that the rental duration is at least as long as has been observed so far. This is done with stats via a survival function, or the complementary CDF (ccdf)</li>
</ul>
<p>For simplicity, we’re assuming the data is lognormally distributed (and we simulated the data that way). In reality, it is best to plot distributions of your data and decide for yourself.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Csmall%7B%0A%5Cdisplaylines%7B%0A%5Ctext%7Brental%20duration%7D%20%5Csim%20%5Ctext%7BLognormal%7D(%5Ctheta,%20%5Csigma)%0A%7D%7D%0A"></p>
<div id="ed302e58" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> censored_lognormal(theta, sigma, cens, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb13-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If observed, this is the likelihood contribution</span></span>
<span id="cb13-3">    numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs"</span>, dist.LogNormal(theta, sigma).mask(cens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), obs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y)</span>
<span id="cb13-4"></span>
<span id="cb13-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If not observed, use the survival function as the likelihood constribution</span></span>
<span id="cb13-6">    ccdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ccdf"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> dist.LogNormal(theta, sigma).cdf(y))</span>
<span id="cb13-7">    numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"censored_label"</span>, dist.Bernoulli(ccdf).mask(cens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), obs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cens)</span>
<span id="cb13-8"></span>
<span id="cb13-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> survival_model(E, T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb13-10">    theta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"theta"</span>, dist.Normal(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.9</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb13-11">    sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma"</span>, dist.Exponential(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>))</span>
<span id="cb13-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(E)):</span>
<span id="cb13-13">        censored_lognormal(theta, sigma, cens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>E), y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>T)</span></code></pre></div>
</div>
<p>We can now use numpyro to fit a model and estimate the typical rental duration.</p>
<div id="eb9654e6" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">E <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rentals.query(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"product_id=='product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>).query(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time_since&gt;0"</span>).event.values</span>
<span id="cb14-2">T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rentals.query(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"product_id=='product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>).query(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time_since&gt;0"</span>).time_since.values</span>
<span id="cb14-3"></span>
<span id="cb14-4">kernel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.infer.NUTS(survival_model)</span>
<span id="cb14-5">mcmc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.infer.MCMC(</span>
<span id="cb14-6">    kernel,</span>
<span id="cb14-7">    num_warmup<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,</span>
<span id="cb14-8">    num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,</span>
<span id="cb14-9">    num_chains<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb14-10">    progress_bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb14-11">)</span>
<span id="cb14-12">mcmc.run(random.PRNGKey(SEED),E<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>E,T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>T)</span>
<span id="cb14-13">idata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mcmc.get_samples()</span></code></pre></div>
</div>
<p>Remember, this is simulated data so we know the truth and can use that as a way to test this is working - a correctly specified model should recover the the true parameter values.</p>
<div id="561c5215" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb15-2">sns.histplot( idata[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'theta'</span>],ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] )</span>
<span id="cb15-3">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].axvline(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.9</span>,color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Ground Truth'</span>)</span>
<span id="cb15-4">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Theta Estimate"</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Value'</span>)</span>
<span id="cb15-5">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].legend()</span>
<span id="cb15-6"></span>
<span id="cb15-7">sns.histplot( idata[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sigma'</span>],ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] )</span>
<span id="cb15-8">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].axvline(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Ground Truth'</span>)</span>
<span id="cb15-9">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sigma Estimate"</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Value'</span>)</span>
<span id="cb15-10">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].legend()</span>
<span id="cb15-11">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-16-output-1.png" width="1211" height="511" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="232d356a" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb16-2"></span>
<span id="cb16-3">bins <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb16-4">sns.histplot(T, stat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'density'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Observed Distribution'</span>, bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bins,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax)</span>
<span id="cb16-5"></span>
<span id="cb16-6">sns.histplot(</span>
<span id="cb16-7">    dist.LogNormal(idata[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'theta'</span>], idata[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sigma'</span>]).sample(random.PRNGKey(SEED)),</span>
<span id="cb16-8">    stat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'density'</span>,</span>
<span id="cb16-9">    label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Estimated Distribution'</span>,</span>
<span id="cb16-10">    bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bins,</span>
<span id="cb16-11">    ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax</span>
<span id="cb16-12">)</span>
<span id="cb16-13">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Estimated Rental Duration"</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Rental Duration'</span>)</span>
<span id="cb16-14">ax.legend()</span>
<span id="cb16-15">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-17-output-1.png" width="711" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Great, now we have a rental duration model fit, we just need to estimate demand.</p>
</section>
</section>
<section id="rental-demand-model" class="level2">
<h2 class="anchored" data-anchor-id="rental-demand-model">Rental Demand Model</h2>
<hr>
<section id="looking-at-the-demand-data" class="level3">
<h3 class="anchored" data-anchor-id="looking-at-the-demand-data">Looking at the demand data</h3>
<p>The rental demand model is going to start simple for this single-product case - we’ll just estimate a poisson distribuion.</p>
<p>Taking a look at the data again, it is clear that demand is constrained, or censored, by stockouts here.</p>
<div id="cef7525e" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_rentals(</span>
<span id="cb17-2">    daily_rentals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> daily_rentals.loc[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>].rentals, </span>
<span id="cb17-3">    daily_stock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> daily_rentals.loc[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>].starting_units</span>
<span id="cb17-4">)</span>
<span id="cb17-5"></span>
<span id="cb17-6">ax.axvline(reorder_date, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Reorder: new units added to inventory'</span>)</span>
<span id="cb17-7">plt.legend()</span>
<span id="cb17-8">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-18-output-1.png" width="1211" height="511" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>To confirm this is the case, we can take a look at the typical number of rentals when there is a stockout vs.&nbsp;when there isn’t - observed rentals are lower on days when there are stockouts - the sample size of stocked out periods is also smaller.</p>
<div id="259a40c9" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">(</span>
<span id="cb18-2">    daily_rentals</span>
<span id="cb18-3">    .loc[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>]</span>
<span id="cb18-4">    .groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stockout"</span>)</span>
<span id="cb18-5">    .rentals.agg([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mean'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>])</span>
<span id="cb18-6">    .<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb18-7">)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">stockout</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>6.65</td>
<td>26</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>4.31</td>
<td>74</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="defining-and-fitting-the-model-1" class="level3">
<h3 class="anchored" data-anchor-id="defining-and-fitting-the-model-1">Defining and fitting the model</h3>
<p>We can leverage survival analysis again to estimate demand. We define a censored poisson model below that assumes demand is constant over time and if there’s a stockout, the model thinks that rentals might’ve been higher than observed if there was more stock, otherwise if there’s no stockout it thinks that demand is the number of rentals that day (plus some noise of course)</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Csmall%7B%0A%5Cdisplaylines%7B%0A%5Ctext%7Blog%7D(%5Clambda)%20%5Csim%20%5Calpha%20+%20%5Cbeta%20X%20%5C%5C%0A%5Ctext%7Brentals%7D%20=%20%5Ctext%7Bmin%7D(%5Ctext%7Bstock%7D,%20%5Ctext%7BPoisson%7D(%5Clambda))%0A%7D%7D%0A"></p>
<div id="76515a2c" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> censored_poisson(lambd, cens, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb19-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If observed, this is the likelihood contribution</span></span>
<span id="cb19-3">    numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs"</span>, dist.Poisson(lambd).mask(cens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), obs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y)</span>
<span id="cb19-4"></span>
<span id="cb19-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If not observed, use the survival function as the likelihood constribution</span></span>
<span id="cb19-6">    ccdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> dist.Poisson(lambd).cdf(y)</span>
<span id="cb19-7">    pmf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.exp(dist.Poisson(lambd).log_prob(y)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># need to include the pmf for discrete distributions</span></span>
<span id="cb19-8">    numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"censored_label"</span>, dist.Bernoulli(ccdf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>pmf).mask(cens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), obs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cens)</span>
<span id="cb19-9"></span>
<span id="cb19-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> demand_model(stockout, X, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb19-11"></span>
<span id="cb19-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># parameters</span></span>
<span id="cb19-13">    alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alpha"</span>, dist.Normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb19-14">    beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>, dist.Normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb19-15"></span>
<span id="cb19-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(stockout)):</span>
<span id="cb19-17"></span>
<span id="cb19-18">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># regression</span></span>
<span id="cb19-19">        log_lambd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.deterministic(</span>
<span id="cb19-20">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log_lambd"</span>, </span>
<span id="cb19-21">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># base demand</span></span>
<span id="cb19-22">            alpha </span>
<span id="cb19-23">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># covariate influence on demand - in this case cross product effect</span></span>
<span id="cb19-24">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># as more products go out of stock, demand for the remaining in-stock products increases</span></span>
<span id="cb19-25">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> jnp.dot( X, beta ) </span>
<span id="cb19-26">        )</span>
<span id="cb19-27"></span>
<span id="cb19-28">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># demand as a rental rate per day</span></span>
<span id="cb19-29">        lambd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lambd"</span>, jnp.exp(log_lambd))</span>
<span id="cb19-30"></span>
<span id="cb19-31">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Observational model</span></span>
<span id="cb19-32">        censored_poisson(lambd, cens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>stockout, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y)</span></code></pre></div>
</div>
<p>We can then fit this model with numpyro below:</p>
<div id="81c3900a" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> daily_rentals.loc[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>].rentals.values</span>
<span id="cb20-2">stockout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> daily_rentals.loc[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>].stockout.values</span>
<span id="cb20-3">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> daily_rentals.loc[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>].total_stockout_rate.values</span>
<span id="cb20-4"></span>
<span id="cb20-5">kernel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.infer.NUTS(demand_model)</span>
<span id="cb20-6">mcmc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.infer.MCMC(</span>
<span id="cb20-7">    kernel,</span>
<span id="cb20-8">    num_warmup<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,</span>
<span id="cb20-9">    num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,</span>
<span id="cb20-10">    num_chains<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb20-11">    progress_bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb20-12">)</span>
<span id="cb20-13">mcmc.run(random.PRNGKey(SEED),stockout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>stockout, X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>X, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y)</span>
<span id="cb20-14">idata_demand <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mcmc.get_samples()</span></code></pre></div>
</div>
<p>We can check the estimated rental rate parameter, <img src="https://latex.codecogs.com/png.latex?%5Clambda">, against the actual value that we simulated and find that our model does have coverage over the ground truth.</p>
<div id="89b24a54" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb21-2">    pd.read_csv(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>BASE_URL<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/data/true_params.csv"</span>)</span>
<span id="cb21-3">    .assign(demand<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: jax.nn.softmax(d.utility.values)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>)</span>
<span id="cb21-4">    .query(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"product_id=='product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>)</span>
<span id="cb21-5">)</span>
<span id="cb21-6">demand_param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params.loc[j,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'demand'</span>]</span>
<span id="cb21-7"></span>
<span id="cb21-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot</span></span>
<span id="cb21-9">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb21-10">sns.histplot( np.exp(idata_demand[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alpha'</span>]),ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax )</span>
<span id="cb21-11">ax.axvline(demand_param, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Ground Truth'</span>)</span>
<span id="cb21-12">ax.legend()</span>
<span id="cb21-13">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value"</span>,fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb21-14">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Count"</span>,fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb21-15">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lambda estimate"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb21-16">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-22-output-1.png" width="511" height="311" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Note that this is the base level of demand for the product - as competing products stock out, we expect <img src="https://latex.codecogs.com/png.latex?%5Clambda"> to increase. Currently, that is represented by <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> in the model above, which is the relationship of the products demand to global stockout rate. As global stockout rate climbs, <img src="https://latex.codecogs.com/png.latex?%5Clambda"> increases. We can roughly estimate lambda at differen’t stockout levels.</p>
<div id="b03a75c4" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot</span></span>
<span id="cb22-2">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb22-3">global_stockout_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span></span>
<span id="cb22-4">bX <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> idata_demand[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'beta'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>global_stockout_rate</span>
<span id="cb22-5">sns.histplot( np.exp(idata_demand[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alpha'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bX),ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax )</span>
<span id="cb22-6">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value"</span>,fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb22-7">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Count"</span>,fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb22-8">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lambda estimate</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">when 60</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">% o</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">f products are stocked out"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb22-9">ax.set_xlim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span>
<span id="cb22-10">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-23-output-1.png" width="511" height="311" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now that we have a rental duration model and a rental demand model, lets build a simulation.</p>
</section>
</section>
</section>
<section id="part-3-simulation" class="level1">
<h1>Part 3: Simulation</h1>
<hr>
<section id="the-simulation-code" class="level2">
<h2 class="anchored" data-anchor-id="the-simulation-code">The simulation code</h2>
<p>We can leverage numpyro to simulate this. They have a <code>scan</code> operator that iterates day over day which fits well with this problem. Here’s the initial simulation model structure.</p>
<p>We’ll start by building a base class, <code>RentalInventory</code> that can be inherited by other classes. If you look at the <code>model</code> method, it takes in an initial state, and iterates over the <code>model_single_day</code> method each day we tell it to.</p>
<p>The <code>model_single_day</code> method simulates returns and rentals each day, and logs them.</p>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> RentalInventory:</span>
<span id="cb23-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""A model of rental inventory, modeling stock levels as returns and rentals occur each day.</span></span>
<span id="cb23-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Currently supports a single product</span></span>
<span id="cb23-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb23-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, n_products: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, policies: np.ndarray <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb23-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_products <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n_products</span>
<span id="cb23-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.policies <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> policies <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> policies <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> jnp.zeros((n_products, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>))</span>
<span id="cb23-8">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Rentals that are out with customers are stored as an array, where the index corresponds with time, </span></span>
<span id="cb23-9">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and the value corresponds with the number of rentals from that time that are still out with customers</span></span>
<span id="cb23-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># max_periods is the total number of periods to log</span></span>
<span id="cb23-11">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.max_periods <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span></span>
<span id="cb23-12"></span>
<span id="cb23-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> model(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, init_state: Dict, start_time: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, end_time: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> jnp.array:</span>
<span id="cb23-14">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""The Rental Inventory model. Each day returns occur as represented by a lognormal time to event distribution,</span></span>
<span id="cb23-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        and rentals occur as simulated by a poisson distribution and constrained physically by stock levels.</span></span>
<span id="cb23-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb23-17">        _, ys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> scan(</span>
<span id="cb23-18">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model_single_day, </span>
<span id="cb23-19">            init<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>init_state, </span>
<span id="cb23-20">            xs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>jnp.arange(start_time, end_time)</span>
<span id="cb23-21">        )</span>
<span id="cb23-22">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ys</span>
<span id="cb23-23"></span>
<span id="cb23-24">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> model_single_day(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, prev_state: Dict, time: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Tuple[Dict, jnp.array]:</span>
<span id="cb23-25">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Models a single day of inventory activity, including returns, rentals, and stock changes</span></span>
<span id="cb23-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb23-27">        curr_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>()</span>
<span id="cb23-28"></span>
<span id="cb23-29">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulate Returns</span></span>
<span id="cb23-30">        returns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.returns_model(prev_state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'existing_rentals'</span>], time)</span>
<span id="cb23-31">        curr_state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'starting_stock'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"starting_stock"</span>, prev_state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ending_stock'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> returns.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.apply_policy(time))</span>
<span id="cb23-32"></span>
<span id="cb23-33">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulate Rentals, incorporate them into the next state</span></span>
<span id="cb23-34">        rentals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.demand_model(available_stock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>curr_state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'starting_stock'</span>], time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>time)</span>
<span id="cb23-35">        curr_state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ending_stock'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ending_stock"</span>, curr_state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'starting_stock'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> rentals.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb23-36">        curr_state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'existing_rentals'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"existing_rentals"</span>, prev_state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'existing_rentals'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> returns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> rentals)</span>
<span id="cb23-37">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> curr_state, rentals</span>
<span id="cb23-38"></span>
<span id="cb23-39">    ...</span>
<span id="cb23-40">    </span></code></pre></div>
<p>The sub-models and methods referenced but not shown above are a little complicated and overwhelming with the array operations and logic however, so feel free to skim over this for now.</p>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> RentalInventory</span>
<span id="cb24-2">    </span>
<span id="cb24-3">    ...</span>
<span id="cb24-4">    </span>
<span id="cb24-5">    ...</span>
<span id="cb24-6"></span>
<span id="cb24-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> demand_model(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, available_stock, time):</span>
<span id="cb24-8">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Models the true demand each day.</span></span>
<span id="cb24-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb24-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">NotImplementedError</span>()</span>
<span id="cb24-11">    </span>
<span id="cb24-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> returns_model(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, existing_rentals: jnp.array, time: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> jnp.array:</span>
<span id="cb24-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Models the number of returns each date</span></span>
<span id="cb24-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb24-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Distribution of possible rental durations</span></span>
<span id="cb24-16">        theta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"theta"</span>, dist.Normal(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.9</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>))</span>
<span id="cb24-17">        sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma"</span>, dist.TruncatedNormal(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, low<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb24-18">        return_dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dist.LogNormal(theta, sigma)</span>
<span id="cb24-19"></span>
<span id="cb24-20">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the discrete hazard of rented out inventory from previous time-points being returned</span></span>
<span id="cb24-21">        discrete_hazards <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.survival_convolution(dist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>return_dist, time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>time)</span>
<span id="cb24-22"></span>
<span id="cb24-23">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulate returns from hazards</span></span>
<span id="cb24-24">        returns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"returns"</span>, dist.Binomial(existing_rentals.astype(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"int32"</span>), probs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>discrete_hazards))</span>
<span id="cb24-25">        total_returns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_returns"</span>, returns.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>())</span>
<span id="cb24-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> returns</span>
<span id="cb24-27">        </span>
<span id="cb24-28">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> survival_convolution(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, dist, time: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> jnp.array:</span>
<span id="cb24-29">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Calculates the probability of a return happening (discrete hazard rate) from all past time periods, returning an array where each index is a previous time period,</span></span>
<span id="cb24-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        and the value is the probability of a rental from that time being returned at the current date.</span></span>
<span id="cb24-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb24-32">        rental_durations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>jnp.arange(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.max_periods))</span>
<span id="cb24-33">        discrete_hazards <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.where(</span>
<span id="cb24-34">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If rental duration is nonnegative,</span></span>
<span id="cb24-35">            rental_durations<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb24-36">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use those rental durations to calculate a return rate, using a discrete interval hazard function</span></span>
<span id="cb24-37">            RentalInventory.hazard_func(jnp.clip(rental_durations, a_min<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), dist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dist ),</span>
<span id="cb24-38">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Otherwise, return rate is 0</span></span>
<span id="cb24-39">            <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb24-40">        )</span>
<span id="cb24-41">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> discrete_hazards</span>
<span id="cb24-42"></span>
<span id="cb24-43">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@staticmethod</span></span>
<span id="cb24-44">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> hazard_func(t, dist):</span>
<span id="cb24-45">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Discrete interval hazard function - aka the probability of a return occurring on a single date</span></span>
<span id="cb24-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb24-47">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (dist.cdf(t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>dist.cdf(t))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>dist.cdf(t))</span>
<span id="cb24-48"></span>
<span id="cb24-49">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> apply_policy(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, time):</span>
<span id="cb24-50">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Adds in some number of units for the product at time T=t</span></span>
<span id="cb24-51"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb24-52">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.policies[time]</span></code></pre></div>
<p>One key thing to note is the <code>demand_model</code> method raises a <code>NotImplementedError</code> the idea is that this base class can be inherited by other classes that may have different demand models. Even the returns model could be overwritten. Here’s an example of a poisson demand model:</p>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> PoissonDemandInventory(RentalInventory):</span>
<span id="cb25-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""A model of rental inventory, modeling stock levels as returns and rentals occur each day.</span></span>
<span id="cb25-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Currently supports a single product</span></span>
<span id="cb25-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb25-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, n_products: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, policies: np.ndarray <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb25-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(n_products, policies)</span>
<span id="cb25-7">        rng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.default_rng(seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span>)</span>
<span id="cb25-8"></span>
<span id="cb25-9">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Heterogeneity in true demand is lambd ~ Exp(5) distributed when using this class to simulate data from scratch</span></span>
<span id="cb25-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># When simulating demand based on an existing dataset, this can be overwritten</span></span>
<span id="cb25-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># i.e. `numpyro.do(inventory.demand_model, {"lambd": jnp.exp(U_hat)})`</span></span>
<span id="cb25-12">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.U <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.log( <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> rng.exponential( size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_products) )</span>
<span id="cb25-13"></span>
<span id="cb25-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> demand_model(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, available_stock, time):</span>
<span id="cb25-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Models the true demand each day.</span></span>
<span id="cb25-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb25-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_products"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_products) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> ind:</span>
<span id="cb25-18">            lambd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lambd"</span>, dist.Normal(jnp.exp(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.U[ind]), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>))</span>
<span id="cb25-19"></span>
<span id="cb25-20">        unconstrained_rentals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unconstrained_rentals"</span>, dist.Poisson(lambd))</span>
<span id="cb25-21">        rentals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rentals"</span>, jnp.clip(unconstrained_rentals, a_min<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, a_max<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>available_stock ))</span>
<span id="cb25-22">        rentals_as_arr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ( time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> jnp.arange(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.max_periods) )<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>rentals[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb25-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> rentals_as_arr</span></code></pre></div>
<p>Rentals are simulated according to a poisson distribution for each product, and if there isn’t enough stock, then rentals are constrained. For example:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Csmall%7B%0A%5Cdisplaylines%7B%0A%5Ctext%7Bdemand%7D_%7B%5Ctext%7B%5Bj,t%5D%7D%7D%20%5Csim%20%5Ctext%7BPoisson%7D(%5Clambda_%7B%5Ctext%7B%5Bj%5D%7D%7D)%20%5C%5C%0A%5Ctext%7Brentals%7D_%7B%5Ctext%7B%5Bj,t%5D%7D%7D%20=%20%5Ctext%7Bmin%7D(%5Ctext%7Bdemand%7D_%7B%5Ctext%7B%5Bj,t%5D%7D%7D,%5C%20%5Ctext%7Bstock%7D_%7B%5Ctext%7B%5Bj,t%5D%7D%7D)%20%5C%5C%0A%5Ctext%7Bfor%20%7Dj%20%5Cin%20J%20%5Ctext%7B%20products%7D%0A%7D%7D%0A"></p>
</section>
<section id="simulating-the-impact-of-reordering-more-units" class="level2">
<h2 class="anchored" data-anchor-id="simulating-the-impact-of-reordering-more-units">Simulating the impact of reordering more units</h2>
<p>There are some helper functions in the code block below that we’ll use. Feel free to skip past these. They’re used to transform data from long form into a wide form where time periods are the column axis and each product is an row.</p>
<div id="1d5d9582" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rental_model <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RentalInventory, PoissonDemandInventory, MultinomialDemandInventory</span>
<span id="cb26-2"></span>
<span id="cb26-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Helper functions</span></span>
<span id="cb26-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> sort_products(df):</span>
<span id="cb26-5">    idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(df.index.names)</span>
<span id="cb26-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> idx[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb26-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (</span>
<span id="cb26-8">            df.reset_index()</span>
<span id="cb26-9">            .assign(idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d.product_id.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>,expand<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>))</span>
<span id="cb26-10">            .sort_values(by<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"idx"</span>).drop(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'idx'</span>,axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'columns'</span>)</span>
<span id="cb26-11">            .set_index(idx)</span>
<span id="cb26-12">        )</span>
<span id="cb26-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb26-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (</span>
<span id="cb26-15">            df</span>
<span id="cb26-16">            .assign(idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d.product_id.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>,expand<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>))</span>
<span id="cb26-17">            .sort_values(by<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"idx"</span>).drop(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'idx'</span>,axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'columns'</span>)</span>
<span id="cb26-18">        )</span>
<span id="cb26-19"></span>
<span id="cb26-20"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_active_rentals_as_array(rentals: pd.DataFrame, max_periods: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.array:</span>
<span id="cb26-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Take a dataframe of rental data and convert it to an array of currently active rentals and the days they were initially rented.</span></span>
<span id="cb26-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Each array element corresponds to a single day, and the value is the amount of active rentals that are still</span></span>
<span id="cb26-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    out with customers that started on that date</span></span>
<span id="cb26-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb26-25">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _get_active_rentals_as_array(rentals, dates, max_periods<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>):</span>
<span id="cb26-26">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Gets currently active rentals for a single product</span></span>
<span id="cb26-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb26-28">        active_rentals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros(max_periods)</span>
<span id="cb26-29">        active_rentals[:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(dates)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (rentals.loc[<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d.return_date.isnull()].date.values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> dates[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb26-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> active_rentals</span>
<span id="cb26-31">    </span>
<span id="cb26-32">    start_date, end_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rentals.date.agg([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'min'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max'</span>])</span>
<span id="cb26-33">    dates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.date_range(start_date, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>end_date, freq<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>).values</span>
<span id="cb26-34">    products <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rentals.pipe(sort_products).product_id.unique()</span>
<span id="cb26-35">    active_rentals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros((<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(products), max_periods))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create an empty matrix to store results</span></span>
<span id="cb26-36"></span>
<span id="cb26-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Iterate through each product</span></span>
<span id="cb26-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> j, product_j <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(products):</span>
<span id="cb26-39">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store their currently active rentals </span></span>
<span id="cb26-40">        active_rentals[j] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _get_active_rentals_as_array(rentals.query(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"product_id==@product_j"</span>), dates<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dates, max_periods<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>max_periods)</span>
<span id="cb26-41">   </span>
<span id="cb26-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span>  active_rentals</span>
<span id="cb26-43"></span>
<span id="cb26-44"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> reorder_as_array(reorder_amount, reorder_time, max_periods<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>):</span>
<span id="cb26-45">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (jnp.arange(max_periods) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> reorder_time)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>reorder_amount</span></code></pre></div>
</details>
</div>
<p>The convenience function below combines all of the helper functions above to transform rental and stock data into a usable form for the model.</p>
<div id="2be2b7f3" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set initial state to last observed state in dataset</span></span>
<span id="cb27-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_current_state(rentals, stock):</span>
<span id="cb27-3">    active_rentals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_active_rentals_as_array(rentals)</span>
<span id="cb27-4">    latest_starting_stock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stock.query(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date==date.max()"</span>).pipe(sort_products).starting_units.values</span>
<span id="cb27-5">    latest_ending_stock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stock.query(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date==date.max()"</span>).pipe(sort_products).ending_units.values</span>
<span id="cb27-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(</span>
<span id="cb27-7">        starting_stock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>latest_starting_stock,</span>
<span id="cb27-8">        ending_stock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> latest_ending_stock,</span>
<span id="cb27-9">        existing_rentals<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>active_rentals</span>
<span id="cb27-10">    )</span>
<span id="cb27-11"></span>
<span id="cb27-12">init_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_current_state(</span>
<span id="cb27-13">    rentals<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>rentals.query(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"product_id=='product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>), </span>
<span id="cb27-14">    stock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>stock.query(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"product_id=='product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>))</span></code></pre></div>
</div>
<p>We can now simulate what might happen if we re-stocked different amounts.</p>
<div id="d28e841b" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Try adding new units at time T=100</span></span>
<span id="cb28-2">reorder_amount <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span></span>
<span id="cb28-3">reorder_policy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reorder_as_array(reorder_amount, reorder_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,:]</span>
<span id="cb28-4"></span>
<span id="cb28-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define Simulation</span></span>
<span id="cb28-6">nsamples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span></span>
<span id="cb28-7">rental_inventory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PoissonDemandInventory(n_products <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, policies<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>reorder_policy)</span>
<span id="cb28-8">simulation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.infer.Predictive(</span>
<span id="cb28-9">    rental_inventory.model, </span>
<span id="cb28-10">    num_samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nsamples,</span>
<span id="cb28-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Input our learned parameters from the previous models</span></span>
<span id="cb28-12">    posterior_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb28-13">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lambd"</span>:idata_demand[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lambd'</span>][:nsamples,[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], </span>
<span id="cb28-14">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"theta"</span>:idata[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'theta'</span>][:nsamples,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>],</span>
<span id="cb28-15">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma"</span>:idata[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sigma'</span>][:nsamples,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb28-16">    }</span>
<span id="cb28-17"></span>
<span id="cb28-18">)</span>
<span id="cb28-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run Simulation</span></span>
<span id="cb28-20">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> simulation(random.PRNGKey(SEED), init_state, start_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, end_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span></code></pre></div>
</div>
<p>The code above runs a full series of 250 simulations. Ideally in the future, the lambda parameter would be a forecast as opposed to just using the latest rental rate, but that’s a problem for later.</p>
<p>Let’s look at one potential outcome of the simulation. You can try re-running this multiple times to see a range of different outcomes that are all possible under this reorder policy. Most of these end up still being stocked out.</p>
<div id="29b5e3ed" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">sample_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.choice(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span>)</span>
<span id="cb29-2">dates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.date_range(rentals.date.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(), periods<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>, freq<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>)</span>
<span id="cb29-3"></span>
<span id="cb29-4">historical_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> daily_rentals.loc[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>]</span>
<span id="cb29-5">sim_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.Series(results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rentals'</span>][sample_idx,:].ravel(),  index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:] )</span>
<span id="cb29-6"> </span>
<span id="cb29-7">daily_rentals_j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat((historical_data.rentals, sim_data))</span>
<span id="cb29-8">daily_stock_j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.concatenate((historical_data.starting_units.values, results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'starting_stock'</span>][sample_idx,:].squeeze(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)))</span>
<span id="cb29-9"></span>
<span id="cb29-10">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_rentals(daily_rentals_j, daily_stock_j)</span>
<span id="cb29-11">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Simulated Stock Levels after Reordering </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>reorder_amount<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> units'</span>)</span>
<span id="cb29-12">ax.axvline(daily_rentals_j.index.values[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Reorder'</span>)</span>
<span id="cb29-13">ax.legend()</span>
<span id="cb29-14">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-27-output-1.png" width="1211" height="511" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can summarize all of these simulations with uncertainty intervals.</p>
<div id="98ff0f34" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb30-2">        gridspec_kw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(width_ratios<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>], height_ratios<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]), </span>
<span id="cb30-3">        sharex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, </span>
<span id="cb30-4">        figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb30-5"></span>
<span id="cb30-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot simulations</span></span>
<span id="cb30-7">daily_ending_stock_sim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ending_stock'</span>].squeeze(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb30-8">az.plot_hdi(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:], daily_ending_stock_sim, smooth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, fill_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>),)</span>
<span id="cb30-9">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].plot(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:], daily_ending_stock_sim.mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Simulated Stock Levels'</span>)</span>
<span id="cb30-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># axes[0].axvline(dates[60], color='C0',ls='--', label='Reorder (40 units)')</span></span>
<span id="cb30-11">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].axvline(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>,ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Reorder'</span>)</span>
<span id="cb30-12">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(</span>
<span id="cb30-13">    title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Simulated Stock Levels: what would happen after reordering </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>reorder_amount<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> units?'</span>,</span>
<span id="cb30-14">    ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Stock Levels'</span>,</span>
<span id="cb30-15">    xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span></span>
<span id="cb30-16">)</span>
<span id="cb30-17"></span>
<span id="cb30-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot actuals</span></span>
<span id="cb30-19">historical_data.ending_units.plot(color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Historical Stock Levels'</span>)</span>
<span id="cb30-20"></span>
<span id="cb30-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Overlay some simulations to confirm its lining up with the plot</span></span>
<span id="cb30-22">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].plot(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:], daily_ending_stock_sim[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,:].T, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb30-23">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].plot(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:], daily_ending_stock_sim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,:].T, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>,label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Individual Simulations'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb30-24">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].legend()</span>
<span id="cb30-25"></span>
<span id="cb30-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot stockouts</span></span>
<span id="cb30-27">historical_stockouts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dates[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>][(historical_data.ending_units<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).values]</span>
<span id="cb30-28">sim_stockouts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.unique(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:][np.where((daily_ending_stock_sim.T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]])</span>
<span id="cb30-29">axes[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].vlines(historical_stockouts,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb30-30">axes[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].vlines(sim_stockouts,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb30-31">axes[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_yticks([])</span>
<span id="cb30-32">axes[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].annotate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stockouts"</span>, xy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>),xycoords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'axes fraction'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb30-33"></span>
<span id="cb30-34">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-28-output-1.png" width="1211" height="611" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This view makes it a little more obvious that there are probably stockouts happening, but it doesn’t tell us for sure. We can actually calculate the stockout rate over time by averaging over all of the existing simulations and counting the number of simulations that have 0 stock each day.</p>
<p>We could also go back and update the simulator to log things like <em>“missed rentals due to stockouts”</em> or other quantities that might be helpful.</p>
<div id="3cd4858e" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb31-2">p_stockout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (daily_ending_stock_sim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb31-3">ax.plot(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>], p_stockout)</span>
<span id="cb31-4">ax.axvline(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Reorder Time'</span>)</span>
<span id="cb31-5">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Estimated Stockout Probability after reordering </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>reorder_amount<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> units'</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Stockout Rate'</span>)</span>
<span id="cb31-6">ax.legend()</span>
<span id="cb31-7">ax.yaxis.set_major_formatter(mtick.PercentFormatter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb31-8">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-29-output-1.png" width="1211" height="511" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It appears that the current reorder guidance isn’t enough - so what should reorder? Lets try and estimate what would happen if we reordered more.</p>
<div id="60c39040" class="cell" data-execution_count="29">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Try estimating the impact of 500 new units at time T=100</span></span>
<span id="cb32-2">reorder_amount <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span></span>
<span id="cb32-3">reorder_policy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reorder_as_array(reorder_amount, reorder_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,:]</span>
<span id="cb32-4"></span>
<span id="cb32-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define Simulation</span></span>
<span id="cb32-6">nsamples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span></span>
<span id="cb32-7">rental_inventory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PoissonDemandInventory(n_products <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, policies<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>reorder_policy)</span>
<span id="cb32-8"></span>
<span id="cb32-9">simulation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.infer.Predictive(</span>
<span id="cb32-10">    rental_inventory.model, </span>
<span id="cb32-11">    num_samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nsamples,</span>
<span id="cb32-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Input our learned parameters from the previous models</span></span>
<span id="cb32-13">    posterior_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb32-14">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lambd"</span>:idata_demand[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lambd'</span>][:nsamples,[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], </span>
<span id="cb32-15">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"theta"</span>:idata[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'theta'</span>][:nsamples,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>],</span>
<span id="cb32-16">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma"</span>:idata[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sigma'</span>][:nsamples,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb32-17">    }</span>
<span id="cb32-18"></span>
<span id="cb32-19">)</span>
<span id="cb32-20"></span>
<span id="cb32-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run Simulation</span></span>
<span id="cb32-22">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> simulation(random.PRNGKey(SEED), init_state, start_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, end_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb32-23"></span>
<span id="cb32-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot</span></span>
<span id="cb32-25">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb32-26">        gridspec_kw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(width_ratios<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>], height_ratios<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]), </span>
<span id="cb32-27">        sharex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, </span>
<span id="cb32-28">        figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb32-29"></span>
<span id="cb32-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot simulations</span></span>
<span id="cb32-31">daily_ending_stock_sim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ending_stock'</span>].squeeze(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb32-32">az.plot_hdi(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:], daily_ending_stock_sim, smooth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, fill_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>),)</span>
<span id="cb32-33">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].plot(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:], daily_ending_stock_sim.mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Simulated Stock Levels'</span>)</span>
<span id="cb32-34">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].axvline(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>,ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Reorder'</span>)</span>
<span id="cb32-35">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(</span>
<span id="cb32-36">    title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Simulated Stock Levels: what would happen after reordering </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>reorder_amount<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> units?'</span>,</span>
<span id="cb32-37">    ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Stock Levels'</span>,</span>
<span id="cb32-38">    xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span></span>
<span id="cb32-39">)</span>
<span id="cb32-40"></span>
<span id="cb32-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot actuals</span></span>
<span id="cb32-42">historical_data.ending_units.plot(color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Historical Stock Levels'</span>)</span>
<span id="cb32-43"></span>
<span id="cb32-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Overlay some simulations to confirm it is lining up with the plot</span></span>
<span id="cb32-45">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].plot(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:], daily_ending_stock_sim[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,:].T, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb32-46">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].plot(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:], daily_ending_stock_sim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,:].T, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>,label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Individual Simulations'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb32-47">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].legend()</span>
<span id="cb32-48"></span>
<span id="cb32-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot stockouts</span></span>
<span id="cb32-50">axes[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].vlines(dates[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>][(historical_data.ending_units<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).values],<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb32-51">axes[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].vlines(np.unique(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:][np.where((daily_ending_stock_sim.T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]]),<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb32-52">axes[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_yticks([])</span>
<span id="cb32-53">axes[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].annotate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stockouts"</span>, xy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>),xycoords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'axes fraction'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb32-54"></span>
<span id="cb32-55">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-30-output-1.png" width="1211" height="611" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Clearly this is now way too much stock and we’d be over-ordering. So how can we identify the right amount to stock so that we don’t have stockouts but we don’t over-order?</p>
<p>We could just simulate repeatedly with different stock reorder inputs like below.</p>
<div id="09e04fc6" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> sim_stockout_rate(stock_reorder, lambd, samples_per_iter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>):    </span>
<span id="cb33-2">    </span>
<span id="cb33-3">    init_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_current_state(</span>
<span id="cb33-4">        rentals<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>rentals.query(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"product_id=='product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>),</span>
<span id="cb33-5">        stock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>stock.query(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"product_id=='product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>)</span>
<span id="cb33-6">    )</span>
<span id="cb33-7"></span>
<span id="cb33-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Try adding x new units at time T=100</span></span>
<span id="cb33-9">    reorder_policy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reorder_as_array(stock_reorder, reorder_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,:]</span>
<span id="cb33-10">    rental_inventory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PoissonDemandInventory(n_products <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, policies<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>reorder_policy)</span>
<span id="cb33-11"></span>
<span id="cb33-12">    simulation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.infer.Predictive(</span>
<span id="cb33-13">        rental_inventory.model, </span>
<span id="cb33-14">        num_samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> samples_per_iter,</span>
<span id="cb33-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Input our learned parameters from the previous models</span></span>
<span id="cb33-16">        posterior_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb33-17">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use the latest demand sample from the last date as a simple approach for now</span></span>
<span id="cb33-18">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lambd"</span>: lambd[:samples_per_iter], </span>
<span id="cb33-19">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use rental duration parameter estimates</span></span>
<span id="cb33-20">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"theta"</span>: idata[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'theta'</span>][:samples_per_iter,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>],</span>
<span id="cb33-21">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma"</span>: idata[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sigma'</span>][:samples_per_iter,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb33-22">        }</span>
<span id="cb33-23">    )</span>
<span id="cb33-24">    results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> simulation(random.PRNGKey(SEED), init_state, start_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, end_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb33-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Only going to care about instock rate for the second half of the simulation to be safe</span></span>
<span id="cb33-26">    burn_in <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span></span>
<span id="cb33-27">    stockout_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ending_stock'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)[burn_in:].mean()</span>
<span id="cb33-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> stockout_rate</span>
<span id="cb33-29"></span>
<span id="cb33-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run simulations</span></span>
<span id="cb33-31">stockout_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.empty((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb33-32"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, units <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">450</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)):</span>
<span id="cb33-33">    stockout_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sim_stockout_rate(units, lambd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>idata_demand[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lambd'</span>][...,[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]])</span>
<span id="cb33-34">    stockout_results[i,:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [units, stockout_rate]</span>
<span id="cb33-35"></span>
<span id="cb33-36">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb33-37">ax.plot(stockout_results[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], stockout_results[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb33-38">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Est. Stockout Rate'</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Units Reordered'</span>, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Estimated Stockout Rate as we reorder more units'</span>)</span>
<span id="cb33-39">plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-31-output-1.png" width="791" height="491" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It’s clear that right around 300 units is when the probability of a stockout gets really low. We could speed this up if we wanted by building an optimizer. One easy way might be to build a binary search algorithm that gets you the minimum amount of stock without having any stockouts.</p>
<p>That’s an exercise for another time. Let’s reorder the recommended 300 units and see what happens.</p>
<div id="b1d3347a" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">init_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_current_state(rentals<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>rentals, stock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>stock)</span>
<span id="cb34-2"></span>
<span id="cb34-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Try adding x new units at time T=100</span></span>
<span id="cb34-4">reorder_amount <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span></span>
<span id="cb34-5">reorder_policy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.zeros((J_PRODUCTS, MAX_PERIODS)).at[j,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(reorder_amount)</span>
<span id="cb34-6">rental_inventory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MultinomialDemandInventory(n_products<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>J_PRODUCTS, policies<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>reorder_policy)</span>
<span id="cb34-7"></span>
<span id="cb34-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only simulate 1 sample - we're going to use the true data generating process </span></span>
<span id="cb34-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to pretend we actually reordered this amount of units and watched what happened afterward</span></span>
<span id="cb34-10">observe_future <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.infer.Predictive( rental_inventory.model, num_samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb34-11">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> observe_future(random.PRNGKey(SEED), init_state, start_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, end_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span></code></pre></div>
</div>
<p>Notice that this time we’re not loading in any parameters into the <code>Predictive</code> call. That’s because we’re using the true data-generating process to simulate what happens this time. We’re basically observing one possible future in the original fake world we created.</p>
<div id="f73e34a0" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb35-2">        gridspec_kw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(width_ratios<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>], height_ratios<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]), </span>
<span id="cb35-3">        sharex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, </span>
<span id="cb35-4">        figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb35-5"></span>
<span id="cb35-6">daily_ending_stock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat((</span>
<span id="cb35-7">    daily_rentals.loc[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>].ending_units,</span>
<span id="cb35-8">    pd.Series(results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ending_stock'</span>][..., j].squeeze(), index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:])</span>
<span id="cb35-9">))</span>
<span id="cb35-10"></span>
<span id="cb35-11">daily_ending_stock.plot(color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Stock Levels'</span>)</span>
<span id="cb35-12">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].axvline(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>,ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Reorder'</span>)</span>
<span id="cb35-13">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(</span>
<span id="cb35-14">    title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Observed Stock Levels after reordering </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>reorder_amount<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> units'</span>,</span>
<span id="cb35-15">    ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Stock Levels'</span>,</span>
<span id="cb35-16">    xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Date'</span></span>
<span id="cb35-17">)</span>
<span id="cb35-18">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].axhline(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb35-19">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].legend()</span>
<span id="cb35-20"></span>
<span id="cb35-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot stockouts</span></span>
<span id="cb35-22">axes[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].vlines(dates[(daily_ending_stock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).values],<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb35-23">axes[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_yticks([])</span>
<span id="cb35-24">axes[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].annotate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stockouts"</span>, xy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>),xycoords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'axes fraction'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb35-25"></span>
<span id="cb35-26">fig.subplots_adjust(hspace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-33-output-1.png" width="1211" height="611" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Amazing, by reordering 300 units, we no longer ran into any stockouts! This is exactly what we were hoping for.</p>
<p>We now have a system we can use to figure out the optimal stock to reorder for a single product. How can we now scale this to our entire inventory, or even inform the purchasing of new products?</p>
</section>
<section id="can-we-do-something-more-simple" class="level2">
<h2 class="anchored" data-anchor-id="can-we-do-something-more-simple">Can we do something more simple?</h2>
<p>Was all of this really necessary? Let’s see for ourselves by taking a naive approach. We’ll fit a basic regression where we control for the global stockout rate and dummy-encode stockouts - meant to represent a basic tabular data science approach.</p>
<div id="d84bb2d5" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> statsmodels.api <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sm</span>
<span id="cb36-2">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sm.OLS.from_formula(</span>
<span id="cb36-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rentals ~ total_stockout_rate + stockout"</span>, </span>
<span id="cb36-4">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>daily_rentals.query(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"product_id=='product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>)</span>
<span id="cb36-5">).fit()</span>
<span id="cb36-6"></span>
<span id="cb36-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Predict the latest demand rate as if it didnt have a stockout</span></span>
<span id="cb36-8">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> daily_rentals.query(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"product_id=='product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>).tail(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).assign(stockout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb36-9">fcast <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.predict(X)</span></code></pre></div>
</div>
<div id="ecbe8c12" class="cell" data-execution_count="34">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">naive_rental_rate_fcast <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.vstack([fcast <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)]) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># broadcast the forecast</span></span>
<span id="cb37-2"></span>
<span id="cb37-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulate what would happen under different reorder amounts based on naive demand estimate</span></span>
<span id="cb37-4">stockout_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.empty((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb37-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, units <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">450</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)):</span>
<span id="cb37-6">    stockout_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sim_stockout_rate(units, lambd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>naive_rental_rate_fcast)</span>
<span id="cb37-7">    stockout_results[i,:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [units, stockout_rate]</span>
<span id="cb37-8"></span>
<span id="cb37-9">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb37-10">ax.plot(stockout_results[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], stockout_results[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb37-11">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Est. Stockout Rate'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb37-12">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Units Reordered'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb37-13">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Naive Approach:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Estimated Stockout Rate as we reorder more units'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb37-14">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-35-output-1.png" width="511" height="311" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can see that this approach leads to a recommendation of 200 units reordered. Is that reasonable? Let’s see what happens.</p>
<div id="475c384b" class="cell" data-execution_count="35">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">init_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_current_state(rentals<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>rentals, stock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>stock)</span>
<span id="cb38-2"></span>
<span id="cb38-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Try adding x new units at time T=100</span></span>
<span id="cb38-4">reorder_amount <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span></span>
<span id="cb38-5">reorder_policy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.zeros((J_PRODUCTS, MAX_PERIODS)).at[j,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(reorder_amount)</span>
<span id="cb38-6">rental_inventory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MultinomialDemandInventory(n_products<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>J_PRODUCTS, policies<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>reorder_policy)</span>
<span id="cb38-7"></span>
<span id="cb38-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only simulate 1 sample - we're going to use the true data generating process </span></span>
<span id="cb38-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to pretend we actually reordered this amount of units and watched what happened afterward</span></span>
<span id="cb38-10">observe_future <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.infer.Predictive( rental_inventory.model, num_samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb38-11">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> observe_future(random.PRNGKey(SEED), init_state, start_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, end_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb38-12"></span>
<span id="cb38-13">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb38-14">        gridspec_kw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(width_ratios<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>], height_ratios<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]), </span>
<span id="cb38-15">        sharex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, </span>
<span id="cb38-16">        figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb38-17"></span>
<span id="cb38-18">daily_ending_stock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat((</span>
<span id="cb38-19">    daily_rentals.loc[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'product_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>].ending_units,</span>
<span id="cb38-20">    pd.Series(results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ending_stock'</span>][..., j].squeeze(), index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:])</span>
<span id="cb38-21">))</span>
<span id="cb38-22"></span>
<span id="cb38-23">daily_ending_stock.plot(color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Stock Levels'</span>)</span>
<span id="cb38-24">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].axvline(dates[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>,ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Reorder'</span>)</span>
<span id="cb38-25">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(</span>
<span id="cb38-26">    ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Stock Levels'</span>, </span>
<span id="cb38-27">    xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Date'</span>, </span>
<span id="cb38-28">    title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Naive Approach: Observed Stock Levels after reordering </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>reorder_amount<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> units'</span>)</span>
<span id="cb38-29">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].axhline(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb38-30">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].legend()</span>
<span id="cb38-31"></span>
<span id="cb38-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot stockouts</span></span>
<span id="cb38-33">axes[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].vlines(dates[(daily_ending_stock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).values],<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb38-34">axes[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_yticks([])</span>
<span id="cb38-35">axes[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].annotate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stockouts"</span>, xy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>),xycoords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'axes fraction'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb38-36"></span>
<span id="cb38-37">fig.subplots_adjust(hspace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand_files/figure-html/cell-36-output-1.png" width="1211" height="611" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As we can see above, using more traditional tabular machine learning methods just don’t cut it. This problem needs the more advanced model structure that we had implemented above.</p>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<hr>
<p>This was a difficult problem that didn’t fall under the lens of a classic tabular data science problem. By using first principles, it’s possible to break down the problem into more explainable pieces. The data generating process was the following:</p>
<ol type="1">
<li>Customers come in and rent <img src="https://latex.codecogs.com/png.latex?y%20%5Csim%20%5Ctext%7Bmin%7D(%5Ctext%7BPoisson%7D(%5Clambda),%20%5Ctext%7Bstock%7D)"> units each day</li>
<li>Those units tend to have some learnable distribution of rental duration, <img src="https://latex.codecogs.com/png.latex?t%20%5Csim%20%5Ctext%7BLogNormal%7D(%5Ctheta,%20%5Csigma)"></li>
<li>The stock levels vary as those rentals occur and get returned</li>
</ol>
<p>We found that modeling each individual component of the data generating process and combining them into a simulation was sufficient to inform a reorder for a product and is also very explainable.</p>
<p>This can also be extended further to answer different sorts of questions - what happens to total daily rentals as customer count grows? Which levers increase customer count the most? How much more inventory do we need to support more subscribers?</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 304.43 260.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 256)">
<polygon fill="white" stroke="transparent" points="-4,4 -4,-256 300.43,-256 300.43,4 -4,4"></polygon>
<!-- p -->
<g id="node1" class="node">
<title>p</title>
<ellipse fill="none" stroke="black" cx="30.88" cy="-234" rx="30.76" ry="18"></ellipse>
<text text-anchor="middle" x="30.88" y="-229.8" font-family="Times,serif" font-size="14.00">Price</text>
</g>
<!-- x -->
<g id="node4" class="node">
<title>x</title>
<ellipse fill="none" stroke="black" cx="138.88" cy="-162" rx="52.2" ry="18"></ellipse>
<text text-anchor="middle" x="138.88" y="-157.8" font-family="Times,serif" font-size="14.00">Customers</text>
</g>
<!-- p&#45;&gt;x -->
<g id="edge3" class="edge">
<title>p-&gt;x</title>
<path fill="none" stroke="black" d="M50.69,-220.16C66.39,-209.99 88.64,-195.56 106.86,-183.75"></path>
<polygon fill="black" stroke="black" points="108.95,-186.57 115.44,-178.19 105.14,-180.7 108.95,-186.57"></polygon>
</g>
<!-- c -->
<g id="node2" class="node">
<title>c</title>
<ellipse fill="none" stroke="black" cx="138.88" cy="-234" rx="58.57" ry="18"></ellipse>
<text text-anchor="middle" x="138.88" y="-229.8" font-family="Times,serif" font-size="14.00">Competitors</text>
</g>
<!-- c&#45;&gt;x -->
<g id="edge1" class="edge">
<title>c-&gt;x</title>
<path fill="none" stroke="black" d="M138.88,-215.7C138.88,-207.98 138.88,-198.71 138.88,-190.11"></path>
<polygon fill="black" stroke="black" points="142.38,-190.1 138.88,-180.1 135.38,-190.1 142.38,-190.1"></polygon>
</g>
<!-- d -->
<g id="node3" class="node">
<title>d</title>
<ellipse fill="none" stroke="black" cx="255.88" cy="-234" rx="40.6" ry="18"></ellipse>
<text text-anchor="middle" x="255.88" y="-229.8" font-family="Times,serif" font-size="14.00">Promos</text>
</g>
<!-- d&#45;&gt;x -->
<g id="edge2" class="edge">
<title>d-&gt;x</title>
<path fill="none" stroke="black" d="M232.76,-219.17C215.63,-208.92 192.01,-194.79 172.75,-183.27"></path>
<polygon fill="black" stroke="black" points="174.35,-180.14 163.97,-178.01 170.76,-186.15 174.35,-180.14"></polygon>
</g>
<!-- Y -->
<g id="node5" class="node">
<title>Y</title>
<ellipse fill="none" stroke="black" cx="138.88" cy="-90" rx="62.59" ry="18"></ellipse>
<text text-anchor="middle" x="138.88" y="-85.8" font-family="Times,serif" font-size="14.00">Total Rentals</text>
</g>
<!-- x&#45;&gt;Y -->
<g id="edge4" class="edge">
<title>x-&gt;Y</title>
<path fill="none" stroke="black" d="M138.88,-143.7C138.88,-135.98 138.88,-126.71 138.88,-118.11"></path>
<polygon fill="black" stroke="black" points="142.38,-118.1 138.88,-108.1 135.38,-118.1 142.38,-118.1"></polygon>
</g>
<!-- y_j -->
<g id="node6" class="node">
<title>y_j</title>
<ellipse fill="none" stroke="black" cx="138.88" cy="-18" rx="49.26" ry="18"></ellipse>
<text text-anchor="middle" x="138.88" y="-13.8" font-family="Times,serif" font-size="14.00">Stockouts</text>
</g>
<!-- Y&#45;&gt;y_j -->
<g id="edge5" class="edge">
<title>Y-&gt;y_j</title>
<path fill="none" stroke="black" d="M138.88,-71.7C138.88,-63.98 138.88,-54.71 138.88,-46.11"></path>
<polygon fill="black" stroke="black" points="142.38,-46.1 138.88,-36.1 135.38,-46.1 142.38,-46.1"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="next-steps-modeling-a-full-product-assortment" class="level1">
<h1>Next Steps: Modeling a full product assortment</h1>
<hr>
<p>Here’s a quick glimpse of whats next.</p>
<p>We’re going to borrow ideas from discrete choice literature (see <a href="https://eml.berkeley.edu/books/choice2.html">Kenneth Train’s Discrete Choice Methods with Simulation</a>) - each product has some inherent utility, <img src="https://latex.codecogs.com/png.latex?U">, which determines how often it is chosen.</p>
<p>A decision maker, <img src="https://latex.codecogs.com/png.latex?n">, has <img src="https://latex.codecogs.com/png.latex?J"> products they can choose from. The utility of a given product, <img src="https://latex.codecogs.com/png.latex?j"> for a given user <img src="https://latex.codecogs.com/png.latex?n"> is</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AU_%7Bnj%7D%20%5Csim%20%5Cbeta%20%5C:%20x_%7Bnj%7D%20+%20%5Cepsilon_%7Bnj%7D%0A"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cepsilon_%7Bnj%7D"> is an error term that follows a Gumbel distribution. Date effects can also be added, for instance sweaters may have higher utility in the winter. We’ll keep it more basic for now and avoid date effects.</p>
<p>Why are we using this seemingly complicated representation? It has some really nice properties - namely that utilities are easy to convert to choice probabilities, even when the choice set (in this case the available product catalog) changes. All you have to do is take your utilities and feed them into a softmax equation to get choice probabilities for each product.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap_%7Bnj%7D%20=%20%5Ctext%7Bsoftmax%7D(U_%7Bnj%7D)%0A"></p>
<p>This is particularly helpful for this sort of problem, because the choice set is frequently changing for customers as products go in and out of stock.</p>
<p>We’re going to make one key simplification here - we’re going to measure utility for the population as a whole, and not condition on individual user features - since our goal right now is just to know how much stock to reorder, we don’t really need to know heterogeneity in demand across users unless we expect a big shift in our customer mix in the near term.</p>
<p>We can define a Multinomial Logit based inventory process as follows</p>
<div class="sourceCode" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> MultinomialDemandInventory(RentalInventory):</span>
<span id="cb39-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""A model of rental inventory, modeling stock levels as returns and rentals occur each day.</span></span>
<span id="cb39-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Currently supports a single product</span></span>
<span id="cb39-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb39-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, n_products: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, policies: np.ndarray <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb39-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(n_products, policies)</span>
<span id="cb39-7">    </span>
<span id="cb39-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> demand_model(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, available_stock, time):</span>
<span id="cb39-9">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Models the true demand each day.</span></span>
<span id="cb39-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb39-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Hyperparameters</span></span>
<span id="cb39-12">        lambd_total <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lambd"</span>, dist.Normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>))</span>
<span id="cb39-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> numpyro.plate(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_products"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_products):</span>
<span id="cb39-14">            utility <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utility"</span>, dist.Gumbel(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>))</span>
<span id="cb39-15">        </span>
<span id="cb39-16">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generative model</span></span>
<span id="cb39-17">        total_rentals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_rentals"</span>, dist.Poisson(lambd_total))</span>
<span id="cb39-18"></span>
<span id="cb39-19">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Log measures of unconstrained demand</span></span>
<span id="cb39-20">        avl_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.where(available_stock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb39-21">        p_j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jax.nn.softmax(utility, where<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>avl_idx, initial<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb39-22">        _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unconstrained_demand"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.total_rental_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p_j)</span>
<span id="cb39-23">        _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.sample(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unconstrained_rentals"</span>, dist.Multinomial(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.total_rental_rate, p_j))</span>
<span id="cb39-24"></span>
<span id="cb39-25">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulate from censored multinomial</span></span>
<span id="cb39-26">        rentals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numpyro.deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rentals"</span>, </span>
<span id="cb39-27">                    RentalInventory.censored_multinomial(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>total_rentals, U_j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>utility, stock_j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>available_stock)</span>
<span id="cb39-28">        )</span>
<span id="cb39-29">        rentals_as_arr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ( time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> jnp.arange(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.max_periods) )<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>rentals[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb39-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> rentals_as_arr.astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>)</span></code></pre></div>
<p>This work will be continued in a follow up blog post. The code this is based off of can be found <a href="https://github.com/kylejcaron/case_studies/tree/main/censored_demand">here</a>.</p>


</section>

 ]]></description>
  <category>Time Series</category>
  <category>Demand Modeling</category>
  <category>Causal Inference</category>
  <category>Supply Chain</category>
  <category>Discrete Choice</category>
  <category>Survival Analysis</category>
  <guid>https://kylejcaron.github.io/posts/censored_demand/2024-02-06-censored-demand.html</guid>
  <pubDate>Sun, 09 Jul 2023 04:00:00 GMT</pubDate>
  <media:content url="https://kylejcaron.github.io/posts/censored_demand/preview_image.png" medium="image" type="image/png" height="72" width="144"/>
</item>
<item>
  <title>Introduction to Surrogate Indexes</title>
  <link>https://kylejcaron.github.io/posts/surrogates/2023-07-09-surrogate_index_intro.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>How should you design your experiments if the metric you want to change might take months to observe?</p>
<p>Inspired by <a href="https://www.nber.org/system/files/working_papers/w26463/w26463.pdf">Susan Athey’s paper on Surrogate indexes</a> and another working paper, <a href="https://ide.mit.edu/wp-content/uploads/2020/12/Targeting-for-long-term-outcomes.pdf?x73880">Target for Long Term Outcomes</a>, I’ve wanted to share my learnings about surrogate indexes for a long time.</p>
<p>I’m hoping to cover the following in a series of blog posts:</p>
<ol type="1">
<li><p>The surrogate index estimator</p></li>
<li><p>Surrogate Index in practice</p>
<ul>
<li>Fitting a surrogate index on a realistic dataset</li>
<li>Validating the surrogate index over a set of historical experiments</li>
</ul></li>
<li><p>Targeting Long Term Outcomes</p>
<ul>
<li>Optimizing a policy</li>
<li>Attempting multi-armed bandits for early optimization</li>
</ul></li>
</ol>
<p>By simulating the data generating process from scratch, I hope this can also be a helpful tool for others to build on so they can answer their own questions they may have about estimating Long Term Treatment Effects.</p>
</section>
<section id="background" class="level1">
<h1>Background</h1>
<p><strong>Surrogate indexes</strong> are an unbiased way to predict a long term treatment effect from an experiment, but of course they’re only unbiased if done correctly which is no easy feat.</p>
<p>At Policygenius, customers would take a long time to convert to a sale, and we found that optimizing for middle of the funnel was too easy to game - often we’d have hugely successful experiments that improved the whole top half of the funnel but we wouldn’t see any improvement in our true-north metric 6 months later, conversion to sale. Surrogate indexes were a natural way to try and solve that problem. <a href="https://arxiv.org/pdf/2106.01421.pdf">LinkedIn also has a case study</a> on their need to optimize long term outcomes and how they’re using surrogate indexes which is worth a read.</p>
</section>
<section id="the-surrogate-index-approach" class="level1">
<h1>The Surrogate Index Approach</h1>
<p>Surrogate indexes are a way to use short term proxies to estimate long-term treatment effects. For instance, lets say you’re a subscription company and you want to see how some intervention improves retention. But churn takes a long time to observe, so your experiment could go on for months. <strong>TLDR;</strong> is that with this approach, instead of measuring churn as your <strong>overall evaluation criteria (OEC</strong>), you measure <code>predicted churn</code> (with some caveats) as the OEC.</p>
<p>A common response might be “thats complicated, can we try something more simple for now?” Of course you can. You can always try to choose some single short term proxy as your OEC for an experiment. But be careful because you could end up over-optimizing that proxy and not seeing the improvement in your long term outcome that you want. Surrogate indexes instead have many short term proxies, and they are validated over a set of historical data to ensure they’re an unbiased estimator of long term treatment effects.</p>
<p>How do they work? Let’s start with a DAG</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 134.00 188.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-184 130,-184 130,4 -4,4"></polygon>
<!-- X -->
<g id="node1" class="node">
<title>X</title>
<ellipse fill="none" stroke="black" cx="27" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-157.8" font-family="Times,serif" font-size="14.00">X</text>
</g>
<!-- S -->
<g id="node2" class="node">
<title>S</title>
<ellipse fill="none" stroke="black" cx="63" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="63" y="-85.8" font-family="Times,serif" font-size="14.00">S</text>
</g>
<!-- X&#45;&gt;S -->
<g id="edge1" class="edge">
<title>X-&gt;S</title>
<path fill="none" stroke="black" d="M35.35,-144.76C39.71,-136.28 45.15,-125.71 50.04,-116.2"></path>
<polygon fill="black" stroke="black" points="53.23,-117.64 54.7,-107.15 47.01,-114.44 53.23,-117.64"></polygon>
</g>
<!-- Y -->
<g id="node4" class="node">
<title>Y</title>
<ellipse fill="none" stroke="black" cx="63" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="63" y="-13.8" font-family="Times,serif" font-size="14.00">Y</text>
</g>
<!-- S&#45;&gt;Y -->
<g id="edge3" class="edge">
<title>S-&gt;Y</title>
<path fill="none" stroke="black" d="M63,-71.7C63,-63.98 63,-54.71 63,-46.11"></path>
<polygon fill="black" stroke="black" points="66.5,-46.1 63,-36.1 59.5,-46.1 66.5,-46.1"></polygon>
</g>
<!-- Tx -->
<g id="node3" class="node">
<title>Tx</title>
<ellipse fill="none" stroke="black" cx="99" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-157.8" font-family="Times,serif" font-size="14.00">Tx</text>
</g>
<!-- Tx&#45;&gt;S -->
<g id="edge2" class="edge">
<title>Tx-&gt;S</title>
<path fill="none" stroke="black" d="M90.65,-144.76C86.29,-136.28 80.85,-125.71 75.96,-116.2"></path>
<polygon fill="black" stroke="black" points="78.99,-114.44 71.3,-107.15 72.77,-117.64 78.99,-114.44"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>DAGs are diagrams, where the arrows represent causal effects. In this case, there’s some set of customer features <img src="https://latex.codecogs.com/png.latex?X">, that influence some set of short term outcomes, <img src="https://latex.codecogs.com/png.latex?S"> (a surrogate index).</p>
<p>There’s also a treatment, <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BTx%7D">, that influences <img src="https://latex.codecogs.com/png.latex?S">. It may influence different short term outcomes in S in different ways.</p>
<p>Lastly there’s <img src="https://latex.codecogs.com/png.latex?Y">, our long-term outcome of interest. Notice that all of the effect of the treatment on <img src="https://latex.codecogs.com/png.latex?Y"> flows through <img src="https://latex.codecogs.com/png.latex?S">. This is saying that the entire causal effect of the treatment on <img src="https://latex.codecogs.com/png.latex?Y"> is explained by the effect of the treatment on <img src="https://latex.codecogs.com/png.latex?S">. Keep note of that, because its a key assumption for Surrogate Indexes to work.</p>
<p>A more detailed way to show this is through the use of <a href="https://academic.oup.com/ije/article/50/2/613/5998421">IDAGs</a>, a newer way to represent DAGs with interactions</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 220.79 188.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<polygon fill="white" stroke="transparent" points="-4,4 -4,-184 216.79,-184 216.79,4 -4,4"></polygon>
<!-- x -->
<g id="node1" class="node">
<title>x</title>
<ellipse fill="none" stroke="black" cx="27" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-157.8" font-family="Times,serif" font-size="14.00">X</text>
</g>
<!-- s -->
<g id="node2" class="node">
<title>s</title>
<ellipse fill="none" stroke="black" cx="61" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="61" y="-85.8" font-family="Times,serif" font-size="14.00">S</text>
</g>
<!-- x&#45;&gt;s -->
<g id="edge1" class="edge">
<title>x-&gt;s</title>
<path fill="none" stroke="black" d="M34.89,-144.76C38.9,-136.49 43.89,-126.23 48.42,-116.9"></path>
<polygon fill="black" stroke="black" points="51.7,-118.16 52.92,-107.63 45.4,-115.1 51.7,-118.16"></polygon>
</g>
<!-- y -->
<g id="node3" class="node">
<title>y</title>
<ellipse fill="none" stroke="black" cx="61" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="61" y="-13.8" font-family="Times,serif" font-size="14.00">Y</text>
</g>
<!-- s&#45;&gt;y -->
<g id="edge3" class="edge">
<title>s-&gt;y</title>
<path fill="none" stroke="black" d="M61,-71.7C61,-63.98 61,-54.71 61,-46.11"></path>
<polygon fill="black" stroke="black" points="64.5,-46.1 61,-36.1 57.5,-46.1 64.5,-46.1"></polygon>
</g>
<!-- t -->
<g id="node4" class="node">
<title>t</title>
<ellipse fill="none" stroke="black" cx="99" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-157.8" font-family="Times,serif" font-size="14.00">Tx</text>
</g>
<!-- t&#45;&gt;s -->
<g id="edge2" class="edge">
<title>t-&gt;s</title>
<path fill="none" stroke="black" d="M90.19,-144.76C85.58,-136.28 79.84,-125.71 74.68,-116.2"></path>
<polygon fill="black" stroke="black" points="77.61,-114.27 69.77,-107.15 71.46,-117.61 77.61,-114.27"></polygon>
</g>
<!-- X -->
<g id="node5" class="node">
<title>X</title>
<ellipse fill="none" stroke="black" cx="176" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="176" y="-157.8" font-family="Times,serif" font-size="14.00">X</text>
</g>
<!-- ΔS_Tx -->
<g id="node6" class="node">
<title>ΔS_Tx</title>
<ellipse fill="none" stroke="black" cx="176" cy="-90" rx="36.58" ry="18"></ellipse>
<text text-anchor="middle" x="176" y="-85.8" font-family="Times,serif" font-size="14.00">ΔS_Tx</text>
</g>
<!-- X&#45;&gt;ΔS_Tx -->
<g id="edge4" class="edge">
<title>X-&gt;ΔS_Tx</title>
<path fill="none" stroke="black" d="M176,-143.7C176,-135.98 176,-126.71 176,-118.11"></path>
<polygon fill="black" stroke="black" points="179.5,-118.1 176,-108.1 172.5,-118.1 179.5,-118.1"></polygon>
</g>
<!-- Y -->
<g id="node7" class="node">
<title>Y</title>
<ellipse fill="none" stroke="black" cx="176" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="176" y="-13.8" font-family="Times,serif" font-size="14.00">Y</text>
</g>
<!-- ΔS_Tx&#45;&gt;Y -->
<g id="edge5" class="edge">
<title>ΔS_Tx-&gt;Y</title>
<path fill="none" stroke="black" d="M176,-71.7C176,-63.98 176,-54.71 176,-46.11"></path>
<polygon fill="black" stroke="black" points="179.5,-46.1 176,-36.1 172.5,-46.1 179.5,-46.1"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>The IDAG is shown on the right. The main difference is the new term, <img src="https://latex.codecogs.com/png.latex?%5CDelta%20S_%7B%5Ctext%7BTx%7D%7D"> It implies that <img src="https://latex.codecogs.com/png.latex?X"> impacts the effect of the treatment on <img src="https://latex.codecogs.com/png.latex?S">. More simply, the treatment will have different effects on <img src="https://latex.codecogs.com/png.latex?S"> for different people based on their background, <img src="https://latex.codecogs.com/png.latex?X">, also known as <strong>heterogeneous treatment effects (HTEs)</strong>.</p>
<blockquote class="blockquote">
<p>Typically we average over HTEs to just get a single average treatment effect (ATE) for experiments, and that’s what we’ll be doing here. But there are ways to estimate HTEs as well, and we’ll get to that in part 3 of this series.</p>
</blockquote>
<p>This DAG can be used to build a surrogate index. If you can identify a set, <img src="https://latex.codecogs.com/png.latex?S">, of shorter term proxies for <img src="https://latex.codecogs.com/png.latex?Y">, and the effect of the treatment on <img src="https://latex.codecogs.com/png.latex?Y"> is entirely explained by <img src="https://latex.codecogs.com/png.latex?S">, than you can use <img src="https://latex.codecogs.com/png.latex?%5Chat%7BY%7D%20=%20f(S,%20X,%20T)%20+%20%5Cepsilon"> as an unbiased estimator for <img src="https://latex.codecogs.com/png.latex?Y"> before <img src="https://latex.codecogs.com/png.latex?Y"> is actually observed. This also means that you can estimate the long term treatment effect by observing <img src="https://latex.codecogs.com/png.latex?S"> for each variant of an experiment and using it to predict <img src="https://latex.codecogs.com/png.latex?%5Chat%7BY%7D"> for each group, then taking the difference: <img src="https://latex.codecogs.com/png.latex?%0AE%5B%5Cdelta_%7B%5Ctext%7BLTO%7D%7D%5D%20=%20E%5B%5Chat%7BY%7D%20%7C%20T=1%5D%20-%20E%5B%5Chat%7BY%7D%20%7C%20T=0%5D%0A"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cdelta_%7B%5Ctext%7BLTO%7D%7D"> is the treatment effect on the long term outcome.</p>
<p>Lets start simulating to see that for ourselves</p>
</section>
<section id="showing-that-surrogate-index-works-with-simulated-data" class="level1">
<h1>Showing that Surrogate Index works with Simulated Data</h1>
<section id="step-1-simulating-the-data" class="level2">
<h2 class="anchored" data-anchor-id="step-1-simulating-the-data">Step 1: Simulating the data</h2>
<p>We’ll start by simulating two datasets: A historical dataset and an experiment dataset. The advantage to simulating data is that we know the exact effects, so when we try and estimate them we can confirm our methods are recovering the true effect.</p>
<div id="335cac4d" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> statsmodels.api <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sm</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> simple_simulation <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_true_parameters, transmitter</span>
<span id="cb1-7">SEED <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span></span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># step 1: simulate data</span></span>
<span id="cb1-10">rng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.default_rng(seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>SEED)</span>
<span id="cb1-11">logit_link<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># True parameters</span></span>
<span id="cb1-14">Zdims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># customer latent dims</span></span>
<span id="cb1-15">Xdims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pre treatment covariates</span></span>
<span id="cb1-16">Sdims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># intermediate outcomes (the surrogates)</span></span>
<span id="cb1-17">n_users <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50000</span></span>
<span id="cb1-18"></span>
<span id="cb1-19">GROUND_TRUTH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> set_true_parameters(Zdims, Xdims, Sdims, logit_link<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, rng<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>rng)</span>
<span id="cb1-20"></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulate data </span></span>
<span id="cb1-22">historical_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> transmitter(GROUND_TRUTH, add_treatment<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, n_users<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_users,logit_link<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>logit_link, rng<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>rng) </span>
<span id="cb1-23">experiment_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> transmitter(GROUND_TRUTH, add_treatment<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, n_users<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_users, logit_link<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>logit_link, rng<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>rng)</span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Censor the experiment dataset so that we dont know the long term outcome yet</span></span>
<span id="cb1-26">Y_TRUE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> experiment_data.Y.values</span>
<span id="cb1-27">experiment_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> experiment_data.assign(Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.NaN)</span>
<span id="cb1-28"></span>
<span id="cb1-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show the historical dataset </span></span>
<span id="cb1-30">display(historical_data.head(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>WARNING (pytensor.tensor.blas): Using NumPy C-API based implementation for BLAS functions.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">X0</th>
<th data-quarto-table-cell-role="th">X1</th>
<th data-quarto-table-cell-role="th">X2</th>
<th data-quarto-table-cell-role="th">X3</th>
<th data-quarto-table-cell-role="th">X4</th>
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">S0</th>
<th data-quarto-table-cell-role="th">S1</th>
<th data-quarto-table-cell-role="th">S2</th>
<th data-quarto-table-cell-role="th">S3</th>
<th data-quarto-table-cell-role="th">S4</th>
<th data-quarto-table-cell-role="th">S5</th>
<th data-quarto-table-cell-role="th">S6</th>
<th data-quarto-table-cell-role="th">S7</th>
<th data-quarto-table-cell-role="th">Y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>-0.096380</td>
<td>0.840839</td>
<td>-1.053685</td>
<td>-0.161607</td>
<td>-1.464074</td>
<td>0.0</td>
<td>1.140716</td>
<td>0.460239</td>
<td>-0.243707</td>
<td>0.478655</td>
<td>0.722508</td>
<td>0.119872</td>
<td>-0.491021</td>
<td>0.657103</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.750790</td>
<td>-0.723678</td>
<td>1.339998</td>
<td>-0.109216</td>
<td>-0.886968</td>
<td>0.0</td>
<td>0.173273</td>
<td>-0.100168</td>
<td>0.150519</td>
<td>-0.828812</td>
<td>0.288891</td>
<td>-0.454165</td>
<td>0.356069</td>
<td>-1.335292</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1.135441</td>
<td>-1.586930</td>
<td>1.226992</td>
<td>1.028425</td>
<td>-0.628964</td>
<td>0.0</td>
<td>-0.136527</td>
<td>-0.151602</td>
<td>0.555157</td>
<td>-1.382398</td>
<td>-0.071426</td>
<td>-0.453651</td>
<td>0.506445</td>
<td>-1.059432</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.470862</td>
<td>-0.472840</td>
<td>0.295874</td>
<td>1.280656</td>
<td>-0.370790</td>
<td>0.0</td>
<td>0.172303</td>
<td>0.171164</td>
<td>0.069458</td>
<td>-0.738659</td>
<td>0.113751</td>
<td>-0.089416</td>
<td>0.115741</td>
<td>0.073674</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.299083</td>
<td>-0.566013</td>
<td>0.851715</td>
<td>0.816545</td>
<td>-0.128058</td>
<td>0.0</td>
<td>-0.072062</td>
<td>0.078149</td>
<td>0.067890</td>
<td>-0.761437</td>
<td>0.052046</td>
<td>-0.173179</td>
<td>0.309554</td>
<td>-0.506578</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The underlying simulation code is below if you’re interested</p>
<div id="fd32bffb" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Dict</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> transmitter(</span>
<span id="cb3-4">    params: Dict,</span>
<span id="cb3-5">    add_treatment: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb3-6">    n_users: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb3-7">    logit_link: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb3-8">    rng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb3-9">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> pd.DataFrame:</span>
<span id="cb3-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'''Simulates outcomes based on some ground truth parameters. </span></span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters</span></span>
<span id="cb3-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    -----------</span></span>
<span id="cb3-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        params: The ground truth parameters (effects and biases) to simulate based off of</span></span>
<span id="cb3-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        add_treatment: adds a randomly allocated treatment when true, with effect `bTS`</span></span>
<span id="cb3-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        n_users: The number of users to simulate</span></span>
<span id="cb3-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        logit_link: whether the data generating process is a bernoulli outcome or not</span></span>
<span id="cb3-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        rng: A numpy random generator </span></span>
<span id="cb3-19"></span>
<span id="cb3-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns</span></span>
<span id="cb3-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    --------</span></span>
<span id="cb3-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        A pandas dataframe with simulated data, including pre-treatment covariates,</span></span>
<span id="cb3-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">         surrogate outcomes, a treatment indicator, and a long term outcome, Y</span></span>
<span id="cb3-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    '''</span></span>
<span id="cb3-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> rng <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb3-26">        seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.choice(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>))</span>
<span id="cb3-27">        rng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.default_rng(seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>seed)</span>
<span id="cb3-28"></span>
<span id="cb3-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># unpack params</span></span>
<span id="cb3-30">    Zdims, Xdims, Sdims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>  params[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bZX'</span>].shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],  params[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bZX'</span>].shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],  params[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bXS'</span>].shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb3-31">    alphaX,alphaS,alphaY  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alphaX'</span>], params[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alphaS'</span>], params[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alphaY'</span>] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bias terms</span></span>
<span id="cb3-32">    bZX,bXS,bSY <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bZX'</span>], params[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bXS'</span>],params[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bSY'</span>] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># causal relationships</span></span>
<span id="cb3-33">    bTS,bXTS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bTS'</span>], params[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bXTS'</span>] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tx effects</span></span>
<span id="cb3-34"></span>
<span id="cb3-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># unobserved variable Z representing latent customer traits</span></span>
<span id="cb3-36">    Z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(Zdims, n_users))</span>
<span id="cb3-37"></span>
<span id="cb3-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Some observed pre-TX measures</span></span>
<span id="cb3-39">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> alphaX[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (bZX <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> Z)</span>
<span id="cb3-40"></span>
<span id="cb3-41">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Intermediate outcomes</span></span>
<span id="cb3-42">    S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> alphaS[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (bXS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> X) </span>
<span id="cb3-43"></span>
<span id="cb3-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add in treatment effect if applicable</span></span>
<span id="cb3-45">    T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.binomial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_users) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> add_treatment <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> np.zeros(n_users)        </span>
<span id="cb3-46">    avg_tx_term <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (bTS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> T[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>])        </span>
<span id="cb3-47">    hetergeneous_tx_term <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (bXTS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> (X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>T))</span>
<span id="cb3-48">    S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> avg_tx_term.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> hetergeneous_tx_term</span>
<span id="cb3-49"></span>
<span id="cb3-50">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expectation of long term outcome</span></span>
<span id="cb3-51">    eta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (bSY <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> S)</span>
<span id="cb3-52"></span>
<span id="cb3-53">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Long term outcome</span></span>
<span id="cb3-54">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> logit_link:</span>
<span id="cb3-55">        Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.binomial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, sp.expit(eta) )</span>
<span id="cb3-56">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb3-57">        Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.normal(eta, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>)</span>
<span id="cb3-58"></span>
<span id="cb3-59">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Output as dataframe</span></span>
<span id="cb3-60">    Xdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(X.T, columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'X</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(Xdims)]).assign(T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>T)</span>
<span id="cb3-61">    Sdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(S.T, columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'S</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(Sdims)])</span>
<span id="cb3-62">    Ydf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(Y.ravel(), columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>])</span>
<span id="cb3-63">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> pd.concat((Xdf, Sdf, Ydf),axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</details>
</div>
</section>
<section id="step-2-fitting-a-surrogate-model" class="level2">
<h2 class="anchored" data-anchor-id="step-2-fitting-a-surrogate-model">Step 2: Fitting a surrogate model</h2>
<p>We’ll use the historical dataset to fit the surrogate index model, mapping <img src="https://latex.codecogs.com/png.latex?S%20%5Crightarrow%20Y"></p>
<div id="9b7dc24e" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">S_vars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" + "</span>.join( historical_data.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(like<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>).columns )</span>
<span id="cb4-2">X_vars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" + "</span>.join( historical_data.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(like<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>).columns )</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Step 2: fit a surrogate index model on complete historical data</span></span>
<span id="cb4-5">surrogate_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sm.OLS.from_formula(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Y ~ </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>S_vars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>historical_data).fit()</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimate the variance in the estimator, \hat{sigma^2}. This is used for bias corrections later</span></span>
<span id="cb4-8">predicted_sigma2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.var( surrogate_model.fittedvalues <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> historical_data.Y,  ddof<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> )</span>
<span id="cb4-9"></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show the model summary</span></span>
<span id="cb4-11">surrogate_model.summary()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<table class="simpletable caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>OLS Regression Results</caption>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Dep. Variable:</td>
<td>Y</td>
<td data-quarto-table-cell-role="th">R-squared:</td>
<td>0.112</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Model:</td>
<td>OLS</td>
<td data-quarto-table-cell-role="th">Adj. R-squared:</td>
<td>0.112</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Method:</td>
<td>Least Squares</td>
<td data-quarto-table-cell-role="th">F-statistic:</td>
<td>1261.</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Date:</td>
<td>Sat, 22 Feb 2025</td>
<td data-quarto-table-cell-role="th">Prob (F-statistic):</td>
<td>0.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Time:</td>
<td>11:34:39</td>
<td data-quarto-table-cell-role="th">Log-Likelihood:</td>
<td>-33320.</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">No. Observations:</td>
<td>50000</td>
<td data-quarto-table-cell-role="th">AIC:</td>
<td>6.665e+04</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Df Residuals:</td>
<td>49994</td>
<td data-quarto-table-cell-role="th">BIC:</td>
<td>6.670e+04</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Df Model:</td>
<td>5</td>
<td data-quarto-table-cell-role="th"></td>
<td></td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Covariance Type:</td>
<td>nonrobust</td>
<td data-quarto-table-cell-role="th"></td>
<td></td>
</tr>
</tbody>
</table>


<table class="simpletable caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td></td>
<td data-quarto-table-cell-role="th">coef</td>
<td data-quarto-table-cell-role="th">std err</td>
<td data-quarto-table-cell-role="th">t</td>
<td data-quarto-table-cell-role="th">P&gt;|t|</td>
<td data-quarto-table-cell-role="th">[0.025</td>
<td data-quarto-table-cell-role="th">0.975]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Intercept</td>
<td>0.4994</td>
<td>0.002</td>
<td>236.981</td>
<td>0.000</td>
<td>0.495</td>
<td>0.504</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">S0</td>
<td>0.0382</td>
<td>0.004</td>
<td>10.857</td>
<td>0.000</td>
<td>0.031</td>
<td>0.045</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">S1</td>
<td>0.1023</td>
<td>0.005</td>
<td>21.446</td>
<td>0.000</td>
<td>0.093</td>
<td>0.112</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">S2</td>
<td>-0.0420</td>
<td>0.005</td>
<td>-8.853</td>
<td>0.000</td>
<td>-0.051</td>
<td>-0.033</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">S3</td>
<td>0.1861</td>
<td>0.004</td>
<td>50.774</td>
<td>0.000</td>
<td>0.179</td>
<td>0.193</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">S4</td>
<td>0.0501</td>
<td>0.002</td>
<td>30.302</td>
<td>0.000</td>
<td>0.047</td>
<td>0.053</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">S5</td>
<td>0.0666</td>
<td>0.002</td>
<td>28.930</td>
<td>0.000</td>
<td>0.062</td>
<td>0.071</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">S6</td>
<td>-0.0072</td>
<td>0.002</td>
<td>-2.978</td>
<td>0.003</td>
<td>-0.012</td>
<td>-0.002</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">S7</td>
<td>0.0037</td>
<td>0.003</td>
<td>1.348</td>
<td>0.178</td>
<td>-0.002</td>
<td>0.009</td>
</tr>
</tbody>
</table>


<table class="simpletable caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Omnibus:</td>
<td>255849.096</td>
<td data-quarto-table-cell-role="th">Durbin-Watson:</td>
<td>1.998</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Prob(Omnibus):</td>
<td>0.000</td>
<td data-quarto-table-cell-role="th">Jarque-Bera (JB):</td>
<td>5169.412</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Skew:</td>
<td>-0.002</td>
<td data-quarto-table-cell-role="th">Prob(JB):</td>
<td>0.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Kurtosis:</td>
<td>1.425</td>
<td data-quarto-table-cell-role="th">Cond. No.</td>
<td>3.91e+15</td>
</tr>
</tbody>
</table>
<br><br>Notes:<br>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.<br>[2] The smallest eigenvalue is 6.03e-27. This might indicate that there are<br>strong multicollinearity problems or that the design matrix is singular.
</div>
</div>
<p>There are 3 important things to note here:</p>
<ol type="1">
<li>Note that we’re purposely not including the pre-treatment covariates, <img src="https://latex.codecogs.com/png.latex?X"> in this model. Remember the DAG - all of the effect of <img src="https://latex.codecogs.com/png.latex?X"> on <img src="https://latex.codecogs.com/png.latex?Y"> is entirely mediated by <img src="https://latex.codecogs.com/png.latex?S">, so adding <img src="https://latex.codecogs.com/png.latex?X"> into the model adds no additional information.</li>
<li>We’re using Ordinary Least Squares for bernoulli outcome data. Thats not a mistake. OLS has great properties to be effective on bernoulli outcome data, and it makes this approach very simple. Other models can also be swapped in, like Random Forest or XGBoost.</li>
<li>I’m not doing alot of model validation, just because this is simulated data. In practice, don’t just throw things into a model. Part 2 in this series will discuss how to validate surrogate indexes.</li>
</ol>
</section>
<section id="step-3-estimate-long-term-treatment-effect" class="level2">
<h2 class="anchored" data-anchor-id="step-3-estimate-long-term-treatment-effect">Step 3: Estimate Long Term Treatment Effect</h2>
<p>We’ll now use the surrogate index to estimate a long term treatment effect</p>
<p>Let’s take our experiment dataset and estimate <img src="https://latex.codecogs.com/png.latex?E%5B%5Cdelta_%7B%5Ctext%7BLTO%7D%7D%5D">, the average treatment effect on the long term outcome. Notice, the long term outcome, <img src="https://latex.codecogs.com/png.latex?Y">, hasn’t been observed yet.</p>
<div id="f0426d15" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">display(experiment_data.head())</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">X0</th>
<th data-quarto-table-cell-role="th">X1</th>
<th data-quarto-table-cell-role="th">X2</th>
<th data-quarto-table-cell-role="th">X3</th>
<th data-quarto-table-cell-role="th">X4</th>
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">S0</th>
<th data-quarto-table-cell-role="th">S1</th>
<th data-quarto-table-cell-role="th">S2</th>
<th data-quarto-table-cell-role="th">S3</th>
<th data-quarto-table-cell-role="th">S4</th>
<th data-quarto-table-cell-role="th">S5</th>
<th data-quarto-table-cell-role="th">S6</th>
<th data-quarto-table-cell-role="th">S7</th>
<th data-quarto-table-cell-role="th">Y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.849129</td>
<td>0.941827</td>
<td>0.683911</td>
<td>1.435666</td>
<td>1.001435</td>
<td>1</td>
<td>-0.559842</td>
<td>-0.575105</td>
<td>-0.884129</td>
<td>-0.543576</td>
<td>-0.289843</td>
<td>0.816105</td>
<td>-0.516732</td>
<td>0.887577</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>-0.053981</td>
<td>0.716863</td>
<td>0.718290</td>
<td>1.600732</td>
<td>0.390534</td>
<td>1</td>
<td>-0.271181</td>
<td>0.001847</td>
<td>-0.690713</td>
<td>-0.609596</td>
<td>0.001895</td>
<td>0.902771</td>
<td>-0.263201</td>
<td>0.456430</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.852506</td>
<td>1.276305</td>
<td>-1.803119</td>
<td>-0.418187</td>
<td>-0.009625</td>
<td>1</td>
<td>0.021439</td>
<td>-0.752464</td>
<td>-0.340972</td>
<td>0.909959</td>
<td>-0.323996</td>
<td>1.041753</td>
<td>-1.256339</td>
<td>1.851033</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>-0.650541</td>
<td>0.908525</td>
<td>1.985210</td>
<td>1.231077</td>
<td>0.265338</td>
<td>1</td>
<td>-0.226897</td>
<td>0.259183</td>
<td>-0.987532</td>
<td>-0.835104</td>
<td>0.359953</td>
<td>0.767602</td>
<td>0.108398</td>
<td>-0.659191</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>-0.473196</td>
<td>-0.007258</td>
<td>0.054155</td>
<td>-0.368575</td>
<td>0.331867</td>
<td>0</td>
<td>-0.229447</td>
<td>0.020273</td>
<td>0.058779</td>
<td>0.200721</td>
<td>-0.121112</td>
<td>0.062693</td>
<td>0.113565</td>
<td>-0.206135</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>First, we’ll do some visulation of the experiment data.</p>
<div id="96943659" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(Xdims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>),sharey<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, ax <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(Xdims), axes.ravel()):</span>
<span id="cb6-4">    sns.histplot( experiment_data.loc[<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'T'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"X</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>],ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Control'</span> )</span>
<span id="cb6-5">    sns.histplot( experiment_data.loc[<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'T'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>][<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"X</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>],ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Treatment'</span> )</span>
<span id="cb6-6"></span>
<span id="cb6-7">plt.suptitle(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Histogram of Pre-Treatment Covariates</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">for the Treatment and Control groups"</span>)</span>
<span id="cb6-8">plt.tight_layout()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/surrogates/2023-07-09-surrogate_index_intro_files/figure-html/cell-6-output-1.png" width="662" height="475" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As we can see above, the pre-treatment variables are the exact same between the experiment groups. Thats because users are randomly allocated into treatment and control groups, and their pre-treatment varibles by definition are things not imapcted by the experiment.</p>
<p>Conversely, if we look at the surrogate outcomes below, we’ll see some differences in surrogate outcomes between the treatment and control groups.</p>
<div id="c207e7a3" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(Sdims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), sharey<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, ax <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(Sdims), axes.ravel()):</span>
<span id="cb7-4">    sns.histplot( experiment_data.loc[<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'T'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"S</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>],ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Control'</span> )</span>
<span id="cb7-5">    sns.histplot( experiment_data.loc[<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'T'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>][<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"S</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>],ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Treatment'</span> )</span>
<span id="cb7-6"></span>
<span id="cb7-7">plt.suptitle(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Histogram of Surrogate Outcomes</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">for the Treatment and Control groups"</span>)</span>
<span id="cb7-8">plt.tight_layout()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/surrogates/2023-07-09-surrogate_index_intro_files/figure-html/cell-7-output-1.png" width="658" height="475" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>If our surrogate index estimator is correct, these observed surrogate outcomes should directly map to the Long Term Outcome deterministically, via <img src="https://latex.codecogs.com/png.latex?%5Chat%7BY%7D%20=%20f(S)">, where <img src="https://latex.codecogs.com/png.latex?f()"> is the surrogate index model.</p>
<p>We can show that the surrogate index estimator recovers the true average treatment effect on the long term outcome</p>
<div id="a6a76835" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> estimate_delta_LTO(experiment_data, surrogate_model, predicted_sigma2):</span>
<span id="cb8-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'''Accepts experiment data with a binary treatment, a surrogate model, and the predicted sigma^2 of the surrogate model.</span></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns the ATE estimate and its uncertainty</span></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    '''</span></span>
<span id="cb8-6">    Y_T1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> surrogate_model.predict(experiment_data.loc[<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'T'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb8-7">    Y_T0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> surrogate_model.predict(experiment_data.loc[<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'T'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb8-8">    </span>
<span id="cb8-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the ATE</span></span>
<span id="cb8-10">    ATE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>  Y_T1.mean() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> Y_T0.mean()</span>
<span id="cb8-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># calculate the variance </span></span>
<span id="cb8-12">    var_surrogate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.var(Y_T1,ddof<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(Y_T1) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> np.var(Y_T0,ddof<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(Y_T0)</span>
<span id="cb8-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Adjust the variance by the surrogate model error</span></span>
<span id="cb8-14">    var_surrogate_adj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> var_surrogate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>predicted_sigma2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(Y_T1)</span>
<span id="cb8-15">    ATE_sd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.sqrt(var_surrogate_adj)</span>
<span id="cb8-16">    </span>
<span id="cb8-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ATE, ATE_sd</span>
<span id="cb8-18"></span>
<span id="cb8-19">ATE, ATE_sd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> estimate_delta_LTO(experiment_data, surrogate_model, predicted_sigma2)</span>
<span id="cb8-20">sns.histplot(np.random.normal(ATE, ATE_sd, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>), stat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'probability'</span>)</span>
<span id="cb8-21">plt.axvline( GROUND_TRUTH[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ATE'</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'True ATE'</span>)</span>
<span id="cb8-22">plt.legend()</span>
<span id="cb8-23">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ATE"</span>)</span>
<span id="cb8-24">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Estimated Treatment Effect vs. True Treatment Effect"</span>)</span>
<span id="cb8-25">plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/surrogates/2023-07-09-surrogate_index_intro_files/figure-html/cell-8-output-1.png" width="597" height="449" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>There we are. The surrogate estimator recovers the true average treatment effect! We didn’t even have to wait and observe the true long term outcome.</p>
<p>If you’re interested, try simulating this repeatedly to confirm it regularly recovers the true ATE with different random seeds. Even better, try setting the treatment effect to zero and see how often there are false positives.</p>
</section>
</section>
<section id="whats-next" class="level1">
<h1>What’s next?</h1>
<p>Hopefully this post convinced you that the surrogate index approach can help assess long term outcomes in experiments faster.</p>
<p>While its easier to show this approach works, it’s harder to pull it off in practice. The next post will focus on how to validate a surrogate index estimator on more realistic data that you might see in industry.</p>


</section>

 ]]></description>
  <category>experimentation</category>
  <category>Causal Inference</category>
  <guid>https://kylejcaron.github.io/posts/surrogates/2023-07-09-surrogate_index_intro.html</guid>
  <pubDate>Sun, 09 Jul 2023 04:00:00 GMT</pubDate>
  <media:content url="https://kylejcaron.github.io/assets/img/placeholder.png" medium="image" type="image/png" height="95" width="144"/>
</item>
<item>
  <title>Desiging an Experimentation Strategy</title>
  <link>https://kylejcaron.github.io/posts/experiment_strategy/2023-06-09-experiment-strategy.html</link>
  <description><![CDATA[ 





<p>Experiments have alot more use cases than many give them credit for. At their simplest, they’re a tool for mitigating risk when making product decisions. But at their best, they’re a tool that can help <a href="https://eng.lyft.com/causal-forecasting-at-lyft-part-1-14cca6ff3d6d">optimize an entire business</a>.</p>
<p>Every business has its own unique problems and goals, and this post is a case study where strategy was made across experiments to fit the needs of the business.</p>
<section id="tldr" class="level1">
<h1>TLDR</h1>
<ul>
<li>Building Trust First</li>
<li>More interesting questions come natually as the process improves</li>
<li>How do we make sure our decisions help our long term outcome? –&gt; Surrogate index</li>
</ul>
<p>At the end of the day, the real strategy is building trust with stakeholders. Once that trust is built up, thats when you get the chance to start having a bigger influence on the business.</p>
</section>
<section id="part-1-identifying-the-business-problems-and-needs" class="level1">
<h1>Part 1: Identifying the business problems and needs</h1>
<p>Policygenius is an insurance marketplace that aims to help customers find insurance policies. Selling insurance isn’t quite the same as e-commerce; it’s a major life decision, and major life decisions take some time to decide on. In fact, customers typically took 3-6 months to purchase a life insurance policy (our true-north metric). Thats a long time to monetize a lead. Attempting to <a href="https://arxiv.org/pdf/2106.01421.pdf">improve a long-term outcome</a> like that can be difficult, but that wasn’t a problem that the business fully understood the implications of when I first started. The business needs changed over time and so did our strategy to addres them, but that one problem eventually became the focal point of our strategy.</p>
<section id="early-stage-needs---starting-simple-building-trust" class="level2">
<h2 class="anchored" data-anchor-id="early-stage-needs---starting-simple-building-trust">Early stage needs - Starting Simple, Building trust</h2>
<p>When I joined the company, I was just the third data science hire, and there really wasn’t any experimentation practice in place beyond stakeholders watching an optimizely dashboard. Listening to stakeholders, there was a desire to build more trust in decision making and make sure their products decisions were actually improving things for the customer.</p>
<p>We started simple - a google doc template where stakeholders could explain the product feature they wanted to implement and their hypothesis on what outcome the product feature might improve. From there we worked with them to design a measurement strategy to answer their question, which wasn’t always an experiment. At the end of the day, experimentation is just one of many tools for causal inference. Having this process and flexibility helped us earn buy-in - we weren’t just there to tell them what we could and couldn’t do. We were there to educate so that we weren’t just recommending solutions, but so that stakeholders were playing a really active role in what our measurement strategy should be.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/experiment_strategy/coach_beard.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>We also improved the experiment output from an optimizely dashboard to an in-house report. All of this built alot more trust in the results, and helped us move on to new questions like</p>
<ul>
<li>“Can we use different outcome metrics beyond conversion rate?”</li>
<li>“Can we make experiments shorter?” (power analyses, <a href="https://www.exp-platform.com/Documents/2013-02-CUPED-ImprovingSensitivityOfControlledExperiments.pdf">variance reduction</a>)</li>
<li>“Can we launch a feature without hurting the business even if we can’t confirm it’s better?”” (<a href="https://twitter.com/seanjtaylor/status/1488343062057152516">uncertainty quantification</a>)</li>
<li>“What’s the right risk tolerance in terms of being able to detect an effect versus risking a false positive” (<a href="https://twitter.com/seanjtaylor/status/1169855647510253569">here’s a fun example</a>)</li>
<li>“Can we start experimenting like this on our other products?”</li>
<li>“Can we learn how our change in one part of the funnel may have an impact further downstream?”</li>
<li>“How can we run experiments that mitigate regret?” (<a href="https://en.wikipedia.org/wiki/Multi-armed_bandit">Bandit algorithms</a>)</li>
<li>“Can we stop an experiment early and still have confidence in the results?” (sequential testing, <a href="https://dpananos.github.io/posts/2022-07-06-gsd/">alpha spending</a>)</li>
<li>“Who is the experiment working best for?” ( <a href="https://multithreaded.stitchfix.com/blog/2015/10/15/multiple-hypothesis-testing/">Multiple Hypothesis Testing</a>, <a href="https://matheusfacure.github.io/python-causality-handbook/18-Heterogeneous-Treatment-Effects-and-Personalization.html">Heterogeneous Treatment Effects</a> )</li>
</ul>
<p>Again, we weren’t just throwing cool implementations at them we thought they needed, we were listening to what our stakeholders wanted first and then prioritizing it. As we moved up the ladder in terms of trust, I was able to get buy in to build out scalable tooling for others in the company to start usin, and we were able to scale the process to other teams.</p>
<p>There was also 1 key tenant I tried to keep in mind as our methodology became more advanced: <strong>could we directly observe the treatment effect?</strong> (<a href="https://mixtape.scunning.com/04-potential_outcomes">simple difference in outcomes</a>). No matter how advanced of a method we might consider, throwing some output from a blackbox model at a stakeholder was never the way to go. It can’t be understated how important directly observing the treatment effect is for trust.</p>
</section>
</section>
<section id="part-2---new-problems" class="level1">
<h1>Part 2 - New problems</h1>
<p>Our early stage strategy for experiments was to try and optimize mid-funnel outcomes (with intermediate guardrail metrics), since it would take too long to observe lower funnel outcomes. We wanted to be running experiments at 1-2 week cadences, we couldnt afford to wait 3-6 months for experiments. This did come with risk however, so we had built some visibility to see how users who were exposed to some experiments were baking out months later. I’m not sure why <em>baking</em> is a professional term to wait and see an outcome over time, but it is.</p>
<p>The opportunity for a long-term strategy arose as we began running into new problems.</p>
<section id="problem-1-infrastructure" class="level3">
<h3 class="anchored" data-anchor-id="problem-1-infrastructure">Problem 1: Infrastructure</h3>
<p>Some pillars of the business had less established data models (the data engineering kind of data models) - so setting up different SQL queries for different experiments was a painpoint for some product pillars.</p>
</section>
<section id="problem-2-secondary-analyses-and-personalization" class="level3">
<h3 class="anchored" data-anchor-id="problem-2-secondary-analyses-and-personalization">Problem 2: Secondary Analyses and personalization</h3>
<p>The data team was getting burnout. With each experiment came what we called “secondary analysis”. Really, what stakeholders were interested in was heterogeneous treatment effects, or “who does the treatment work best for”, because the vision was to personalize the product flow based on the customer. But for the data team, the analysis that came with it was entirely manual and would drag on when there wasn’t a clear answer (often). It was also a risk for false positives from multiple hypothesis testing.</p>
</section>
<section id="problem-3-sample-size" class="level3">
<h3 class="anchored" data-anchor-id="problem-3-sample-size">Problem 3: Sample Size</h3>
<p>There are only so many customers interested in private insurance in this country, and that limited sample size quite a bit. We were already choosing power and false positive rate parameters for our tests that would allow us to move quicker across the company, but there was a real desire from stakeholders to move faster, especially since some experiments could take up to a month.</p>
</section>
<section id="problem-4-spillover-effects" class="level3">
<h3 class="anchored" data-anchor-id="problem-4-spillover-effects">Problem 4: Spillover effects</h3>
<p>A major step of our funnel involved sales agents, which we had a limited supply. This had the potential for spillover effects, where if we sent them too many leads from a successful variant, it would impact the control. This is a classic SUTVA violation, which can bias the observed treatment effect.</p>
</section>
<section id="problem-5-were-we-optimizing-the-wrong-thing" class="level3">
<h3 class="anchored" data-anchor-id="problem-5-were-we-optimizing-the-wrong-thing">Problem 5: Were we optimizing the wrong thing?</h3>
<p>My second quarter with the life-insurance team we smashed through our OKRs that were targeted at improving mid-funnel outcomes (we were scoped to work on the top half of the funnel). The problem was that 3 months later we weren’t seeing those results trickle down to the bottom half of the funnel in the way that we thought it would.</p>
<p>In fact, in one of the most successful experiments we ran, we found that the customers who were exposed to the treatment fared worse in the long-term, despite seeming fine for the mid-funnel outcome and guardrail we were using.</p>
<div id="5586a465" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.ticker <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> mtick</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pymc <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pm</span>
<span id="cb1-6"></span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulate out time to convert and conversion rate </span></span>
<span id="cb1-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> sim_conversion(k, lambd, p, N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>):</span>
<span id="cb1-10">    ttc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.ceil(pm.draw( pm.Weibull.dist(k, lambd), N))</span>
<span id="cb1-11">    convert <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.binomial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,p, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>N)</span>
<span id="cb1-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> pd.DataFrame({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>:ttc, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'convert'</span>:convert})</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> cohort_table(df):</span>
<span id="cb1-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span>     (</span>
<span id="cb1-16">        df</span>
<span id="cb1-17">        .groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>)</span>
<span id="cb1-18">        .convert.agg([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sum'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>])</span>
<span id="cb1-19">        .assign(conversions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sum'</span>].cumsum())</span>
<span id="cb1-20">        .assign(N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df))</span>
<span id="cb1-21">        .assign(cvr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d.conversions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>d.N)</span>
<span id="cb1-22">    )</span>
<span id="cb1-23"></span>
<span id="cb1-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> censor(df, time):</span>
<span id="cb1-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> df.loc[<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d.time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>time]</span>
<span id="cb1-26"></span>
<span id="cb1-27"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> simple_cohort_plot(df, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>plot_kwargs):</span>
<span id="cb1-28">    </span>
<span id="cb1-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> ax <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb1-30">        fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb1-31">    </span>
<span id="cb1-32">    (df.pipe(censor, time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb1-33">        .pipe(cohort_table)</span>
<span id="cb1-34">        [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cvr'</span>]</span>
<span id="cb1-35">        .plot(ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>plot_kwargs))</span>
<span id="cb1-36"></span>
<span id="cb1-37">    ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(</span>
<span id="cb1-38">        title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Cumulative Conversion to Sale'</span>, </span>
<span id="cb1-39">        xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Days Since Experiment Start'</span>, </span>
<span id="cb1-40">        ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Conversion Rate'</span>)</span>
<span id="cb1-41">    </span>
<span id="cb1-42">  </span>
<span id="cb1-43">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb1-44">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100_000</span></span>
<span id="cb1-45">sim_conversion(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, N).pipe(simple_cohort_plot,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Control'</span>)</span>
<span id="cb1-46">sim_conversion(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">55</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.18</span>, N).pipe(simple_cohort_plot,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Variant'</span>)</span>
<span id="cb1-47">ax.yaxis.set_major_formatter(mtick.PercentFormatter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,))</span>
<span id="cb1-48">ax.legend()</span>
<span id="cb1-49">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>WARNING (pytensor.tensor.blas): Using NumPy C-API based implementation for BLAS functions.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/experiment_strategy/2023-06-09-experiment-strategy_files/figure-html/cell-2-output-2.png" width="610" height="376" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It turns out we had gamed our metric. We could find great ways to boost our target metric and crush our OKRs, but what good did it do for the company?</p>
<p>This was by far the biggest problem, and luckily thanks to all of the trust that we had built up and the co-ownership model we had adopted with our stakeholders this problem didn’t end up dissolving any trust we had. In fact, everyone was grateful it was caught. Thinking counterfactually, the business would have never know had we not adopted a rigorous experimentation process. The importance of this issue gave me the justification to come up with a plan and start addressing these problems we were running into.</p>
</section>
</section>
<section id="part-3---designing-the-long-term-strategy" class="level1">
<h1>Part 3 - Designing the long term strategy</h1>
<section id="whats-a-surrogate-index" class="level2">
<h2 class="anchored" data-anchor-id="whats-a-surrogate-index">What’s a surrogate index?</h2>
<p>A surrogate index was a new piece of research from Susan Athey, basically a way to predict what a long term treatment effect would be given intermediate outcomes that could be observed sooner. It also neatly addressed the biggest problem we were facing.</p>
<p>The basic idea is illustrated in the DAG below.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
  B(Treatment) --&gt; c(Outcome 1)
  B(Treatment) --&gt; d(Outcome 2)
  B(Treatment) --&gt; e(Outcome 3)
  c(Outcome 1) --&gt; f(Long Term\nOutcome)
  d(Outcome 2) --&gt; f(Long Term\nOutcome)
  e(Outcome 3) --&gt; f(Long Term\nOutcome)
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>Let’s say the long term outcome can be entirely explained by 3 intermediate outcomes, such as mid-funnel metrics that can be observed sooner. A model can be fit to that relationship on historical data like so:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
  c(Outcome 1) --&gt; f(Long Term\nOutcome)
  d(Outcome 2) --&gt; f(Long Term\nOutcome)
  e(Outcome 3) --&gt; f(Long Term\nOutcome)
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>The set of intermediate outcomes is known as a surrogate index; they’re a surrogate for the long term outcome. If you have a correct model for the DAG above, than all you need to do is observe outcomes 1-3. You could then just run an experiment as you normally would, but instead of using some game-able mid-funnel metric as the primary outcome, you could measure outcomes 1-3 for both the treatment and control group, and predict what the long-term outcome would be for each group. The difference in the prediction for the treatment group and the control group ends up being identical to the true long-term treatment effect (assuming that the model and dag are specified correctly).</p>
<p>As always, it’s easier said than done. You need to make sure that the entire intermediate effect between the treatment and the long-term outcome is captured by the DAG and the model. Or in english, you need to understand the exact effect that the intermediate outcomes have on the long term outcome, and you need to be right about it; you can’t be missing anything.</p>
<p>But there are ways to validate you’re on the right track. First, knowing something about DAGs and causal inference, you can call on the <strong>local markov property</strong>; the treatment should be conditionally independent of the long term outcome after conditioning on the surrogate index. That’s easy to test. One can alse make predictions on the long term outcome with their surrogate index and see if it ended up being correct when the long-term outcome gets observed (hopefully for repeated experiments). Also do-able. Even better, if you have many historical experiments, you could do this validation on that dataset across all of the experiments.</p>
<div id="247eb219" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for simplicity, not actually simulating a true data generating process</span></span>
<span id="cb3-2">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span>)</span>
<span id="cb3-3">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span>
<span id="cb3-4">true_north_metric <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> np.random.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x))</span>
<span id="cb3-5">predicted_true_north <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.normal(true_north_metric, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-6"></span>
<span id="cb3-7">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb3-8">ax.scatter(predicted_true_north, true_north_metric)</span>
<span id="cb3-9">ax.plot([<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>], [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>], ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb3-10"></span>
<span id="cb3-11">ax.set_xticks([])</span>
<span id="cb3-12">ax.set_yticks([])</span>
<span id="cb3-13">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Predicted True North'</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'True North Metric'</span>, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Surrogate Index vs. Long Term Outcome over many experiments'</span>)</span>
<span id="cb3-14">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/experiment_strategy/2023-06-09-experiment-strategy_files/figure-html/cell-3-output-1.png" width="558" height="427" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Unfortunately, we didn’t have a large dataset of historical experiments. For the experiments we did have, they didn’t have enough power to detect reasonably sized changes on our true-north bottom funnel metric. Those experiment had all been designed with mid-funnel metrics in mind, and therefore had smaller sample sizes.</p>
</section>
<section id="building-a-plan" class="level2">
<h2 class="anchored" data-anchor-id="building-a-plan">Building a plan</h2>
<p>In total there were 5 big problems to address, each with a different solution. There also weren’t alot of resources to devote to them. But if we could free up time for others running experiments, they could use some of that time to contribute to this roadmap.</p>
<p>In the end, the biggest priority was to implement surrogate indices, because that was having the biggest painpoint on our business - we couldnt keep working with game-able metrics that weren’t improving the business.</p>
<p>With that in mind, switchback experimentation was in direct conflict with that goal. Switchback experiments don’t allow you to observe long term outcomes because users arent the ones who are randomized, time periods are what is randomized. We could atleast monitor and set up guardrails to make sure there wasnt alot of spillover.</p>
<p>This also meant that bandit algorithms shouldn’t be part of our toolkit any time soon, even though there had been alot of interest in them. Bandit algorithms wouldn’t be ideal for learning the impact on long term outcomes, and using them to learn a surrogate index would be really difficult since the treatment propensity would be constantly changing over time.</p>
<p>I’ll summarize some of the easy and hard solutions I came up with:</p>
<ol type="1">
<li><strong>Infrastructure</strong>
<ul>
<li><strong>Solution</strong>: templated SQL for scalable experiment queries</li>
</ul></li>
<li><strong>“Who did the experiment work best for?”</strong>
<ul>
<li><strong>Easy solution(s):</strong> Scalable code for Multiple hypothesis testing with corrections</li>
<li><strong>Hard solution:</strong> Heterogeneuous Treatment Effect models</li>
</ul></li>
<li><strong>Sample Size problems</strong>
<ul>
<li><strong>Easy solution(s):</strong> Quickly implement Informative priors. Since we had revenue as part of our overall evaluation criteria for some experiments, this provided a massive speedup</li>
<li><strong>Hard solution(s):</strong> <a href="https://www.exp-platform.com/Documents/2013-02-CUPED-ImprovingSensitivityOfControlledExperiments.pdf">CUPED</a>, <a href="https://github.com/kylejcaron/case_studies/blob/main/Time%20to%20Conversion%20Matters.ipynb">Cohort Models</a></li>
</ul></li>
<li><strong>Spillover Effects</strong>
<ul>
<li><strong>Easy Solution(s):</strong> Monitoring, guardrails</li>
<li><strong>Hard Solution(s):</strong> Switchback Experimentation Engine</li>
</ul></li>
<li>Optimizing for Long-term Outcomes
<ul>
<li><strong>Easy Solution(s):</strong> Cohort monitoring, Longer experiments, long term hold-out groups</li>
<li><strong>Hard solution(s):</strong> Surrogate Index approach</li>
</ul></li>
</ol>
<p>The final proposed plan ended up being the following:</p>
<ol type="1">
<li>Partner with the data team for each product pillar to build templated SQL for their experiments to save them time.</li>
<li>Automate the secondary analysis of experiments so that stakeholders could understand who the experiments worked best for. We actually chose the easy solution for this, multiple hypothesis testing with corrections. It was easy to implement it and it aligned with our principle of making sure the treatment effect is observable. Plus, if we ever got the point of heterogenous treatment effect modeling, it’d be alot more believeable for stakeholders if they could also look at the multiple hypothesis test reporting. This was a low lift way to free up the teams time and help our stakeholders answer what they wanted. Importantly, we lumped in metric observability with this so that we could understand which experiments were impacting which metrics.</li>
<li>Reduce experiment duration with informative priors and CUPED. Many experiments had an overall evaluation criteria that incorporated customer revenue, Customer revenue was wide-tailed (near lognormally distributed). Using priors was an incredibly easy and insanely effective way to reduce variance for experiments, speeding them up significantly. CUPED would be a way to take that even further. We planned for a data scientist to implement this with their newly freed up time after automating secondary analyses.</li>
<li>Set up monitoring for spillover effects, but don’t implement switchback experiments.</li>
<li>Center the life-insurance product’s experimentation strategy around a surrogate index. This meant running longer experiments so that there was enough power to detect effects on the true north metric. Hopefully after 6 months, we’d have enough information to build a correct surrogate index to start using.</li>
</ol>
<p>There was still a big red flag. We’d have to run longer experiments, and we’d have to wait atleast 6 months to even start using this. That was met with alot of hesitation. Deviating from 1-2 week experiment cadences admittedly sounds a bit nuts. Companies need to grow, and to do that they need to change and try new things. But at the same time we had a problem we couldn’t avoid - the simple fact of the matter was that if we wanted to have conviction in our product changes, we’d have to wait 3-6 months to actually observe its down funnel impact.</p>
<p>We decided to compromise rigor for speed. We planned to immediately implement a surrogate index based on the small amount of data we had, begin running experiments with enough power to detect an effect on our true north metric (3-4 weeks), and use the surrogate index, a guardrail, and our usual mid-funnel outcome as joint primary outcome metrics for upcoming experiments. While not ideal, it’d allow us to start using these ideas immediately, and we’d also be able to build up a better dataset of experiments so that even if the first iteration of the surrogate index didn’t work, we could eventually learn the correct one. That, and we’d have enough power to observe treatment effects on the long term outcome (after waiting a long time).</p>
<p>Really, our <strong>overall strategy was a shift to improving observability</strong>. We created better observability on how experiments were affecting different outcomes and different customers and we created better observability on how our experiments were impacting our true north metric. The funny part is, early in my career I thought this was a big red flag - the more you observe the more likely you could be to identify a false positive. But thats impractical advice. You really have to be looking at the whole picture, that way you can start to understand the business and learn more. Just do so responsibly.</p>
</section>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<p>There’s alot that goes into experimentation beyond just a cool approach like a surrogate index, or CUPED, or HTE modeling. To even get to the point where people will believe in those things, trust needs to built up. The interesting problems we ran into at Policygenius were a huge motivation for me to learn more about recent research in experimentation and causal inference, but looking back I wouldn’t have gotten a chance to do any of that if we hadn’t already built strong foundations. That opened up the door to start influencing the long term strategy for how the business made product decisions.</p>


</section>

 ]]></description>
  <category>experimentation</category>
  <guid>https://kylejcaron.github.io/posts/experiment_strategy/2023-06-09-experiment-strategy.html</guid>
  <pubDate>Mon, 12 Jun 2023 04:00:00 GMT</pubDate>
  <media:content url="https://kylejcaron.github.io/assets/img/placeholder.png" medium="image" type="image/png" height="95" width="144"/>
</item>
<item>
  <title>Useful Tools for Weibull Survival Analysis</title>
  <link>https://kylejcaron.github.io/posts/weibull_survival_analysis/weibull_survival_tools.html</link>
  <description><![CDATA[ 





<section id="weibull-survival-analysis" class="level1">
<h1>Weibull Survival Analysis</h1>
<p>The Weibull distirbution is an excellent choice for many survival analysis problems - it has an interpretable parameterization that is highly flexible to a large number of phenomenon. The main advantage is that it can model how the risk of failure accelerates over time. This post will focus on the <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BWeibull%7D(k,%20%5Clambda)"> parameterization, although I hope to cover the Gumbel reparameterization in the future.</p>
<p>This post requires some base understanding of survival analysis. I’ll try to have another post in the future that discusses survival analysis at a more introductory level</p>
<section id="a-quick-recap-on-survival-curves" class="level2">
<h2 class="anchored" data-anchor-id="a-quick-recap-on-survival-curves">A (quick) Recap on Survival Curves</h2>
<p>Survival Curves model time to some event (such as a failure) - they can tell you the probability of a binary event occurring at each future time point in somethings lifetime. An example survival curve is shown below:</p>
<div id="e7b25e9c" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pymc <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pm</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.ticker <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> mtick</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> weibull <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Weibull</span>
<span id="cb1-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> scipy</span>
<span id="cb1-9">plt.style.use(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fivethirtyeight"</span>)</span>
<span id="cb1-10"></span>
<span id="cb1-11">k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span></span>
<span id="cb1-12">lambd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Weibull(k, lambd)</span>
<span id="cb1-15">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)</span>
<span id="cb1-16">St <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>  dist.survival(t)</span>
<span id="cb1-17"></span>
<span id="cb1-18">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb1-19">ax.plot(t,St, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Survival Curve"</span>)</span>
<span id="cb1-20">ax.yaxis.set_major_formatter(mtick.PercentFormatter(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb1-21">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb1-22">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Survival probability"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb1-23">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"How to Read a Survival Curve"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb1-24">ax.legend(fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb1-25"></span>
<span id="cb1-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Annotations</span></span>
<span id="cb1-27">xlim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.get_xlim()</span>
<span id="cb1-28">ylim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.get_ylim()</span>
<span id="cb1-29">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb1-30">ax.vlines(x, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, St[x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)</span>
<span id="cb1-31">ax.hlines(St[x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, x, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)</span>
<span id="cb1-32">ax.tick_params(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'both'</span>, which<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'major'</span>, labelsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb1-33"></span>
<span id="cb1-34">ax.annotate(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'"There</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\'</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">s a ~60% probability of an event </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">still not occurring by time t=20"'</span>, </span>
<span id="cb1-35">        xy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(x,St[x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb1-36">        xycoords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>, </span>
<span id="cb1-37">        xytext<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>),</span>
<span id="cb1-38">        textcoords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'axes fraction'</span>,</span>
<span id="cb1-39">        arrowprops<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(facecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>, shrink<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>),</span>
<span id="cb1-40">        horizontalalignment<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'left'</span>,</span>
<span id="cb1-41">        verticalalignment<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'top'</span>,</span>
<span id="cb1-42">        fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,</span>
<span id="cb1-43">        bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(boxstyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Round,pad=0.5"</span>, fc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, ec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray"</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-44">)</span>
<span id="cb1-45">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>WARNING (pytensor.tensor.blas): Using NumPy C-API based implementation for BLAS functions.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/weibull_survival_analysis/weibull_survival_tools_files/figure-html/cell-2-output-2.png" width="772" height="482" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>They basically tell you the probability of a unit not observing an event up until some time point.</p>
</section>
<section id="a-quick-recap-on-hazard-curves" class="level2">
<h2 class="anchored" data-anchor-id="a-quick-recap-on-hazard-curves">A (quick) Recap on Hazard Curves</h2>
<p>Hazard Curves are another way to think about survival analysis problems. A hazard curve tells you the instantaneous risk of an event occurring at each time point.</p>
<p>Hazard Curves tend to be very informative as they allow you to see how risk changes over time - sometimes it might decelerate, or sometimes it might even accelerate exponentially. Here’s an example of a hazard curve below.</p>
<div id="d437f457" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span></span>
<span id="cb3-2">lambd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span></span>
<span id="cb3-3"></span>
<span id="cb3-4">dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Weibull(k, lambd)</span>
<span id="cb3-5">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)</span>
<span id="cb3-6">ht <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>  dist.hazard(t)</span>
<span id="cb3-7"></span>
<span id="cb3-8">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb3-9">ax.plot(t,ht, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hazard Curve"</span>)</span>
<span id="cb3-10">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb3-11">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hazard Rate"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb3-12">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"An Example Hazard Curve"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb3-13">ax.legend(fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb3-14"></span>
<span id="cb3-15">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/weibull_survival_analysis/weibull_survival_tools_files/figure-html/cell-3-output-1.png" width="760" height="482" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="textweibullk-lambda-parameter-interpretation" class="level1">
<h1><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BWeibull%7D(k,%20%5Clambda)"> Parameter Interpretation</h1>
<p>Let’s quickly cover how to interpret the parameters - we’ll do this via simulation.</p>
<section id="the-k-parameter" class="level2">
<h2 class="anchored" data-anchor-id="the-k-parameter">The <img src="https://latex.codecogs.com/png.latex?k"> Parameter</h2>
<p>Sometimes also called <img src="https://latex.codecogs.com/png.latex?%5Crho">, this parameter controls the degree of acceleration of the hazard curve.</p>
<div id="b9e55fff" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">ks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>]</span>
<span id="cb4-2">lambd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span></span>
<span id="cb4-3">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">51</span>)</span>
<span id="cb4-4"></span>
<span id="cb4-5">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(ks)):</span>
<span id="cb4-8">    dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Weibull(ks[i], lambd)</span>
<span id="cb4-9">    ht <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dist.hazard(t)</span>
<span id="cb4-10">    ax.plot(t, ht, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"k=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ks[i]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb4-11"></span>
<span id="cb4-12">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb4-13">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hazard Rate"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb4-14">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hazard Curves with Varying k Parameters"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb4-15">ax.legend(fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb4-16">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/weibull_survival_analysis/weibull_survival_tools_files/figure-html/cell-4-output-1.png" width="772" height="482" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As shown above, here’s how different parameter values impact acceleration:</p>
<ul>
<li><strong>When k &lt; 1:</strong> Hazard decelerates</li>
<li><strong>When k = 1:</strong> Hazard is constant. This is equivalent to an exponential distributions hazard function.</li>
<li><strong>When k &gt; 1:</strong> Hazard increases logarithmically</li>
<li><strong>When k = 2:</strong> Hazard increases with constant acceleration</li>
<li><strong>When k &gt; 2:</strong> Hazard increases exponentially</li>
</ul>
<p>Clothing is a great example of something where the hazard increases over time - the risk of a clothing item getting damaged obviously increases over time as the item is worn, washed, gets loose stitching, etc.</p>
</section>
<section id="the-lambda-parameter" class="level2">
<h2 class="anchored" data-anchor-id="the-lambda-parameter">The <img src="https://latex.codecogs.com/png.latex?%5Clambda"> Parameter</h2>
<p>Sometimes also referred to as a <em>scale parameter</em>, this parameter represents the time point where there’s a 63.2% probability of an event having occurred. Weird, I know, its just an arbitrary thing quality</p>
<div id="16e1602c" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span></span>
<span id="cb5-2">lambd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span></span>
<span id="cb5-3">dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Weibull(k, lambd)</span>
<span id="cb5-4">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>)</span>
<span id="cb5-5">St <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dist.survival(t)</span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># choose the point in the survival curve where the time is t=30</span></span>
<span id="cb5-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># take the inverse of it so that its the probability of an event having occurred by that time.</span></span>
<span id="cb5-9">(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>St[t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span>lambd][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>0.6321</code></pre>
</div>
</div>
<p>Let’s see this visually as well - if you look at the plot below, each survival curve indicates that there’s a 63.2% probability of an event having occurred at the exact time that <img src="https://latex.codecogs.com/png.latex?t=%5Clambda"></p>
<div id="e8915473" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">ks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span></span>
<span id="cb7-2">lambds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span>]</span>
<span id="cb7-3">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">151</span>)</span>
<span id="cb7-4"></span>
<span id="cb7-5">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb7-6"></span>
<span id="cb7-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(lambds)):</span>
<span id="cb7-8">    dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Weibull(k, lambds[i])</span>
<span id="cb7-9">    St <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dist.survival(t)</span>
<span id="cb7-10">    ax.plot(t, St, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"lambd=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>lambds[i]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb7-11">    ax.axvline(lambds[i],ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'C</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb7-12"></span>
<span id="cb7-13">ax.axhline(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.632</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>,</span>
<span id="cb7-14">    label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Point where there's a 63.2% probability</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">of the event having occurred</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">by that time"</span>)</span>
<span id="cb7-15"></span>
<span id="cb7-16">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb7-17">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hazard Rate"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb7-18">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hazard Curves with Varying k Parameters"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb7-19">ax.legend(fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"upper right"</span>)</span>
<span id="cb7-20">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/weibull_survival_analysis/weibull_survival_tools_files/figure-html/cell-6-output-1.png" width="915" height="482" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="using-learned-parameters-for-applied-statistics" class="level1">
<h1>Using learned parameters for Applied Statistics</h1>
<p>Ok so lets say you have some estimator that learns the parameters of the weibull distribution - the goal here is to show different ways you can work with these parameters to make predictions</p>
<section id="easier-predictions-lifetime-survival-curves-and-hazard-curves" class="level2">
<h2 class="anchored" data-anchor-id="easier-predictions-lifetime-survival-curves-and-hazard-curves">Easier Predictions: Lifetime, Survival Curves, and Hazard Curves</h2>
<p>Average lifetime, Survival Curves, and Hazard Curves are the basic types of predictions for working with survival analysis. Most distributions have formulas that make these things easier to calculate. Below is the underlying code for these functions.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Weibull:</span>
<span id="cb8-2"></span>
<span id="cb8-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, k, lambd):</span>
<span id="cb8-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k</span>
<span id="cb8-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lambd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lambd</span>
<span id="cb8-6"></span>
<span id="cb8-7">    ...</span>
<span id="cb8-8"></span>
<span id="cb8-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> expectation(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.array:</span>
<span id="cb8-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'''Calculates the expectation of the weibull distribution</span></span>
<span id="cb8-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        '''</span></span>
<span id="cb8-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lambd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sp.gamma(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.k)</span>
<span id="cb8-13"></span>
<span id="cb8-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> survival(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, t: np.array) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.array:</span>
<span id="cb8-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'''Outputs the survival probability at each time point T. This is done with the survival function, </span></span>
<span id="cb8-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        the complement of the Weibull Distribution's PDF.</span></span>
<span id="cb8-17"></span>
<span id="cb8-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Parameters</span></span>
<span id="cb8-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        -----------</span></span>
<span id="cb8-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            t: A numpy array with time points to calculate the survival curve,      </span></span>
<span id="cb8-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                utilizing the distributions parameters</span></span>
<span id="cb8-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        </span></span>
<span id="cb8-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns</span></span>
<span id="cb8-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        -------</span></span>
<span id="cb8-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            St: A survival curve calculated over the inputted time period</span></span>
<span id="cb8-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        '''</span></span>
<span id="cb8-27">        CDF <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.cdf(t)</span>
<span id="cb8-28">        St <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> CDF</span>
<span id="cb8-29">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> St</span>
<span id="cb8-30"></span>
<span id="cb8-31">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> hazard(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, t: np.array) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.array:</span>
<span id="cb8-32">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'''Outputs the hazard rate at each time point T.</span></span>
<span id="cb8-33"></span>
<span id="cb8-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Parameters</span></span>
<span id="cb8-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        -----------</span></span>
<span id="cb8-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            t: A numpy array with time points to calculate the survival curve,      </span></span>
<span id="cb8-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                utilizing the distributions parameters</span></span>
<span id="cb8-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        </span></span>
<span id="cb8-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns</span></span>
<span id="cb8-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        -------</span></span>
<span id="cb8-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            St: A survival curve calculated over the inputted time period</span></span>
<span id="cb8-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        '''</span></span>
<span id="cb8-43">        ht <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lambd)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lambd)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-44">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ht</span>
<span id="cb8-45">    </span>
<span id="cb8-46">    ...</span></code></pre></div>
<p>We already looked into hazard and survival curves - let’s take a look at estimating the average lifetime.</p>
<div id="54915a15" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span></span>
<span id="cb9-2">lambd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span></span>
<span id="cb9-3"></span>
<span id="cb9-4">dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Weibull(k, lambd)</span>
<span id="cb9-5">Et <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dist.expectation()    </span>
<span id="cb9-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Expected Average Lifetime = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(Et,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Expected Average Lifetime = 27.1</code></pre>
</div>
</div>
<p>Does this align with reality? Lets simulate event times from the weibull distribution to find out</p>
<div id="62bbfd4d" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">event_times <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dist.sample(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000000</span>)</span>
<span id="cb11-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Simulated Average Lifetime = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(event_times.mean(),<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simulated Average Lifetime = 27.1</code></pre>
</div>
</div>
</section>
<section id="predicting-mean-residual-life" class="level2">
<h2 class="anchored" data-anchor-id="predicting-mean-residual-life">Predicting Mean Residual Life</h2>
<p>Another common and useful prediction you may want to present is the remaining life. There are a few different ways to calculate this:</p>
<pre><code>1. Use the formula</code></pre>
<p><img src="https://latex.codecogs.com/png.latex?%0AMRL(t)%20=%20%5Cfrac%7B%5Clambda%20%5C:%20%5CGamma(1+1/k,%20%5C:%20(%5Cfrac%7Bt%7D%7B%5Clambda%7D)%5Ek)%7D%7BS(t)%7D%20-%20t%0A"></p>
<p>And we can see it implemented in python below:</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Weibull:</span>
<span id="cb14-2"></span>
<span id="cb14-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, k, lambd):</span>
<span id="cb14-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k</span>
<span id="cb14-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lambd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lambd</span>
<span id="cb14-6"></span>
<span id="cb14-7">    ...</span>
<span id="cb14-8"></span>
<span id="cb14-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> mean_residual_life(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, t: np.array) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.array:</span>
<span id="cb14-10">        t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._normalize_to_array(t)</span>
<span id="cb14-11">        St <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.survival(t)</span>
<span id="cb14-12">        numerator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb14-13">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lambd </span>
<span id="cb14-14">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sp.gammaincc(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.k, (t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lambd)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.k)</span>
<span id="cb14-15">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sp.gamma(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.k))</span>
<span id="cb14-16"></span>
<span id="cb14-17">        result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.divide(</span>
<span id="cb14-18">            numerator,</span>
<span id="cb14-19">            St,</span>
<span id="cb14-20">            out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.zeros_like(numerator),</span>
<span id="cb14-21">            where<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>St<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb14-22">        ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb14-23">        </span>
<span id="cb14-24">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The code above returns negative values when St=0. This clipping corrects those cases</span></span>
<span id="cb14-25">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.clip(result, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, np.inf)</span></code></pre></div>
<p>And we can call that function like so:</p>
<div id="8cbbcfb9" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">curr_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span></span>
<span id="cb15-2">k, lambd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span></span>
<span id="cb15-3">dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Weibull(k,lambd)</span>
<span id="cb15-4">remaining_life <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dist.mean_residual_life(curr_time)</span></code></pre></div>
</div>
<pre><code>2. Simulate</code></pre>
<div id="45d3d628" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dist.sample(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000000</span>)</span>
<span id="cb17-2">units_reached_curr_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T[T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>curr_time] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> curr_time</span>
<span id="cb17-3">remaining_life_simulated <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> units_reached_curr_time.mean()</span></code></pre></div>
</div>
<p>With truncated sampling, this can also be more efficient</p>
<div id="77e03632" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">T_cond <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dist.sample(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000000</span>,left_trunc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>curr_time) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> curr_time</span>
<span id="cb18-2">remaining_life_simulated2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T_cond.mean()</span></code></pre></div>
</div>
<pre><code>3. Transform the hazard curve</code></pre>
<p>There’s a convenient relationship between the hazard curves, survival curves, and expectations. It turns out that</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AS(t)%20=%20%5Ctext%7Bexp%7D(-Ht)%0A"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?Ht"> is the cumulative hazard function. Additionally, the expectation is just the integral of the survival function</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AE%5BT%5D%20=%20%5Cint_%7Bt=0%7D%5E%5Cinfty%20S(t)%20%5C,%20dt%0A"></p>
<p>Using these relationships, we can 1. take the hazard curve from time 40 onwards 2. turn it into the cumulative hazard 3. transform that into a survival curve 4. integrate the survival curve into an expectation</p>
<div id="e80102ca" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">ht <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dist.hazard(np.arange(curr_time, curr_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>))</span>
<span id="cb20-2">Ht <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ht.cumsum()</span>
<span id="cb20-3">St <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Ht)</span>
<span id="cb20-4">remaining_life_from_hazard <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> scipy.integrate.simps(St)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/3n/bm6t53l15kddzf7prg_kj3140000gn/T/ipykernel_24415/124568412.py:4: DeprecationWarning: 'scipy.integrate.simps' is deprecated in favour of 'scipy.integrate.simpson' and will be removed in SciPy 1.14.0
  remaining_life_from_hazard = scipy.integrate.simps(St)</code></pre>
</div>
</div>
<p>Comparing all of these methods we end up with the following:</p>
<div id="db460641" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb22-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Remaining Life (from formula) = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{:.4}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(remaining_life.ravel()[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]),</span>
<span id="cb22-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Remaining Life (from simulation) = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{:.4}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(remaining_life_simulated),</span>
<span id="cb22-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Remaining Life (from truncated simulation) = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{:.4}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(remaining_life_simulated2),</span>
<span id="cb22-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Remaining Life (manually calculated from hazard) = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{:.4}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(remaining_life_from_hazard)</span>
<span id="cb22-6">)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Remaining Life (from formula) = 15.05
 Remaining Life (from simulation) = 15.04
 Remaining Life (from truncated simulation) = 15.05
 Remaining Life (manually calculated from hazard) = 14.14
</code></pre>
</div>
</div>
<p>They’re all very close, but it looks like theres some slight error when manually calculating (and its more complicated).</p>
</section>
<section id="calculating-conditional-survival-curves" class="level2">
<h2 class="anchored" data-anchor-id="calculating-conditional-survival-curves">Calculating Conditional Survival Curves</h2>
<p>The last type of prediction we’ll show here is conditional survival. This is basically saying “what’s the survival curve if we’ve made it up to time=t?”</p>
<p>It turns out, all you have to do is calculate the survival curve and normalize it by the eligible area of the distirbution. This basically means calculating a survival curve past the current time, and then dividing it by the survival function at the current time of interest.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AS(t%7C%5Ctext%7Bcurr%20time%7D=40)%20=%20S(t)/S(40)%0A"></p>
<p>It was pretty easy to add that to the <code>Weibull.survival()</code> function from earlier:</p>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Weibull:</span>
<span id="cb24-2"></span>
<span id="cb24-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, k, lambd):</span>
<span id="cb24-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k</span>
<span id="cb24-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lambd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lambd</span>
<span id="cb24-6">    </span>
<span id="cb24-7">    ...</span>
<span id="cb24-8"></span>
<span id="cb24-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> survival(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, t: np.array, curr_time: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.array:</span>
<span id="cb24-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'''Outputs the survival probability at each time point T. This is done with the survival function, </span></span>
<span id="cb24-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        the complement of the Weibull Distribution's PDF.</span></span>
<span id="cb24-12"></span>
<span id="cb24-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Can also be used to calculate conditional survival with the `curr_time` argument.</span></span>
<span id="cb24-14"></span>
<span id="cb24-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Parameters</span></span>
<span id="cb24-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        -----------</span></span>
<span id="cb24-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            t: A numpy array with time points to calculate the survival curve,      </span></span>
<span id="cb24-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                utilizing the distributions parameters</span></span>
<span id="cb24-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            curr_time: Used to calculate the survival curve given already reaching </span></span>
<span id="cb24-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                some point in time, `curr_time`.</span></span>
<span id="cb24-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        </span></span>
<span id="cb24-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns</span></span>
<span id="cb24-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        -------</span></span>
<span id="cb24-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            St: A survival curve calculated over the inputted time period</span></span>
<span id="cb24-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        '''</span></span>
<span id="cb24-26">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Normalizing constant used for conditional survival</span></span>
<span id="cb24-27">        norm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> curr_time <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.survival(curr_time)</span>
<span id="cb24-28">        </span>
<span id="cb24-29">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check inputs</span></span>
<span id="cb24-30">        t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._normalize_to_array(t)</span>
<span id="cb24-31">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> curr_time <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> (t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> curr_time).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb24-32">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'t&lt;curr_time. t must be greater than or equal to curr_time'</span>)</span>
<span id="cb24-33">        </span>
<span id="cb24-34">        St <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.cdf(t))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>norm</span>
<span id="cb24-35">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> St</span></code></pre></div>
<p>And as we can see below, it lines up perfectly with an empirically calculated kaplan meier curve</p>
<div id="e4be6464" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lifelines <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> KaplanMeierFitter</span>
<span id="cb25-2"></span>
<span id="cb25-3">curr_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span></span>
<span id="cb25-4">T_cond <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dist.sample(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000000</span>, left_trunc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>curr_time) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> curr_time</span>
<span id="cb25-5">kmf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> KaplanMeierFitter()</span>
<span id="cb25-6">kmf.fit(T_cond)</span>
<span id="cb25-7">kmf.plot_survival_function(lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, ls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>)</span>
<span id="cb25-8"></span>
<span id="cb25-9">plt.plot(dist.survival(t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), curr_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>curr_time), label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Conditional Survival Curve"</span>)</span>
<span id="cb25-10">plt.legend()</span>
<span id="cb25-11">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Conditional Survival Rate"</span>)</span>
<span id="cb25-12">plt.title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Conditional Survival Given a Unit Reached Time=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>curr_time<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb25-13">plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/weibull_survival_analysis/weibull_survival_tools_files/figure-html/cell-14-output-1.png" width="723" height="487" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>A convenient feature about survival curves is that if we want to know the probability of an event occurring in the next 1 time period, or 2 time periods, all we have to do is take the complement of the survival probability. So that means we can also use this method to calculate <em>“probability of an event occurring in the next 1 time period”</em></p>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>That’s it for this post on working with Weibull Survival Analysis. There are also other re-parameterizations such as the Gumbel parameterization that I’d like to explore more later, but I found this collection of functionality really helpful in my work building out custom bayesian survival models.</p>


</section>

 ]]></description>
  <category>survival analysis</category>
  <guid>https://kylejcaron.github.io/posts/weibull_survival_analysis/weibull_survival_tools.html</guid>
  <pubDate>Mon, 31 Oct 2022 04:00:00 GMT</pubDate>
</item>
<item>
  <title>Why do we need A/B tests? The Potential Outcomes Model</title>
  <link>https://kylejcaron.github.io/posts/experiment_design.html</link>
  <description><![CDATA[ 





<section id="overview" class="level1">
<h1>Overview</h1>
<p>This blog post introduces the Potential Outcomes Model and introduces why experiments are often necessary to measure what we want. This topic is already covered extensively in other more rigorous resources. This post provides just another example.</p>
</section>
<section id="the-potential-outcomes-model" class="level1">
<h1>The Potential Outcomes Model</h1>
<p>Let’s say we want to know the effect of of a customer support product on a customer outcome such as customer lifetime value LTV. Customers who might seem particularly upset when on the phone with customer support will be more likely to receive a promo code from the customer support staff, which we label as <img src="https://latex.codecogs.com/png.latex?T=1"> (or treatment = True). We represent the outcome, their customer lifetime value (assuming we can observe their full LTV), as <img src="https://latex.codecogs.com/png.latex?Y(1)">, which really just means <em>“what is the outcome Y for customers who had the treatment”</em>.</p>
<section id="a-hypothetical-world" class="level2">
<h2 class="anchored" data-anchor-id="a-hypothetical-world">A Hypothetical world</h2>
<p>What if we envision some hypothetical world we can observe the outcome for each customer who reached out to customer support, with and without having the treatment of receiving a promo?</p>
<div id="381cbe60" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> scipy.special <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sp</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> statsmodels.api <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sm</span>
<span id="cb1-7"></span>
<span id="cb1-8">rng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.default_rng(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb1-9"></span>
<span id="cb1-10">N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100_000</span></span>
<span id="cb1-11">upset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, N)</span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> sim_treatment(upset, rng, return_prob<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb1-14">    beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span></span>
<span id="cb1-15">    p_treatment <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sp.expit( <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> upset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> beta)</span>
<span id="cb1-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> return_prob:</span>
<span id="cb1-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> p_treatment</span>
<span id="cb1-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> rng.binomial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, p_treatment)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> sim_outcome(upset, treatment, rng):</span>
<span id="cb1-21">    eps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(upset))</span>
<span id="cb1-22">    ltv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2500</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>treatment <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>upset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eps </span>
<span id="cb1-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ltv.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-24"></span>
<span id="cb1-25">data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame({</span>
<span id="cb1-26">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Person"</span>: np.arange(N),</span>
<span id="cb1-27">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"upset"</span>: upset,</span>
<span id="cb1-28">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T"</span>: sim_treatment(upset, rng),</span>
<span id="cb1-29">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y(0)"</span>: sim_outcome(upset, np.zeros(N), rng),</span>
<span id="cb1-30">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y(1)"</span>: sim_outcome(upset, np.ones(N), rng)</span>
<span id="cb1-31">}).set_index(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Person"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb1-32">  .assign(ITE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y(1)"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y(0)"</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb1-33">  .assign(Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: np.where(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y(1)"</span>], d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y(0)"</span>]) )</span>
<span id="cb1-34"></span>
<span id="cb1-35">data.head()[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y(0)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y(1)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ITE"</span>]]</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">Y(0)</th>
<th data-quarto-table-cell-role="th">Y(1)</th>
<th data-quarto-table-cell-role="th">ITE</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Person</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>3108.62</td>
<td>3583.87</td>
<td>475.25</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>2347.01</td>
<td>2878.23</td>
<td>531.22</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1</td>
<td>2176.28</td>
<td>2379.30</td>
<td>203.02</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>2146.09</td>
<td>2559.96</td>
<td>413.87</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>2806.50</td>
<td>3623.16</td>
<td>816.66</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As shown above, in this hypothetical world we can see the exact <strong>individual treatment effect (ITE)</strong> for every customer.</p>
<pre><code>- Person 0 would have spent $475.25 more over their lifetime  if they received the promo
- Person 2 would have spend $203.02 more over their lifetime if they received the promo</code></pre>
<p>If we want to know the <strong>Average Treatment Effect (ATE, often denoted <img src="https://latex.codecogs.com/png.latex?%5Ctau">)</strong>, all we have to do is take the mean of all of the individual treatment effects. As we can see, the ATE is about $500</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctau%20=%20%5Cfrac%7B1%7D%7BN%7D%20%5Csum%5E%7BN%7D_%7Bi=0%7D%20Y_i(1)%20-%20Y_i(0)%0A"></p>
<div id="56c330ae" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">data.ITE.mean()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>500.09949529999994</code></pre>
</div>
</div>
<p>We can also represent this in hypothetical terms that will be useful later - the <strong>average treatment effect of the treated (ATT)</strong>, and the <strong>average treatment effect of the untreated (ATU)</strong>. The true ATE ends up being the weighted average of these terms, weighted by the proportion of individuals seeing the treatment, <img src="https://latex.codecogs.com/png.latex?%5Cpi"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Ctau%20&amp;%20=%20%5Cpi%20%5Ccdot%20E%5B%5Ctau%20%7C%20T=1%5D%20+%20(1-%5Cpi)%20%5Ccdot%20E%5B%5Ctau%20%7C%20T=%200%5D%20%5C%5C%0A%20%20%20%20%20&amp;%20=%20%5Cpi%20%5Ccdot%20%5Ctext%7BATT%7D%20+%20(1-%5Cpi)%20%5Ccdot%20%5Ctext%7BATU%7D%0A%5Cend%7Balign%7D%0A"></p>
<p>We can confirm that this is equivalent to the ATE from above with code</p>
<div id="30a5d767" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">pi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T"</span>].value_counts(normalize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb5-2">(pi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> data.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T"</span>).mean()[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ITE"</span>]).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>500.0994953</code></pre>
</div>
</div>
</section>
<section id="getting-hit-with-the-real-world" class="level2">
<h2 class="anchored" data-anchor-id="getting-hit-with-the-real-world">Getting hit with the real world</h2>
<p>So how can we create a scenario where we can observe each person with and without having received the promo? Sadly, we can’t. But is there a way to make use of data we already have? Here’s the actual data we might have access to. Notice that now the hypothetical potential outcomes are no longer visible (just like in the real world).</p>
<div id="66543e58" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Real world data</span></span>
<span id="cb7-2">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb7-3">    data[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"upset"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y(0)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y(1)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ITE"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>]]</span>
<span id="cb7-4">    .assign(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>{</span>
<span id="cb7-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y(0)"</span>:<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: np.where(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T"</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, np.NaN, d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y(0)"</span>]),</span>
<span id="cb7-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y(1)"</span>:<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: np.where(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T"</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, np.NaN, d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y(1)"</span>]),</span>
<span id="cb7-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ITE"</span>: np.NAN</span>
<span id="cb7-8">        })</span>
<span id="cb7-9">)</span>
<span id="cb7-10"></span>
<span id="cb7-11">df.iloc[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:].head()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">Y(0)</th>
<th data-quarto-table-cell-role="th">Y(1)</th>
<th data-quarto-table-cell-role="th">ITE</th>
<th data-quarto-table-cell-role="th">Y</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Person</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>3108.62</td>
<td>NaN</td>
<td>NaN</td>
<td>3108.62</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>2347.01</td>
<td>NaN</td>
<td>NaN</td>
<td>2347.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1</td>
<td>NaN</td>
<td>2379.3</td>
<td>NaN</td>
<td>2379.30</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>2146.09</td>
<td>NaN</td>
<td>NaN</td>
<td>2146.09</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>2806.50</td>
<td>NaN</td>
<td>NaN</td>
<td>2806.50</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>One (unfortunately incorrect) idea might be take the average of Y(1) and subtract the average of Y(0), also known as the <strong>simple difference in outcomes (SDO)</strong>.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BSDO%7D%20=%20E%5B%20Y(1)%20%7C%20T%20=%201%20%5D%20-%20E%5B%20Y(0)%20%7C%20T%20=%200%20%5D%0A"></p>
<blockquote class="blockquote">
<p>Notice that I use the terms <img src="https://latex.codecogs.com/png.latex?E%5B%20Y(0)%20%7C%20T%20=%200%20%5D"> and <img src="https://latex.codecogs.com/png.latex?E%5B%20Y(1)%20%7C%20T%20=%201%20%5D">. Reading these as plain english “the expected value (aka mean) of Y(0) given no treatment” and “the expected value (aka mean) of Y(1) given a treatment”</p>
</blockquote>
<div id="e1661c9a" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">(</span>
<span id="cb8-2">    df.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T"</span>)</span>
<span id="cb8-3">    .mean()[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>]].T</span>
<span id="cb8-4">    .assign(tau <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> d[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb8-5">    .rename(columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E[ Y(0) | T = 0 ]"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E[ Y(1) | T = 1 ]"</span>})</span>
<span id="cb8-6">    .rename_axis(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-7">    .<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb8-8">    .reset_index(drop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb8-9">)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">E[ Y(0) | T = 0 ]</th>
<th data-quarto-table-cell-role="th">E[ Y(1) | T = 1 ]</th>
<th data-quarto-table-cell-role="th">tau</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2579.46</td>
<td>2491.48</td>
<td>-87.98</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><strong>Under the SDO it looks like the treatment has a negative effect</strong> - this is saying that giving customers a promo makes their LTV $88 worse? That seems seriously wrong, and is a huge problem. It should be $500 like we saw in our hypothetical world. So what went wrong?</p>
</section>
<section id="selection-bias" class="level2">
<h2 class="anchored" data-anchor-id="selection-bias">Selection Bias</h2>
<p>We can illustrate the problem by bringing another variable into the mix - customer unhappiness (we’re pretending we can measure it directly for examples sake).</p>
<div id="1c063380" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb9-2">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Histogram of</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Customer unhappiness"</span>)</span>
<span id="cb9-3">df.upset.hist(ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb9-4"></span>
<span id="cb9-5">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"More upset customers are</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">more likely to receive a promo"</span>)</span>
<span id="cb9-6">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion Receiving Promo"</span>)</span>
<span id="cb9-7">df.groupby(df.upset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>).mean()[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T"</span>].plot(ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb9-8">plt.tight_layout()</span>
<span id="cb9-9"></span>
<span id="cb9-10">df.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">upset</th>
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">Y(0)</th>
<th data-quarto-table-cell-role="th">Y(1)</th>
<th data-quarto-table-cell-role="th">ITE</th>
<th data-quarto-table-cell-role="th">Y</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Person</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>-1.157550</td>
<td>0</td>
<td>3108.62</td>
<td>NaN</td>
<td>NaN</td>
<td>3108.62</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.289756</td>
<td>0</td>
<td>2347.01</td>
<td>NaN</td>
<td>NaN</td>
<td>2347.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.780854</td>
<td>1</td>
<td>NaN</td>
<td>2379.3</td>
<td>NaN</td>
<td>2379.30</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.543974</td>
<td>0</td>
<td>2146.09</td>
<td>NaN</td>
<td>NaN</td>
<td>2146.09</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>-0.961383</td>
<td>0</td>
<td>2806.50</td>
<td>NaN</td>
<td>NaN</td>
<td>2806.50</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/experiment_design_files/figure-html/cell-7-output-2.png" width="758" height="279" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It looks like the most unhappy customers are the most likely to receive a treatment as shown in the DAG below.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 220.71 188.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-184 216.71,-184 216.71,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<ellipse fill="none" stroke="black" cx="122.22" cy="-162" rx="90.47" ry="18"></ellipse>
<text text-anchor="middle" x="122.22" y="-157.8" font-family="Arial" font-size="14.00">unhappy customer</text>
</g>
<!-- b -->
<g id="node2" class="node">
<title>b</title>
<ellipse fill="none" stroke="black" cx="72.22" cy="-90" rx="72.45" ry="18"></ellipse>
<text text-anchor="middle" x="72.22" y="-85.8" font-family="Arial" font-size="14.00">receive promo</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge">
<title>a-&gt;b</title>
<path fill="none" stroke="black" d="M110.12,-144.05C104.1,-135.63 96.71,-125.28 90.06,-115.97"></path>
<polygon fill="black" stroke="black" points="92.87,-113.89 84.21,-107.79 87.18,-117.96 92.87,-113.89"></polygon>
</g>
<!-- c -->
<g id="node3" class="node">
<title>c</title>
<ellipse fill="none" stroke="black" cx="122.22" cy="-18" rx="67.29" ry="18"></ellipse>
<text text-anchor="middle" x="122.22" y="-13.8" font-family="Arial" font-size="14.00">lifetime value</text>
</g>
<!-- a&#45;&gt;c -->
<g id="edge2" class="edge">
<title>a-&gt;c</title>
<path fill="none" stroke="black" d="M135.37,-143.91C142.14,-134.01 149.71,-120.96 153.22,-108 157.41,-92.56 157.41,-87.44 153.22,-72 150.64,-62.48 145.88,-52.92 140.84,-44.59"></path>
<polygon fill="black" stroke="black" points="143.73,-42.6 135.37,-36.09 137.84,-46.39 143.73,-42.6"></polygon>
</g>
<!-- b&#45;&gt;c -->
<g id="edge3" class="edge">
<title>b-&gt;c</title>
<path fill="none" stroke="black" d="M84.33,-72.05C90.34,-63.63 97.74,-53.28 104.39,-43.97"></path>
<polygon fill="black" stroke="black" points="107.27,-45.96 110.23,-35.79 101.57,-41.89 107.27,-45.96"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>This is an example of <strong>selection bias</strong> (more specifically, its <strong>collider bias</strong>, a common confound). When comparing customers who had the treatment vs. didnt have the treatment, we accidentally also end up comparing unhappy customers vs.&nbsp;happier customers, and obviously unhappier customers tend to have worse lifetime value. <strong>We need to find a way to compare the impact of the treatment while controlling for the happiness of customers so that we are making a more fair comparison.</strong> For example, if we had 2 equally unhappy customers and 1 received the treatment while the other didnt, we’d get a more reasonable comparison for evaluating the treatment effect.</p>
</section>
<section id="identification-under-selection-bias" class="level2">
<h2 class="anchored" data-anchor-id="identification-under-selection-bias">Identification Under Selection bias</h2>
<p>How can we represent the scenario above with math? This is where the Potential Outcomes model starts coming into play. <em>Note I’m borrowing this directly from Scott Cunningham. For the full proof, see his book, <a href="https://mixtape.scunning.com/">Causal Inference the Mixtape</a></em>.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Ctext%7BSimple%20Difference%20in%20Outcomes%7D%0A&amp;=%20%5Cunderbrace%7BE%5BY(1)%5D%20-%20E%5BY(0)%5D%7D_%7B%20%5Ctext%7BAverage%20Treatment%20Effect%7D%7D%5C%5C%0A&amp;+%20%5Cunderbrace%7BE%5Cbig%5BY(0)%5Cmid%20T=1%5Cbig%5D%20-%20E%5Cbig%5BY(0)%5Cmid%20T=0%5Cbig%5D%7D_%7B%20%5Ctext%7BSelection%20bias%7D%7D%5C%5C%0A&amp;%20+%20%5Cunderbrace%7B(1-%5Cpi)(ATT%20-%20ATU)%7D_%7B%20%5Ctext%7BHeterogeneous%20treatment%20effect%20bias%7D%7D%0A%5Cend%7Balign%7D%0A"></p>
<p>This equation for the Potential Outcomes model basically says that anytime you make a comparison on observational data, it ends up being the sum of the true average treatment effect, selection bias, and Heterogeneous Treatment effect (HTE) bias. HTEs are just a fancy way of saying the personalized effect, aka promos might be more impactful for some users than others.</p>
<p>So how does this relate to what we did before? Well when we tried to compare users who saw the treatment vs.&nbsp;those that didnt</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BSDO%7D%20=%20E%5B%20Y(1)%20%7C%20T%20=%201%20%5D%20-%20E%5B%20Y(0)%20%7C%20T%20=%200%20%5D%0A"></p>
<p>we didnt take into account the fact that users who saw the treatment tend to be different than those who didn’t. Users who saw the treatment tend to be more unhappy by design.</p>
<p>So if we subtract out the <strong>selection bias</strong> from the SDO (I got this via simple algebra), aka we control for the unhappiness between customers, we can get closer to identifying the true ATE.</p>
<p>Note that selection bias was <img src="https://latex.codecogs.com/png.latex?%0AE%5Cbig%5BY(0)%5Cmid%20T=1%5Cbig%5D%20-%20E%5Cbig%5BY(0)%5Cmid%20T=0%5Cbig%5D%0A"></p>
<p>This is just saying selection bias is the fundamental difference between users who get picked for treatment vs.&nbsp;those who dont.</p>
<p>In our case, the fundamental difference between whether users are selected for treatment is based upon their unhappiness. So if we can subtract out the effect of unhappiness, we can subtract out the selection bias</p>
<div id="45a321eb" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">df.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T"</span>).mean()[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"upset"</span>]].T</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">upset</td>
<td>-0.159046</td>
<td>1.018004</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can do this with OLS. The most obvious way is to fit a model relating unhappiness to LTV, and then subtract out that effect.</p>
<div id="1dfef0ec" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">model1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sm.OLS.from_formula(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y ~ upset"</span>, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df.loc[<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T"</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]).fit()</span>
<span id="cb11-2">Y0_hat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model1.predict(df)</span>
<span id="cb11-3"></span>
<span id="cb11-4">selection_bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb11-5">    df.assign(selection_bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Y0_hat)</span>
<span id="cb11-6">    .groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T"</span>).mean()</span>
<span id="cb11-7">    [[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"selection_bias"</span>]]</span>
<span id="cb11-8">)</span>
<span id="cb11-9">selection_bias.T.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">selection_bias</td>
<td>2579.46</td>
<td>1990.96</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>And finally we can subtract out the effect, ending up with an estimate very close to the true ATE of 500</p>
<div id="f4bbff11" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">(</span>
<span id="cb12-2">    df.assign(selection_bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Y0_hat)</span>
<span id="cb12-3">    .groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T"</span>).mean()[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"selection_bias"</span>]].T</span>
<span id="cb12-4">    .assign(difference <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> d[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb12-5">    [[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"difference"</span>]].T</span>
<span id="cb12-6">    .reset_index(drop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb12-7">    .rename(columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SDO"</span>})</span>
<span id="cb12-8">    .assign(tau <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> d: d.SDO <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> d.selection_bias)</span>
<span id="cb12-9">    .<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb12-10">)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SDO</th>
<th data-quarto-table-cell-role="th">selection_bias</th>
<th data-quarto-table-cell-role="th">tau</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>-87.98</td>
<td>-588.5</td>
<td>500.52</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>There’s actually an even more simple way to control for selection bias - it can just be included as a term in an OLS regression model.</p>
<div id="b6c0fc11" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> statsmodels_to_df(model):</span>
<span id="cb13-2">    table <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(model.summary().tables[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].data)</span>
<span id="cb13-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> pd.DataFrame(table[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:], columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>table[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:], index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>table[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb13-4"></span>
<span id="cb13-5">model2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sm.OLS.from_formula(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" Y ~ T + upset"</span>, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df).fit()</span>
<span id="cb13-6">statsmodels_to_df(model2)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">std err</th>
<th data-quarto-table-cell-role="th">t</th>
<th data-quarto-table-cell-role="th">P&gt;|t|</th>
<th data-quarto-table-cell-role="th">[0.025</th>
<th data-quarto-table-cell-role="th">0.975]</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Intercept</td>
<td>2499.9363</td>
<td>0.516</td>
<td>4847.317</td>
<td>0.000</td>
<td>2498.925</td>
<td>2500.947</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">T</td>
<td>500.5529</td>
<td>1.502</td>
<td>333.191</td>
<td>0.000</td>
<td>497.608</td>
<td>503.497</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">upset</td>
<td>-500.0068</td>
<td>0.518</td>
<td>-965.940</td>
<td>0.000</td>
<td>-501.021</td>
<td>-498.992</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As we can see above the estimate of the treatment effect is the beta coefficient for <code>T</code> and it closely matches our manual estimate above.</p>
</section>
<section id="a-quick-note-on-heterogeneous-treatment-effects" class="level2">
<h2 class="anchored" data-anchor-id="a-quick-note-on-heterogeneous-treatment-effects">A quick note on Heterogeneous Treatment Effects</h2>
<p>We’ve controlled for selection bias, what about Heterogeneous Treatment Effect bias? We actually don’t need to control for these once we’ve controlled for selection bias. These average treatment effect ends up being the average of all of the HTEs of individuals, which is fine because as long as we’ve accounted for selection bias, the HTEs tend to cancel out. They’re essentially captured by the error term, <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> in OLS <img src="https://latex.codecogs.com/png.latex?%0Ay%20=%20%5Calpha%20+%20%5Cbeta%20X%20+%20%5Cepsilon%0A"></p>
<p>We can also see that in our code, where the distribution of true HTE bias from our hypothetical dataset is centered at zero. Any time we’ve accounted for all selection bias, the HTE should be zero centered and cancel itself out as N increases.</p>
<div id="c684ff3c" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">ATE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ITE"</span>].mean()</span>
<span id="cb14-2">HTE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data.ITE.values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ATE</span>
<span id="cb14-3">sns.histplot(HTE)</span>
<span id="cb14-4">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HTE"</span>)</span>
<span id="cb14-5">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distribution of HTEs (each customers difference from the ATE)"</span>)</span>
<span id="cb14-6">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://kylejcaron.github.io/posts/experiment_design_files/figure-html/cell-12-output-1.png" width="601" height="449" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The bias of HTEs for each person is just the distance their treatment effect is from the average treatment effect. Again, this follows the same property as the error term in OLS regression, which is why it can be such a powerful tool for causal inference <em>when used correctly</em>.</p>
</section>
</section>
<section id="why-are-ab-tests-needed" class="level1">
<h1>Why are A/B tests needed?</h1>
<p>We saw that when taking a simple difference in outcomes that we can end up with biased inference. Controlling for selection bias can help fix this, but we may not always be able to do so.</p>
<p>For instance, consider if we didn’t have data on customer unhappiness (which is more likely true than not in the real world) - how would we control for it?</p>
<p>In many cases we can’t, or even if we can (such as with Instrumental Variable Analysis), it’s very difficult. This is where randomization and A/B testing come into play.</p>
<p>Remember that the whole reason we had issues with measuring the ATE was because users treated ended up being fundamentally different from those that weren’t. But what if we made it so that its purely random who receives the treatment and who doesn’t? Then we’d expect the same level of unhappiness in each group, cancelling out any selection bias. HTEs would cancel out as well like before, and <strong>by randomizing, we find that the simple difference in outcomes equals the true average treatment effect</strong>.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Ctext%7BSimple%20Difference%20in%20Outcomes%7D%0A&amp;=%20%5Cunderbrace%7BE%5BY(1)%5D%20-%20E%5BY(0)%5D%7D_%7B%20%5Ctext%7BAverage%20Treatment%20Effect%7D%7D%5C%5C%0A&amp;+%20%5Cunderbrace%7B%20%5Ccancel%7BE%5Cbig%5BY(0)%5Cmid%20T=1%5Cbig%5D%20-%20E%5Cbig%5BY(0)%5Cmid%20T=0%5Cbig%5D%7D%7D_%7B%20%5Ctext%7BSelection%20bias%7D%7D%5C%5C%0A&amp;%20+%20%5Cunderbrace%7B%5Ccancel%7B(1-%5Cpi)(ATT%20-%20ATU)%7D%7D_%7B%20%5Ctext%7BHeterogeneous%20treatment%20effect%20bias%7D%7D%0A%5Cend%7Balign%7D%0A"></p>
<p>This is why randomization is so powerful, and why many people say A/B tests are the gold standard.</p>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<p>In this post we walked through the Potential Outcomes Model, showed how it applies to a fake data scenario, and then used it to tie back to why randomization works for A/B testing.</p>
</section>
<section id="additional-reading" class="level1">
<h1>Additional Reading</h1>
<p>This is just one example of many that exist out there. Here are some other examples I’ve come across:</p>
<ul>
<li>Scott Cunningham’s <a href="https://mixtape.scunning.com/04-potential_outcomes">“The Perfect Doctor” example</a> from <a href="https://mixtape.scunning.com/">Causal Inference: the Mixtape</a></li>
<li>Matheus Facure’s <a href="https://matheusfacure.github.io/python-causality-handbook/landing-page.html">Causal Inference for the Brave and True</a></li>
</ul>


</section>

 ]]></description>
  <category>experimentation</category>
  <guid>https://kylejcaron.github.io/posts/experiment_design.html</guid>
  <pubDate>Sat, 17 Sep 2022 04:00:00 GMT</pubDate>
  <media:content url="https://kylejcaron.github.io/assets/img/placeholder.png" medium="image" type="image/png" height="95" width="144"/>
</item>
<item>
  <title>Making out of sample predictions with PyMC</title>
  <link>https://kylejcaron.github.io/posts/2022-04-17-out-of-sample-pymc.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>A cool thing about hierarchical models is that its easy to predict out of sample - i.e.&nbsp;if you want to make a prediction on a new zipcode, just sample from the state’s distribution (composed of the state average and variance across zip codes in that state).</p>
<p>In pymc3, it’s somewhat easy to accomplish this, but not as straightforward as we’d hope. This blog post will show a trick that lets you easily predict out of sample, and will reduce some of the overhead that comes from writing alot of custom prediction functions</p>
</section>
<section id="simulating-data" class="level1">
<h1>Simulating data</h1>
<p>I simulated a 2 level hierarchical model - for interpretability, I set it up as a state &gt; zipcode model. You can following along with the notebook <a href="https://github.com/kylejcaron/case_studies/blob/main/PyMC%20out%20of%20sample%20predictions.ipynb">here</a>. The data is as follows</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/out_of_sample/fig1.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="using-categorical-variables" class="level1">
<h1>Using categorical variables</h1>
<p>Categorical variables are a somewhat new feature of pandas - they can store categories that aren’t in the observed data, and are an easy replacement for <code>pd.factorize()</code> (a common tool for those familiar with the bayesian workflow).</p>
<p>We can use these to trick pymc into thinking there’s a category with no observed data, and pymc ends up assigning the global distribution to that unobserved category, which we can simply reference in the future for any time we want to make a prediction on out of sample data.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to categorical and add an `out_of_sample` category</span></span>
<span id="cb1-2">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.assign(state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.Categorical(df.state).add_categories(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"out_of_sample"</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb1-3">    .assign(zipcode <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.Categorical(df.zipcode).add_categories(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"out_of_sample"</span>))</span></code></pre></div>
</section>
<section id="fitting-the-model" class="level1">
<h1>Fitting the model</h1>
<p>We’ll use the codes from the categorical columns to index our model coefficients, and we’ll use the categories as coordinates for the model to map names to.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb2-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"state"</span>:df.state.cat.categories,</span>
<span id="cb2-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zipcode"</span>:df.zipcode.cat.categories</span>
<span id="cb2-4">}</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> hierarchical_normal(name, μ, dims):</span>
<span id="cb2-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'''Adapted from Austin Rochford'''</span></span>
<span id="cb2-8">    Δ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Normal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Δ_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(name), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.</span>, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dims)</span>
<span id="cb2-9">    σ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Exponential(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'σ_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(name), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>)</span>
<span id="cb2-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> pm.Deterministic(name, μ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Δ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> σ, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dims)</span>
<span id="cb2-11"></span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> pm.Model(coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>coords) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> model_nc:</span>
<span id="cb2-14">    </span>
<span id="cb2-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Observed Data tracking</span></span>
<span id="cb2-16">    state_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Data(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"state_"</span>, df.state.cat.codes)</span>
<span id="cb2-17">    zip_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Data(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zip_"</span>, df.zipcode.cat.codes)</span>
<span id="cb2-18">    obs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Data(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obs"</span>, df.y)</span>
<span id="cb2-19"></span>
<span id="cb2-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Hyperprior</span></span>
<span id="cb2-21">    mu_country <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Normal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu_country"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-22">    </span>
<span id="cb2-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prior</span></span>
<span id="cb2-24">    sig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Exponential(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sig"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-25">    </span>
<span id="cb2-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Hierarchical coefficients</span></span>
<span id="cb2-27">    mu_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hierarchical_normal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu_state"</span>, μ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mu_country, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"state"</span>)</span>
<span id="cb2-28">    mu_zipcode <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hierarchical_normal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu_zipcode"</span>, μ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mu_state, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zipcode"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"state"</span>) )</span>
<span id="cb2-29">    </span>
<span id="cb2-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Observational model</span></span>
<span id="cb2-31">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Normal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>, mu_zipcode[zip_, state_], sig, observed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>obs)</span>
<span id="cb2-32">    </span>
<span id="cb2-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit </span></span>
<span id="cb2-34">    trace_nc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.sample(target_accept<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, return_inferencedata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, random_seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>SEED)</span></code></pre></div>
<p>There are a few key point that make out of sample prediction possible * Having the <code>out_of_sample</code> category for each indexed variable with no observed data * Passing the <code>coords</code> in the model statement * Using dims to reference which model coefficients have which coordinate labels * Having all of our input data wrapped in a <code>pm.Data()</code> statement</p>
<p>That last point is particularly important. For PyMC, if you want to make predictions on new data, you have to replace the data that the model references and the only way to do that (that I know of atleast) is to using a Theano shared variable. <code>pm.Data()</code> handles all of that fo you.</p>
<p>So we fit our model, lets take a quick look at the state level coefficients</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">pm.plot_forest(trace_nc, var_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu_state"</span>])</span></code></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/out_of_sample/fig2.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Great, that out of sample variable seems to represent the <code>global</code> distribution across states - i.e.&nbsp;if we were to make a prediction for a new state we’d potentially use that distribtion (we’ll confirm further down).</p>
<p>We’ll check the zip code level below as well, looking at Maine specifically</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/out_of_sample/fig3.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>As we can see, the <code>out_of_sample</code> variable has a sampled value despite there being no observed data for it. Now the question is, does this align with how we’d predict new data?</p>
<p>Let’s try calculating coefficients out of sample by hand and see if it aligns with the out_of_sample values</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">post <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trace_nc.posterior</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pull the true data from our simulation</span></span>
<span id="cb4-4">state_true <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mu_state_true.random(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>)</span>
<span id="cb4-5"></span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate out of sample state means by drawing from global distribution</span></span>
<span id="cb4-8">mu_country <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu_country"</span>].values.reshape(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-9">σ_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"σ_mu_state"</span>].values.reshape(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-10">mu_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.normal(mu_country, σ_state)</span>
<span id="cb4-11"></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using the indexing trick</span></span>
<span id="cb4-13">state_idx_trick <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu_state"</span>].sel({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"state"</span>:[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"out_of_sample"</span>]}).values.ravel()</span>
<span id="cb4-14"></span>
<span id="cb4-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pull the true data from simulation</span></span>
<span id="cb4-16">zip_true <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Normal.dist(mu_state_true.random(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>), sig_zip_true).random(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>)</span>
<span id="cb4-17"></span>
<span id="cb4-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># calculate out of sample mu by hand by drawing from out of sample state prediction above</span></span>
<span id="cb4-19">σ_zipcode <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"σ_mu_zipcode"</span>].values.reshape(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-20">mu_zipcode <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.normal(mu_state, σ_zipcode)</span>
<span id="cb4-21"></span>
<span id="cb4-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use the indexing trick</span></span>
<span id="cb4-23">zip_idx_trick <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu_zipcode"</span>]</span>
<span id="cb4-24">                .sel({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"state"</span>:[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"out_of_sample"</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zipcode"</span>:[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"out_of_sample"</span>]})</span>
<span id="cb4-25">                .values.ravel())</span></code></pre></div>
<p>We can compare these results by plotting their distributions below</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/out_of_sample/fig4.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Notice that the manual prediction and the indexing trick are basically identical. There’s a slight difference from the ground truth, but thats to be expected since we’re fitting a model on limited data (and anyway, it’s still quite close).</p>
</section>
<section id="predicting-out-of-sample" class="level1">
<h1>Predicting out of sample</h1>
<p>Let’s go ahead and actually make prediction now - we’ll make predictions for the following data below</p>
<ul>
<li>The first example is in sample</li>
<li>The second example is in sample for state, out of sample for zipcode</li>
<li>The third example is out of sample entirely</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/out_of_sample/fig5.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>And finally we’ll use the model to make predictions on this new data. Notice the <code>pm.set_data()</code> function - remember our <code>pm.Data()</code> calls from before? This tells PyMC to override that with new data, so when we sample from the posterior predictive it makes predictions on the new data instead of the data used to fit the model.</p>
<details>
<summary>
Click here for helper function code
</summary>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We're making some quick convenience functions to map this new data </span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to the proper indexes from the fitted model</span></span>
<span id="cb5-3">zip_lookup <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(df.zipcode.cat.categories, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df.zipcode.cat.categories))))</span>
<span id="cb5-4">state_lookup <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(df.state.cat.categories, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df.state.cat.categories))))</span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> labels_to_index(series, lookup):</span>
<span id="cb5-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'''Converts categories to their proper codes'''</span></span>
<span id="cb5-8">    series <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> series.copy()</span>
<span id="cb5-9">    in_sample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> series.isin(lookup.keys())</span>
<span id="cb5-10">    series.loc[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>in_sample] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"out_of_sample"</span></span>
<span id="cb5-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> series.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(lookup).values.astype(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"int8"</span>)</span></code></pre></div>
</details>
<p><br></p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> model_nc:</span>
<span id="cb6-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set new data for the model to make predictions on</span></span>
<span id="cb6-3">    pm.set_data({</span>
<span id="cb6-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"state_"</span>: X.state.pipe(labels_to_index, state_lookup),</span>
<span id="cb6-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zip_"</span>: X.zipcode.pipe(labels_to_index, zip_lookup)</span>
<span id="cb6-6">    })</span>
<span id="cb6-7">    </span>
<span id="cb6-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make predictions</span></span>
<span id="cb6-9">    preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.sample_posterior_predictive(trace_nc)</span></code></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/out_of_sample/fig6.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>This is exactly what we were looking for - and prediction is easy, just map any out of sample states or zipcodes to the <code>out_of_sample</code> category. Notice how in sample predictions have smaller uncertainty intervals and out of sample data is more uncertain - this is exactly what we’d expect. This trick makes it much easier to make predictions compared to having to write out a custom prediction function that follows the same logic as the model.</p>
<p>If you have any other easy tricks for out of sample prediction let me know!</p>


</section>

 ]]></description>
  <guid>https://kylejcaron.github.io/posts/2022-04-17-out-of-sample-pymc.html</guid>
  <pubDate>Sun, 17 Apr 2022 04:00:00 GMT</pubDate>
  <media:content url="https://kylejcaron.github.io/assets/img/placeholder.png" medium="image" type="image/png" height="95" width="144"/>
</item>
<item>
  <title>How long should you run an A/B test for?</title>
  <link>https://kylejcaron.github.io/posts/2022-04-05-ab-test-duration.html</link>
  <description><![CDATA[ 





<p>For some people in industry new to A/B testing, they might wonder “Why cant we just run an A/B test for 2 days and be done with it?”. Even those familiar with it might wonder why their team’s Data Scientist is insisting on so much. And even Data Scientists may be looking for easier ways to explain the need to them. The goal of this article is to cover just that, from a naive and explainable point of view.</p>
<p>So, <strong>How long should you run an A/B test for?</strong> Well let’s say you step into a casino with $5000 and you walk away with $6000. You just made a 20% return. Is it fair to say that a night out in the casino leads to a 20% return? Is it fair to say that our A/B test we ran for 2 days leads to a 20% lift in conversion? How do we know for sure?</p>
<p><strong>We should run an A/B test for as long as it takes to rule out random chance.</strong></p>
<p>While vague, and technically not the full picture, your friendly neightborhood data scientist should be able to answer this for you. The code for this blogpost can be found <a href="https://github.com/kylejcaron/case_studies/blob/master/How%20long%20should%20you%20run%20an%20AB%20Test%20for%3F.ipynb">here</a>.</p>
<p><br></p>
<section id="simulating-a-fake-scenario" class="level3">
<h3 class="anchored" data-anchor-id="simulating-a-fake-scenario">Simulating a fake scenario</h3>
<p>Let’s play out the casino example from above. I’m going to simulate out an entirely fake, but entirely possible scenario.</p>
<p>You go to the casino one night with $5000 and decide roulette is your game of choice. You get a little into it and play 500 rounds (in one night?? for examples sake, yes). Little do you know the real probability of winning is 48.5%</p>
<p>The plot below shows the total money you had at the start of each round of roulette</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/how_long_ab_test/fig1.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>This is great - after 500 rounds of this you’ve made 122% return on your initial investment of $5000 and you’re winning 51% of the time.</p>
<p>Playing roulette must lead to a 20% return right? Commited to your strategy you decide to come back over the next few weeks and play another 3000 rounds, shown below.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/how_long_ab_test/fig2.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Alright you’ve played 3500 rounds now and you have $5400 total. You’ve definitely had some runs of bad luck, but you’re still seeing a win percentage above 50% (50.1% in fact) and right now you’re heating up. You stay determined and play until you reach 15000 rounds.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/how_long_ab_test/fig3.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="what-happened" class="level1">
<h1>What happened?</h1>
<p>We started off on a hot streak winning 51% of our rounds, but as we played more and more rounds, it became more obvious we were losing money. This is a demonstration of the law of large numbers - as we play more and more rounds, the truth comes out</p>
<p>We can visualize this process via the beta distribution below. These plots visualize all of the possible values that the true win percentage could be (the x axis), and their relative plausibilities (the y axis). The first plot can be read as follows:</p>
<blockquote class="blockquote">
<p>The win percentage is likely to be somewhere between 42.5% and 60%, with the most likely value being around 51%</p>
</blockquote>
<p>As we move from left to right, our estimated distribution converges closer and closer to the true probability of winning a round</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/how_long_ab_test/fig4.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>We can also visualize this as a time series, which really makes it clear how the uncertainty becomes smaller over time and the estimated value converges to the true value.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/how_long_ab_test/fig5.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><br></p>
<section id="how-does-this-tie-back-to-ab-testing" class="level3">
<h3 class="anchored" data-anchor-id="how-does-this-tie-back-to-ab-testing">How does this tie back to A/B testing?</h3>
<p>If we don’t choose our sample size for an experiment properly, we can end up making the wrong decisions!<sup>1</sup> The larger the sample size we choose, the more likely we’ll make the right choice.</p>
<p>We can use <strong>power analyses</strong> (sometimes referred to as simulation studies) to estimate what sample size is needed for an experiment given the desired outcome.</p>
<hr>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Unless you’re using bayesian inference, which can really mitigate this risk.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <guid>https://kylejcaron.github.io/posts/2022-04-05-ab-test-duration.html</guid>
  <pubDate>Fri, 15 Apr 2022 04:00:00 GMT</pubDate>
  <media:content url="https://kylejcaron.github.io/assets/img/placeholder.png" medium="image" type="image/png" height="95" width="144"/>
</item>
<item>
  <title>Uncertainty Intervals or p-values?</title>
  <link>https://kylejcaron.github.io/posts/2022-04-11-uncertainty_intervals_over_pvals.html</link>
  <description><![CDATA[ 





<p>Uncertainty Intervals are better than p-values. Sure, its better to use both, but p-values are just a point estimate and they bring no concept of uncertainty in our estimate - this can lead to situations where we expose ourselves to high downside risk.</p>
<p>Take the following example for instance. Let’s say we’re running a “Do no harm” A/B test where we want to roll out an experiment as long as it doesnt harm conversion rate.</p>
<p>If you want to follow along with the code, <a href="https://github.com/kylejcaron/case_studies/blob/main/Uncertainty%20intervals%20over%20p%20values.ipynb">see here</a>.</p>
<section id="the-experiment-design" class="level2">
<h2 class="anchored" data-anchor-id="the-experiment-design">The experiment design</h2>
<p>Given the stakeholders want to rule out a drop in conversion, and ruling out small differences requires large sample sizes, we decide to design an experiment with good power to detect the presence of a 1/2% absolute drop (if one were to truly exist)</p>
<p>We ran a power analysis and found that in order to have a 90% probability of detecting (power=0.9) a 1/2% absolute drop in conversion rate with 80 percent confidence ( 𝛼=0.2 ), we need N=32500 per group</p>
<blockquote class="blockquote">
<p>Statisticians might not love this interpretation of a power analysis, but its a useful and interpretable translation and tends to coincide with what we’re aiming for anyway. In reality, frequentist power analyses assume that the null hypothesis is correct, which isn’t quite what we want, not to mention, frequentist power analyses use backwards probabilities which are just plain confusing - <a href="https://www.fharrell.com/post/pvalprobs/">see here to for more</a></p>
</blockquote>
<p>Note that we’re prioritizing power here for a reason. If 𝛼 is false positive rate, and power is probability of detection, then don’t we want to prioritize our probability of detecting a drop if one truly exists? A false negative here would be more expensive then a false positive</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1">pA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># historical conversion rate</span></span>
<span id="cb1-2">abs_delta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.005</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minimum detectable effect to test for</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Statsmodels requires an effect size </span></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (aka an effect normalized by its standard deviation)</span></span>
<span id="cb1-6">stdev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.sqrt( pA<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>pA) ) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bernoulli stdev, sigma = sqrt(p(1-p))</span></span>
<span id="cb1-7">ES <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> abs_delta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> stdev </span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># estimate required sample size</span></span>
<span id="cb1-10">sm.stats.tt_ind_solve_power(</span>
<span id="cb1-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>ES, </span>
<span id="cb1-12">    alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,</span>
<span id="cb1-13">    power<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,</span>
<span id="cb1-14">    alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"smaller"</span></span>
<span id="cb1-15">)</span></code></pre></div>
<p>Running the code above leads us to conclude are sample size should be roughly 32,500 users per group.</p>
<section id="the-experiment" class="level3">
<h3 class="anchored" data-anchor-id="the-experiment">The experiment</h3>
<p>I’m going to simulate fake data for this experiment where * The <strong>control</strong> has a <strong><em>true</em></strong> conversion rate of 10% * the <strong>variant</strong> has a <strong><em>true</em></strong> conversion rate of 9.25%</p>
<p>For examples sake we’ll pretend we don’t know that the variant is worse</p>
<details>
<summary>
Click here for code
</summary>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Settings</span></span>
<span id="cb2-2">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1325</span>)</span>
<span id="cb2-3">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32500</span></span>
<span id="cb2-4">pA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb2-5">pB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0925</span></span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulation</span></span>
<span id="cb2-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> simulate_experiment(pA, pB, N_per_group):</span>
<span id="cb2-9">    </span>
<span id="cb2-10">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame({</span>
<span id="cb2-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"group"</span>:[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>N,</span>
<span id="cb2-12">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"convert"</span>:np.r_[</span>
<span id="cb2-13">             np.random.binomial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>pA, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>N),</span>
<span id="cb2-14">             np.random.binomial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>pB, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>N)</span>
<span id="cb2-15">        ]</span>
<span id="cb2-16">    })</span>
<span id="cb2-17">    </span>
<span id="cb2-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> df</span>
<span id="cb2-19"></span>
<span id="cb2-20">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> simulate_experiment(pA, pB, N)</span></code></pre></div>
</details>
<p><br></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/uncertainty_fig1.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Looking at the data above, we’re seeing a better conversion rate in group B. We run a two-proportions z-test and we find that there’s a non-significant p-value, meaning we found insufficient evidence of the variant having lower conversion than the control.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> pval_from_summary(tab):</span>
<span id="cb3-2">    </span>
<span id="cb3-3">    _, pval <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sm.stats.proportions_ztest(</span>
<span id="cb3-4">        count<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tab[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"converts"</span>][::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], </span>
<span id="cb3-5">        nobs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tab[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N"</span>][::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb3-6">        alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"smaller"</span></span>
<span id="cb3-7">    )</span>
<span id="cb3-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> pval</span>
<span id="cb3-9"></span>
<span id="cb3-10">(df.pipe(summarize_experiment)</span>
<span id="cb3-11">   .pipe(pval_from_summary))</span></code></pre></div>
<p><img src="https://latex.codecogs.com/png.latex?%20p%20=%200.38%20"></p>
<p>We recommend to our stakeholders to roll out the variant since it “does no harm”</p>
<p><strong>There are some serious red flags here</strong></p>
<ul>
<li>First of all, p-values are all about the null hypothesis. So just because we don’t find a significant drop in conversion rate, that doesnt mean one doesnt exist. It just means we didnt find evidence for it in this test</li>
<li>There was no visualization of the uncertainty in the result</li>
</ul>
</section>
</section>
<section id="understanding-uncertainty-with-the-beta-distribution" class="level2">
<h2 class="anchored" data-anchor-id="understanding-uncertainty-with-the-beta-distribution">Understanding Uncertainty with the Beta Distribution</h2>
<p>For binary outcomes, the beta distribution is highly effective for understanding uncertainty.</p>
<p>It has 2 parameters * <strong>alpha</strong>, the number of successes * <strong>beta</strong>, the number of failures</p>
<p>It’s output is easy to interpret: Its a distribution of plausible probabilities that lead to the outcome.</p>
<p>So we can simply count our successes and failures from out observed data, plug it into a beta distribution to simulate outcomes, and visualize it as a density plot to understand uncertainty</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/uncertainty_fig2.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>It’s also easy to work with - if we want to understand the plausible differences between groups, we can just take the differences in our estimates</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cdelta%20=%20%5Chat%7Bp_B%7D%20-%20%5Chat%7Bp_A%7D%0A"></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/uncertainty_fig3.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>With visualization, we get a very different picture than our non-significant p-value. We see that there’s plenty of plausibility that the control could be worse.</p>
<p>We can further calculate the probability of a drop, <img src="https://latex.codecogs.com/png.latex?P(B%20%3C%20A)">, and find that theres a greater than 60% probability that the variant is worse than the control</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># P(B &lt; A)</span></span>
<span id="cb4-2">(pB_hat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> pA_hat).mean()</span></code></pre></div>
<p><img src="https://latex.codecogs.com/png.latex?%0AP(B%20%3C%20A)%20=%200.62%0A"></p>
<p>Remember when we designed the experiment? Considering our main goal was to do no harm, we might not feel so confident in that now, and rightly so, we know the variants worse since we simulated it.</p>
<p>Unless we feel very confident in our choice of testing for a 1/2% drop and know that we can afford anything up to that, then we we really shouldnt roll out this variant without further evaluation</p>
<p>This is particularly important with higher uncertainty As we can see in the example below, where the observed conversion rate is better in the variant, but the downside risk is as high as a 4% drop in conversion rate</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/uncertainty_fig4.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap%20=%200.59%0A"></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/uncertainty_fig5.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="another-example-which-metric" class="level1">
<h1>Another Example: Which Metric?</h1>
<p>This is a fun problem from <a href="https://twitter.com/seanjtaylor"><span class="citation" data-cites="seanjtaylor">@seanjtaylor</span></a> &gt; “You run a product test and measure a strong positive effect on your first metric.</p>
<blockquote class="blockquote">
<p>Metric 1: +1% (p&lt;.01)</p>
</blockquote>
<blockquote class="blockquote">
<p>You also see a negative, but not significant result on equally important Metric 2. You only care about these two metrics. Which of these estimates would you prefer to ship?”</p>
</blockquote>
<blockquote class="blockquote">
<ol type="1">
<li><input type="checkbox" unchecked=""> Metric 2: -0.5% (p = 0.10)</li>
<li><input type="checkbox" unchecked=""> Metric 2: -0.5% (p=0.45)</li>
<li><input type="checkbox" unchecked=""> Neither is shippable</li>
</ol>
</blockquote>
<p><br></p>
<p><em>Try to think it through on your own first, then scroll down for the answer</em></p>
<p><br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br></p>
<p>If you chose option 2, you weren’t alone. Option 1 makes it seem like there’s a more likely negative effect due to the lower p-value, so thats worse, right?</p>
<p>Not quite. Check out the uncertainties. The downside risk option 2 is much worse than option 1.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/uncertainty_fig6.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>We can take this one step further and add our effects to compare (remember we assumed the metrics are equally important), and see if it’s overall net positive</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/uncertainty_fig7.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>As shown above, the non significant p value option has a higher probability of being negative, AND it gives more plausibility to more negative possible effects</p>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<p>Always report uncertainty intervals - p-values definitely dont tell the whole story, even with well designed experiments. As we saw, ignoring uncertainty can expose ourselves to high downside, especially when our choice in experiment design has even the slightest bit of arbitrary choices involved (such as an arbitrary minimum detectable effecs)</p>
<p>Reporting uncertainty intervals or beta distributions (or even bootstrapping) can be a great way to avoid falling for this mistake</p>


</section>

 ]]></description>
  <guid>https://kylejcaron.github.io/posts/2022-04-11-uncertainty_intervals_over_pvals.html</guid>
  <pubDate>Mon, 11 Apr 2022 04:00:00 GMT</pubDate>
  <media:content url="https://kylejcaron.github.io/assets/img/placeholder.png" medium="image" type="image/png" height="95" width="144"/>
</item>
<item>
  <title>Explainable AI is not Causal Inference</title>
  <link>https://kylejcaron.github.io/posts/2022-04-03-explainable-ai-is-not-causal.html</link>
  <description><![CDATA[ 





<p>Explainable AI is all the rage these days. Black box ML models come along with some fun tools such as LIME, SHAP, or Partial Depence Plots that try to give visibility into how the model is interpreting data and making predictions. It’s a common misconception that these are causal inference techniques - sadly we’ve all been mislead.</p>
<p>We’re going to walk through an example that shows these tools fall victim to the same rules of causal inference as everything else. A confound is still a confound, and if you want to measure some causal effect there’s still no way around that without careful deliberation of which variables to include in your models.</p>
<p>The code for this blogpost can be found <a href="https://github.com/kylejcaron/case_studies/blob/master/Explainable%20AI%20vs%20Causal%20Inference.ipynb">here</a></p>
<section id="starting-simple-simulating-some-fake-data" class="level1">
<h1>Starting simple: simulating some fake data</h1>
<p>Let’s start with a simple scenario. Our goal is to estimate some causal effects. We’re going to simulate out data ourself so we know the true causal effects. We can see how good some popular “explainable AI” algorithms actually are at causal inference. We’ll simulate data from the following DAG:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/explainable_ai_dag1.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<hr>
<p><strong>What’s a DAG?</strong> A dag is a directed acyclic graph, or fancy talk for a flowchart that goes in 1 direction. It’s really just a diagram of a true data generating process. <strong>They’re typically assumed based on domain knowledge</strong> (like all models), although ocassionally there are some validation checks you can perform.</p>
<p>Edges in the graph are assumed to be true causal effects. So for example,</p>
<ul>
<li><code>X3</code> influences <code>Y</code></li>
<li><code>X5</code> influences <code>X1</code> which influences <code>Y</code></li>
<li>Some unobserved variable <code>U</code> influences both <code>X1</code> and <code>Y</code>. By unobserved, what I mean is that its some variable we don’t have data for.</li>
</ul>
<p>For those familiar with causal inference, this DAG in particular is also riddled with confounds.</p>
<hr>
<p>Ok back on track. We’ll get out one of the more popular Explainable AI tools nowadays, <code>XGBoost</code>. I’m going to start in the most dangerous way possible - I’m going to toss everything in the model.</p>
</section>
<section id="test-1-whats-the-impact-of-x1-on-y" class="level1">
<h1>Test 1: What’s the impact of X1 on Y?</h1>
<p>We know for a fact that X1 influences Y. Let’s see how well Partial Dependence Plots and SHAP values do at identifying the true causal effect</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/explainable_ai_fig2.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>These SHAP values arent just wrong, but the effect is in the wrong direction. The reason for this: there’s a <strong>Fork Confound.</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/explainable_ai_fig3.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Some variable <code>Z</code> confounds <code>X</code>s true effect on <code>Y</code>.</p>
<blockquote class="blockquote">
<p>A very common example of a fork confound is <code>warm weather (Z)</code> on the relationship between <code>ice cream sales (X)</code> and <code>crime (Y)</code>. Ice cream sales obviously have no influence on crime, but ice cream sales are higher during warmer weather, and crime is higher during warmer weather.</p>
</blockquote>
<p>So back to our main point - Explainable AI can’t get around a fork confound. This is our first lesson on why SHAP / explainable AI is different from causal inference.</p>
<p>Luckily in this case, statistics can solve this problem.</p>
<p>Using some domain knowledge about the generating process, we notice an instrument, <code>X5</code>, that can be used to estimate the causal effect of <code>X1</code> on <code>Y</code></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/explainable_ai_fig4.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>I won’t go into the details of instrumental variable analysis since the goal of this article is to highlight that Explainable AI can’t replace causal inference. To learn more about it, see <a href="https://mixtape.scunning.com/instrumental-variables.html?panelset=python-code&amp;panelset1=python-code2">Scott Cunningham’s Causal Inference the Mixtape</a>.</p>
<p>But for now, I will show that a classic causal inference method succeeds where XGBoost and SHAP values fail</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> linearmodels <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> IV2SLS</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> src.dagtools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> get_effect</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Instrumental variable analysis</span></span>
<span id="cb1-5">iv_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> IV2SLS.from_formula(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y ~ 1 + [X1 ~ X5]"</span>, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df).fit()</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pull true effect</span></span>
<span id="cb1-8">true_effect <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_effect(DAG, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>)</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot</span></span>
<span id="cb1-11">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb1-12">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Instrumental Variable Analysis</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Recovers True effect"</span>)</span>
<span id="cb1-13">plot_model_estimate(iv_model, true_effect<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true_effect, feat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X1"</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax)</span></code></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/explainable_ai_fig5.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>As we can see, a simple statistics technique succeeds where explainable AI fails.</p>
</section>
<section id="what-about-estimating-the-effect-of-x4-on-y" class="level1">
<h1>What about estimating the effect of X4 on Y?</h1>
<p>This relationship is slightly more complicated, but certainly measurable. <code>X4</code> influences <code>X2</code> which influences <code>Y</code>. Here’s the DAG again for reference</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/explainable_ai_dag1.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>The plots below show how well explainable AI does at estimating the causal effect of this relationship.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/explainable_ai_fig6.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Unfortunately, they don’t pick up an effect at all! And if our goal was to increase <code>Y</code> we’d end up missing a pretty good lever for it. There’s another simple explanation here for why explainable AI: there’s a <strong>Pipe Confound</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/explainable_ai_fig7.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>When trying to measure the effect of <code>X -&gt; Y</code>, conditioning on <code>Z</code> (aka including it in a model as a covariate with X) ends up blocking inference.</p>
<p>For more details on how a Pipe confound works, I recommend chapters 5 and 6 of <a href="https://xcelab.net/rm/statistical-rethinking/">Richard McElreath’s Statistical Rethinking v2</a> (where I borrowed the example from as well).</p>
<p>The main things to note here are that pipes are common and Explainable AI doesn’t get around them.</p>
<p>We can recover an unbiased estimate of the true effect simply with OLS</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit simple OLS model</span></span>
<span id="cb2-2">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sm.OLS.from_formula(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y ~ X4"</span>, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df).fit()</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pull true effect</span></span>
<span id="cb2-5">true_effect <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_effect(DAG, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X2"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> get_effect(DAG, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>)</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot (see notebok for plot_model_estimate function)</span></span>
<span id="cb2-8">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb2-9">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Instrumental Variable Analysis</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Recovers True effect"</span>)</span>
<span id="cb2-10">plot_model_estimate(model, true_effect<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true_effect, feat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X4"</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax)</span></code></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/explainable_ai_fig8.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="can-we-use-explainable-ai-for-causal-inference-at-all" class="level1">
<h1>Can we use Explainable AI for causal inference at all?</h1>
<p>We can! We just need to be deliberate in which variables we include in our models, and the only way to do that right is to use DAGs! The example below looks at an XGBoost model that doesnt condition on <code>X2</code> (allowing us to estimate the causal effect of <code>X4 -&gt; Y</code>).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kylejcaron.github.io/assets/img/explainable_ai_fig9.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="take-aways" class="level1">
<h1>Take Aways</h1>
<p>Explainable AI is not some magic tool for causal inference. What these tools are good at is explaining why complicated models make the decisions they do. Explainable AI tools suffer from the same limitations for causal inference as all other statistical estimators.</p>
<p>At the end of the day when causal inference is your goal, nothing beats using DAGs to inform deliberate variable selection.</p>
<p>If you’re new to the subject, I highly recommend the following resources that will teach you how to use causal inference properly:</p>
<ul>
<li>Chapter’s 5 and 6 of Statistical Rethinking v2, by Richard McElreath</li>
<li>Causal Inference for the Brave and True by Matheus Facure</li>
<li>Causal Inference the Mixtape, by Scott Cunningham</li>
</ul>


</section>

 ]]></description>
  <guid>https://kylejcaron.github.io/posts/2022-04-03-explainable-ai-is-not-causal.html</guid>
  <pubDate>Sun, 03 Apr 2022 04:00:00 GMT</pubDate>
  <media:content url="https://kylejcaron.github.io/assets/img/placeholder.png" medium="image" type="image/png" height="95" width="144"/>
</item>
</channel>
</rss>
